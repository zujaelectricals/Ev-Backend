================================================================================
                    EV DISTRIBUTION PLATFORM - API DOCUMENTATION
================================================================================

Base URL: http://localhost:8000/api
Authentication: JWT Bearer Token (except where noted)

================================================================================
                            AUTHENTICATION APIs
================================================================================
Super User: EVAdmin && EVAdmin@123
1. SEND OTP (Regular Users Only)
   Method: POST
   URL: /api/auth/send-otp/
   Authentication: Not Required
   Description: Send OTP to existing user's email or mobile number. Only works for registered users with role='user'. New users must use /api/auth/signup/ endpoint first. Admin/Staff users must use /api/auth/send-admin-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "user@example.com",  // Email or mobile number
     "otp_type": "email"                 // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "message": "OTP sent to user@example.com"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["User not found. Please use /api/auth/signup/ endpoint to register first."]
   }
   OR
   {
     "non_field_errors": ["Admin/Staff users must use /api/auth/send-admin-otp/ endpoint"]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Only works for existing registered users with role='user'
   - New users must register via /api/auth/signup/ endpoint first
   - Admin/Staff users must use /api/auth/send-admin-otp/ endpoint
   
   Rate Limit: 5 requests per minute per IP


2. VERIFY OTP & LOGIN (Regular Users Only)
   Method: POST
   URL: /api/auth/verify-otp/
   Authentication: Not Required
   Description: Verify OTP and login existing user. Returns JWT tokens. Only works for registered users with role='user'. New users must use /api/auth/signup/ and /api/auth/verify-signup-otp/ endpoints first. Admin/Staff users must use /api/auth/verify-admin-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "user@example.com",
     "otp_code": "123456",
     "otp_type": "email"  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "user": {
       "id": 1,
       "username": "user@example.com",
       "email": "user@example.com",
       "mobile": null,
       "role": "user",
       "is_active_buyer": false,
       "is_distributor": false
     },
     "tokens": {
       "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
       "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
     }
   }
   
   Error Response (400):
   {
     "non_field_errors": ["Invalid or expired OTP"]
   }
   OR
   {
     "non_field_errors": ["User not found. Please use /api/auth/signup/ endpoint to register first."]
   }
   OR
   {
     "non_field_errors": ["Admin/Staff users must use /api/auth/verify-admin-otp/ endpoint"]
   }
   
   Notes:
   - Only works for existing registered users with role='user'
   - New users must register via /api/auth/signup/ and /api/auth/verify-signup-otp/ endpoints first
   - Admin/Staff users must use /api/auth/verify-admin-otp/ endpoint
   - No auto-creation of user accounts - users must register first
   
   Rate Limit: 5 requests per minute per IP


2A. SEND ADMIN/STAFF OTP
   Method: POST
   URL: /api/auth/send-admin-otp/
   Authentication: Not Required
   Description: Send OTP to admin/staff user's email or mobile number. Only works for existing admin/staff users (role='admin' or 'staff'). Regular users must use /api/auth/send-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "admin@example.com",  // Email or mobile number
     "otp_type": "email"                  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "message": "OTP sent to admin@example.com"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["User not found or does not have admin/staff privileges"]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Only works for existing admin/staff users (role='admin' or 'staff')
   - Regular users must use /api/auth/send-otp/ endpoint
   - Admin/Staff accounts must be created via /api/auth/create-admin/ or /api/auth/create-staff/ endpoints
   
   Rate Limit: 5 requests per minute per IP


2B. VERIFY ADMIN/STAFF OTP & LOGIN
   Method: POST
   URL: /api/auth/verify-admin-otp/
   Authentication: Not Required
   Description: Verify OTP and login admin/staff user. Returns JWT tokens. Only works for existing admin/staff users (role='admin' or 'staff'). Regular users must use /api/auth/verify-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "admin@example.com",
     "otp_code": "123456",
     "otp_type": "email"  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "user": {
       "id": 2,
       "username": "admin@example.com",
       "email": "admin@example.com",
       "mobile": "9876543211",
       "role": "admin",  // "admin" or "staff"
       "is_active_buyer": false,
       "is_distributor": false
     },
     "tokens": {
       "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
       "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
     }
   }
   
   Error Response (400):
   {
     "non_field_errors": ["Invalid or expired OTP"]
   }
   OR
   {
     "non_field_errors": ["User not found or does not have admin/staff privileges"]
   }
   
   Notes:
   - Only works for existing admin/staff users (role='admin' or 'staff')
   - Regular users must use /api/auth/verify-otp/ endpoint
   - Admin/Staff accounts must be created via /api/auth/create-admin/ or /api/auth/create-staff/ endpoints
   - No auto-creation of user accounts
   
   Rate Limit: 5 requests per minute per IP


2C. SEND UNIVERSAL OTP (All Users)
   Method: POST
   URL: /api/auth/send-universal-otp/
   Authentication: Not Required
   Description: Send OTP to any existing user's email or mobile number. Works for all existing users regardless of role (admin, staff, or user). Only works for existing registered users - new users must use /api/auth/signup/ endpoint first.
   
   Request Body:
   {
     "identifier": "user@example.com",  // Email or mobile number
     "otp_type": "email"                 // "email" or "mobile"
   }
   
   Response (200 OK) - When user has both email and mobile:
   {
     "message": "OTP sent to both email (user@example.com) and mobile (9876543210)",
     "sent_to": ["email", "mobile"]
   }
   
   Response (200 OK) - When user has only one channel:
   {
     "message": "OTP sent to user@example.com"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["User not found. Only existing users can request OTP."]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Works for all existing users (admin, staff, and regular users)
   - Only works for existing registered users - new users must register via /api/auth/signup/ endpoint first
   - If user has both email and mobile: Sends the same OTP code to both channels automatically
   - If user has only one channel: Sends OTP to that channel only
   - The same OTP code works for verification from either email or mobile (if user has both)
   - This endpoint is for OTP verification only - does not log in the user
   - To login after verification, use /api/auth/verify-otp/ or /api/auth/verify-admin-otp/ endpoints
   
   Rate Limit: 5 requests per minute per IP


2D. VERIFY UNIVERSAL OTP (All Users)
   Method: POST
   URL: /api/auth/verify-universal-otp/
   Authentication: Not Required
   Description: Verify OTP for any existing user. Works for all existing users regardless of role (admin, staff, or user). Only verifies the OTP and returns success/failure - does not issue JWT tokens or log in the user. For login functionality, use /api/auth/verify-otp/ or /api/auth/verify-admin-otp/ endpoints.
   
   Request Body:
   {
     "identifier": "user@example.com",
     "otp_code": "123456",
     "otp_type": "email"  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "message": "OTP verified successfully"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["Invalid or expired OTP"]
   }
   OR
   {
     "non_field_errors": ["User not found. Only existing users can verify OTP."]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Works for all existing users (admin, staff, and regular users)
   - Only works for existing registered users - new users must register via /api/auth/signup/ endpoint first
   - If user has both email and mobile: The same OTP code can be verified from either email or mobile channel
   - If user has only one channel: OTP must be verified from that specific channel
   - Only verifies the OTP - does NOT issue JWT tokens or log in the user
   - For login functionality, use /api/auth/verify-otp/ (regular users) or /api/auth/verify-admin-otp/ (admin/staff) endpoints
   - This endpoint is useful for OTP verification scenarios where login is not required (e.g., password reset, email verification, etc.)
   - No auto-creation of user accounts - users must register first
   
   Rate Limit: 5 requests per minute per IP


3. REFRESH TOKEN
   Method: POST
   URL: /api/auth/refresh/
   Authentication: Not Required (but needs refresh token)
   Description: Get new access token using refresh token
   
   Request Body:
   {
     "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }
   
   Response (200 OK):
   {
     "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }


4. LOGOUT
   Method: POST
   URL: /api/auth/logout/
   Authentication: Required
   Description: Logout user and blacklist refresh token
   
   Request Body:
   {
     "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }
   
   Response (200 OK):
   {
     "message": "Successfully logged out"
   }


5. USER SIGNUP
   Method: POST
   URL: /api/auth/signup/
   Authentication: Not Required
   Description: Submit signup form with user details. Sends OTP to both email and mobile.
   
   Request Body:
   {
     "first_name": "John",
     "last_name": "Doe",
     "email": "john@example.com",
     "mobile": "9876543210",
     "gender": "male",                    // "male", "female", "other"
     "date_of_birth": "1990-01-01",
     "address_line1": "123 Main Street",
     "address_line2": "Apt 4B",          // Optional
     "city": "Mumbai",
     "state": "Maharashtra",
     "pincode": "400001",
     "country": "India",                 // Optional, defaults to "India"
     "referral_code": "REF12345"         // Optional
   }
   
   Response (200 OK):
   {
     "message": "OTP sent to email and mobile",
     "signup_token": "ABC123XYZ789..."
   }
   
   Error Response (400):
   {
     "email": ["Email already registered"],
     "mobile": ["Mobile number already registered"],
     "mobile": ["Invalid mobile number format"]
   }
   
   Rate Limit: 5 requests per minute per IP


6. VERIFY SIGNUP OTP
   Method: POST
   URL: /api/auth/verify-signup-otp/
   Authentication: Not Required
   Description: Verify OTP and create user account. The same OTP code is sent to both email and mobile, so use the same code for verification. This will create the user account with all profile fields from the signup form.
   
   Request Body:
   {
     "signup_token": "ABC123XYZ789...",    // Token received from /auth/signup/ endpoint
     "otp_code": "123456"                  // OTP code received via email or mobile (same code for both)
   }
   
   Response (201 Created):
   {
     "user": {
       "id": 1,
       "username": "john@example.com",
       "email": "john@example.com",
       "mobile": "9876543210",
       "first_name": "John",
       "last_name": "Doe",
       "role": "user",
       "is_active_buyer": false,
       "is_distributor": false
     },
     "tokens": {
       "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
       "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
     }
   }
   
   Error Response (400):
   {
     "signup_token": ["Invalid or expired signup token"],
     "otp_code": ["Invalid or expired OTP"]
   }
   
   Notes:
   - The signup_token expires after 15 minutes
   - If user already exists (e.g., logged in via OTP login), the profile will be updated with signup data
   - The same OTP code works for both email and mobile verification
   
   Rate Limit: 5 requests per minute per IP


7. CREATE ADMIN (Superuser Only)
   Method: POST
   URL: /api/auth/create-admin/
   Authentication: Required (Superuser)
   Description: Create admin user. Only superusers can create admins.
   
   Request Body:
   {
     "first_name": "Admin",
     "last_name": "User",
     "email": "admin@example.com",
     "mobile": "9876543211",
     "gender": "male",
     "date_of_birth": "1985-01-01",
     "address_line1": "456 Admin Street",
     "address_line2": "",                // Optional
     "city": "Delhi",
     "state": "Delhi",
     "pincode": "110001",
     "country": "India"                  // Optional
   }
   
   Response (201 Created):
   {
     "user": {
       "id": 2,
       "username": "admin@example.com",
       "email": "admin@example.com",
       "mobile": "9876543211",
       "first_name": "Admin",
       "last_name": "User",
       "role": "admin"
     },
     "message": "Admin created successfully. OTP sent to email and mobile for initial login."
   }
   
   Error Response (400):
   {
     "email": ["Email already registered"],
     "mobile": ["Mobile number already registered"]
   }
   
   Error Response (403):
   {
     "detail": "You do not have permission to perform this action."
   }


8. CREATE STAFF (Admin or Superuser)
   Method: POST
   URL: /api/auth/create-staff/
   Authentication: Required (Admin or Superuser)
   Description: Create staff user. Both admins and superusers can create staff.
   
   Request Body:
   {
     "first_name": "Staff",
     "last_name": "User",
     "email": "staff@example.com",
     "mobile": "9876543212",
     "gender": "female",
     "date_of_birth": "1990-05-15",
     "address_line1": "789 Staff Avenue",
     "address_line2": "",                // Optional
     "city": "Bangalore",
     "state": "Karnataka",
     "pincode": "560001",
     "country": "India"                  // Optional
   }
   
   Response (201 Created):
   {
     "user": {
       "id": 3,
       "username": "staff@example.com",
       "email": "staff@example.com",
       "mobile": "9876543212",
       "first_name": "Staff",
       "last_name": "User",
       "role": "staff"
     },
     "message": "Staff created successfully. OTP sent to email and mobile for initial login."
   }
   
   Error Response (400):
   {
     "email": ["Email already registered"],
     "mobile": ["Mobile number already registered"]
   }
   
   Error Response (403):
   {
     "detail": "You do not have permission to perform this action."
   }


================================================================================
                              USER APIs
================================================================================

9. GET USER PROFILE
   Method: GET
   URL: /api/users/profile/
   Authentication: Required
   Description: Get current user's profile information
   
   Response (200 OK):
   {
     "id": 1,
     "username": "user@example.com",
     "email": "user@example.com",
     "mobile": "+919876543210",
     "first_name": "John",
     "last_name": "Doe",
     "gender": "male",
     "date_of_birth": "1990-01-01",
     "address_line1": "123 Main Street",
     "address_line2": "Apt 4B",
     "city": "Mumbai",
     "state": "Maharashtra",
     "pincode": "400001",
     "country": "India",
     "role": "user",
     "is_distributor": false,
     "is_active_buyer": true,
     "referral_code": "REF00001",
     "referred_by": null,
     "kyc_status": "approved",
     "nominee_exists": true,
     "is_distributor_terms_and_conditions_accepted": true,
     "date_joined": "2026-01-06T12:00:00Z"
   }


10. UPDATE USER PROFILE
    Method: PUT / PATCH
    URL: /api/users/update_profile/  (for own profile)
         /api/users/{id}/            (for any profile - with permissions)
    Authentication: Required
    Description: Update user profile with hierarchical permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can edit any profile (admin, staff, and normal users)
    - Staff: Can edit their own profile and normal users' profiles (cannot edit admin/staff profiles)
    - Normal Users: Can only edit their own profile
    
    Request Body (PATCH - partial update):
    {
      "first_name": "John",
      "last_name": "Doe",
      "mobile": "+919876543210",
      "gender": "male",
      "date_of_birth": "1990-01-01",
      "address_line1": "123 Main Street",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001"
    }
    
    Response (200 OK):
    {
      "id": 1,
      "username": "user@example.com",
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "gender": "male",
      "date_of_birth": "1990-01-01",
      ...
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Staff can only edit their own profile or normal users' profiles."
    }
    OR
    {
      "detail": "You can only update your own profile."
    }
    
    Examples:
    - Admin editing admin profile: ✓ Allowed
    - Admin editing staff profile: ✓ Allowed
    - Admin editing normal user profile: ✓ Allowed
    - Staff editing own profile: ✓ Allowed
    - Staff editing normal user profile: ✓ Allowed
    - Staff editing admin profile: ✗ Forbidden (403)
    - Staff editing other staff profile: ✗ Forbidden (403)
    - Normal user editing own profile: ✓ Allowed
    - Normal user editing any other profile: ✗ Forbidden (403)


11. LIST USERS
   Method: GET
   URL: /api/users/
   Authentication: Required
   Description: List users based on role:
   - Admin/Superuser: Can see all users
   - Staff: Can see all users (to manage normal users)
   - Normal Users: Can only see their own profile
   
   Query Parameters:
   - page: Page number (default: 1)
   - page_size: Items per page (default: 20)
   
   Response (200 OK):
   {
     "count": 100,
     "next": "http://localhost:8000/api/users/?page=2",
     "previous": null,
     "results": [
       {
         "id": 1,
         "username": "user@example.com",
         "email": "user@example.com",
         "role": "user",
         "is_active_buyer": true,
         ...
       }
     ]
   }


12. GET USER BY ID
    Method: GET
    URL: /api/users/{id}/
    Authentication: Required
    Description: Get specific user details. Access based on role:
    - Admin/Superuser: Can view any user
    - Staff: Can view any user (to manage normal users)
    - Normal Users: Can only view their own profile
    
    Response (200 OK):
    {
      "id": 1,
      "username": "user@example.com",
      "email": "user@example.com",
      "mobile": "+919876543210",
      "first_name": "John",
      "last_name": "Doe",
      "gender": "male",
      "date_of_birth": "1990-01-01",
      "address_line1": "123 Main Street",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001",
      "country": "India",
      ...
    }


13. LIST ADMIN USERS
    Method: GET
    URL: /api/users/admins/
    Authentication: Required (Superuser only)
    Description: List all admin users. Only superuser can access this endpoint.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    
    Response (200 OK):
    {
      "count": 5,
      "next": null,
      "previous": null,
      "results": [
        {
          "id": 1,
          "username": "admin@example.com",
          "email": "admin@example.com",
          "mobile": "+919876543210",
          "role": "admin",
          "first_name": "Admin",
          "last_name": "User",
          ...
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Only superuser can list admin users."
    }


14. LIST STAFF USERS
    Method: GET
    URL: /api/users/staff/
    Authentication: Required (Superuser or Admin)
    Description: List all staff users. Superuser and admin can access this endpoint.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    
    Response (200 OK):
    {
      "count": 10,
      "next": null,
      "previous": null,
      "results": [
        {
          "id": 2,
          "username": "staff@example.com",
          "email": "staff@example.com",
          "mobile": "+919876543211",
          "role": "staff",
          "first_name": "Staff",
          "last_name": "User",
          ...
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Only superuser and admin can list staff users."
    }


15. LIST NORMAL USERS
    Method: GET
    URL: /api/users/normal/
    Authentication: Required (Superuser, Admin, or Staff)
    Description: List all normal users. Superuser, admin, and staff can access this endpoint.
    Supports filtering by is_distributor, date_joined, search (name), and ordering.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    - is_distributor: Filter by distributor status (true/false)
      - is_distributor=true: Return only distributors
      - is_distributor=false: Return only non-distributors
      - If not provided: Return all normal users
    - date_joined_from: Filter users joined on or after this date (format: YYYY-MM-DD)
      Example: date_joined_from=2024-01-01
    - date_joined_to: Filter users joined on or before this date (format: YYYY-MM-DD)
      Example: date_joined_to=2024-12-31
    - search: Search users by name (case-insensitive partial match)
      Searches across: first_name, last_name, username, and email fields
      Example: search=john (matches "John", "john@example.com", "john_doe", etc.)
    - ordering: Order results by field (default: id)
      Allowed values: id, -id, date_joined, -date_joined, username, -username, email, -email, first_name, -first_name, last_name, -last_name
      Example: ordering=-date_joined (newest first)
    
    Examples:
    - Get all distributors: /api/users/normal/?is_distributor=true
    - Get non-distributors: /api/users/normal/?is_distributor=false
    - Get users joined in 2024: /api/users/normal/?date_joined_from=2024-01-01&date_joined_to=2024-12-31
    - Get distributors joined after 2024-01-01: /api/users/normal/?is_distributor=true&date_joined_from=2024-01-01
    - Search for users by name: /api/users/normal/?search=john
    - Search distributors by name: /api/users/normal/?is_distributor=true&search=john
    - Get users ordered by join date (newest first): /api/users/normal/?ordering=-date_joined
    
    Response (200 OK):
    {
      "count": 100,
      "next": "http://localhost:8000/api/users/normal/?page=2",
      "previous": null,
      "results": [
        {
          "id": 3,
          "username": "user@example.com",
          "email": "user@example.com",
          "mobile": "+919876543212",
          "role": "user",
          "first_name": "John",
          "last_name": "Doe",
          "is_active_buyer": true,
          "is_distributor": false,
          "date_joined": "2024-01-15T10:30:00Z",
          ...
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Only superuser, admin, and staff can list normal users."
    }


================================================================================
                              KYC APIs
================================================================================

16. CREATE KYC
   Method: POST
   URL: /api/users/kyc/
   Authentication: Required
   Description: Submit KYC documents
   
   Request Body (multipart/form-data):
   {
     "pan_number": "ABCDE1234F",
     "aadhaar_number": "123456789012",
     "address_line1": "123 Main Street",
     
     "address_line2": "Apt 4B",
     "city": "Mumbai",
     "state": "Maharashtra",
     "pincode": "400001",
     "country": "India",
     "pan_document": <file>,
     "aadhaar_front": <file>,
     "aadhaar_back": <file>,
     "bank_name": "State Bank of India",
     "account_number": "1234567890",
     "ifsc_code": "SBIN0001234",
     "account_holder_name": "John Doe",
     "bank_passbook": <file>  // Bank account passbook document
   }
   
   Response (201 Created):
   {
     "id": 1,
     "user": 1,
     "status": "pending",
     "pan_number": "ABCDE1234F",
     ...
   }


17. GET KYC STATUS
    Method: GET
    URL: /api/users/kyc/
    Authentication: Required
    Description: Get KYC status with hierarchical permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can view all KYC records (admin, staff, and normal users)
    - Staff: Can view their own KYC and normal users' KYC (cannot view admin/staff KYC)
    - Normal Users: Can only view their own KYC record
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "status": "approved",  // "pending", "approved", "rejected"
      "pan_number": "ABCDE1234F",
      "submitted_at": "2026-01-06T12:00:00Z",
      "reviewed_at": "2026-01-06T13:00:00Z",
      ...
    }
    
    Examples:
    - Admin viewing admin KYC: ✓ Allowed
    - Admin viewing staff KYC: ✓ Allowed
    - Admin viewing normal user KYC: ✓ Allowed
    - Staff viewing own KYC: ✓ Allowed
    - Staff viewing normal user KYC: ✓ Allowed
    - Staff viewing admin KYC: ✗ Not returned in queryset
    - Staff viewing other staff KYC: ✗ Not returned in queryset
    - Normal user viewing own KYC: ✓ Allowed
    - Normal user viewing any other KYC: ✗ Not returned in queryset


18. GET KYC BY ID
    Method: GET
    URL: /api/users/kyc/{id}/
    Authentication: Required
    Description: Get specific KYC record by ID. Access based on hierarchical permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can view any KYC record by ID (admin, staff, and normal users)
    - Staff: Can view their own KYC by ID and normal users' KYC by ID (cannot view admin/staff KYC by ID)
    - Normal Users: Can only view their own KYC record by ID
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "status": "approved",  // "pending", "approved", "rejected"
      "pan_number": "ABCDE1234F",
      "aadhaar_number": "123456789012",
      "address_line1": "123 Main Street",
      "address_line2": "Apt 4B",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001",
      "country": "India",
      "pan_document": "http://localhost:8000/media/kyc/pan/pan_123.jpg",
      "aadhaar_front": "http://localhost:8000/media/kyc/aadhaar/aadhaar_front_123.jpg",
      "aadhaar_back": "http://localhost:8000/media/kyc/aadhaar/aadhaar_back_123.jpg",
      "bank_name": "State Bank of India",
      "account_number": "1234567890",
      "ifsc_code": "SBIN0001234",
      "account_holder_name": "John Doe",
      "bank_passbook": "http://localhost:8000/media/kyc/bank_passbook/passbook_123.jpg",
      "submitted_at": "2026-01-06T12:00:00Z",
      "reviewed_at": "2026-01-06T13:00:00Z",
      "reviewed_by": 2,
      "rejection_reason": ""
    }
    
    Error Response (404 Not Found):
    {
      "detail": "Not found."
    }
    
    Note: Returns 404 if the KYC record doesn't exist or if the user doesn't have permission to view it based on hierarchical permissions.
    
    Examples:
    - Admin accessing admin KYC by ID: ✓ Allowed
    - Admin accessing staff KYC by ID: ✓ Allowed (e.g., GET /api/users/kyc/5/)
    - Admin accessing normal user KYC by ID: ✓ Allowed
    - Staff accessing own KYC by ID: ✓ Allowed
    - Staff accessing normal user KYC by ID: ✓ Allowed
    - Staff accessing admin KYC by ID: ✗ 404 Not Found
    - Staff accessing other staff KYC by ID: ✗ 404 Not Found
    - Normal user accessing own KYC by ID: ✓ Allowed
    - Normal user accessing any other KYC by ID: ✗ 404 Not Found


19. UPDATE KYC STATUS (Admin Only)
    Method: POST
    URL: /api/users/kyc/{id}/update-status/
    Authentication: Required (Admin)
    Description: Update KYC status - approve or reject KYC submission
    
    Request Body:
    {
      "status": "approved"  // or "rejected"
      "reason": "PAN document is not clear"  // Optional, only required/used when status is "rejected"
    }
    
    Response (200 OK):
    {
      "status": "approved"  // or "rejected"
    }
    
    Error Response (400):
    {
      "error": "Invalid status. Must be 'approved' or 'rejected'"
    }
    or
    {
      "error": "KYC is already approved"  // or "KYC is already rejected"
    }


21. LIST ALL KYC DOCUMENTS (Admin Only)
    Method: GET
    URL: /api/users/kyc/list_all/
    Authentication: Required (Admin)
    Description: List all KYC documents with filtering and pagination. Admin/Superuser only.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20, max: 100)
    - status: Filter by KYC status (pending, approved, rejected)
    - submitted_date_from: Filter by submission date start (YYYY-MM-DD)
    - submitted_date_to: Filter by submission date end (YYYY-MM-DD)
    - reviewed_date_from: Filter by review date start (YYYY-MM-DD)
    - reviewed_date_to: Filter by review date end (YYYY-MM-DD)
    - user_id: Filter by specific user ID
    - user_role: Filter by user role (admin, staff, user)
    - ordering: Sort results (default: -submitted_at)
      Options: submitted_at, -submitted_at, reviewed_at, -reviewed_at, status, -status
    
    Example Requests:
    GET /api/users/kyc/list_all/
    GET /api/users/kyc/list_all/?status=pending
    GET /api/users/kyc/list_all/?submitted_date_from=2026-01-01&submitted_date_to=2026-01-31
    GET /api/users/kyc/list_all/?user_role=user&status=approved
    GET /api/users/kyc/list_all/?user_id=5&ordering=-submitted_at
    GET /api/users/kyc/list_all/?reviewed_date_from=2026-01-01&reviewed_date_to=2026-01-31&status=approved
    
    Response (200 OK):
    {
      "count": 150,
      "next": "http://localhost:8000/api/users/kyc/list_all/?page=2",
      "previous": null,
      "results": [
        {
          "id": 1,
          "user": 1,
          "status": "approved",
          "pan_number": "ABCDE1234F",
          "aadhaar_number": "123456789012",
          "address_line1": "123 Main Street",
          "address_line2": "Apt 4B",
          "city": "Mumbai",
          "state": "Maharashtra",
          "pincode": "400001",
          "country": "India",
          "pan_document": "http://localhost:8000/media/kyc/pan/pan_123.jpg",
          "aadhaar_front": "http://localhost:8000/media/kyc/aadhaar/aadhaar_front_123.jpg",
          "aadhaar_back": "http://localhost:8000/media/kyc/aadhaar/aadhaar_back_123.jpg",
          "bank_name": "State Bank of India",
          "account_number": "1234567890",
          "ifsc_code": "SBIN0001234",
          "account_holder_name": "John Doe",
          "bank_passbook": "http://localhost:8000/media/kyc/bank_passbook/passbook_123.jpg",
          "submitted_at": "2026-01-06T12:00:00Z",
          "reviewed_at": "2026-01-06T13:00:00Z",
          "reviewed_by": 2,
          "rejection_reason": ""
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Only Admin/Superuser can access this endpoint
    - All filters can be combined
    - Date filters use inclusive ranges (>= for from, <= for to)
    - Default ordering is by submission date (newest first)
    - Invalid filter values are ignored (e.g., invalid user_id)


================================================================================
                    DISTRIBUTOR APPLICATION APIs
================================================================================

74. CREATE DISTRIBUTOR APPLICATION
    Method: POST
    URL: /api/users/distributor-application/
    Authentication: Required
    Description: Submit distributor application form. Application is automatically approved upon creation, and user becomes a distributor immediately. User must have approved KYC to apply.
    
    Eligibility Requirements:
    - User must have approved KYC (kyc.status = 'approved')
    - User can only submit one application
    - Note: Active Buyer requirement removed - only KYC verification needed
    
    Automatic Approval:
    - Application is automatically approved upon successful creation (status = 'approved')
    - User.is_distributor is automatically set to True
    - No admin/staff approval required
    - User can immediately start earning from binary pairs and referrals
    
    Request Body (multipart/form-data):
    {
      "company_name": "ABC Distributors Pvt Ltd",  // Optional
      "business_registration_number": "REG123456",  // Optional
      "tax_id": "TAX789012",                        // Optional
      "years_in_business": 5,                       // Optional
      "previous_distribution_experience": "5 years of experience in EV distribution",  // Optional
      "product_interest": "Electric vehicles and accessories",  // Optional
      "reference_name": "John Smith",                // Optional
      "reference_contact": "+919876543210",          // Optional
      "reference_relationship": "Business Partner",  // Optional
      "is_distributor_terms_and_conditions_accepted": true,  // Required - Must be true
      "business_license": <file>,                     // Optional - Business license document
      "tax_documents": <file>                         // Optional - Tax documents
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "approved",  // Automatically approved upon creation
      "company_name": "ABC Distributors Pvt Ltd",
      "business_registration_number": "REG123456",
      "tax_id": "TAX789012",
      "years_in_business": 5,
      "previous_distribution_experience": "5 years of experience in EV distribution",
      "product_interest": "Electric vehicles and accessories",
      "reference_name": "John Smith",
      "reference_contact": "+919876543210",
      "reference_relationship": "Business Partner",
      "is_distributor_terms_and_conditions_accepted": true,
      "business_license": "http://localhost:8000/media/distributor/business_license/license_1.pdf",
      "tax_documents": "http://localhost:8000/media/distributor/tax_documents/tax_1.pdf",
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": "2026-01-14T10:00:00Z",  // Set automatically upon creation
      "reviewed_by": null,  // No reviewer since auto-approved
      "rejection_reason": ""
    }
    
    Notes:
    - Application is automatically approved upon creation
    - User.is_distributor is automatically set to True
    - User can immediately start earning from binary pairs and referrals
    - No admin/staff approval required
    
    Error Response (400 Bad Request):
    {
      "non_field_errors": [
        "User must have approved KYC to apply for distributor program."
      ]
    }
    OR
    {
      "non_field_errors": [
        "Application already exists. You can only submit one distributor application."
      ]
    }
    OR
    {
      "is_distributor_terms_and_conditions_accepted": [
        "You cannot Proceed without Accepting Terms and Conditions"
      ]
    }


75. GET DISTRIBUTOR APPLICATION STATUS
    Method: GET
    URL: /api/users/distributor-application/
    Authentication: Required
    Description: Get current user's distributor application status
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "approved",  // "approved" (auto-approved) or "rejected" (if admin rejected)
      "company_name": "ABC Distributors Pvt Ltd",
      "is_distributor_terms_and_conditions_accepted": true,
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": "2026-01-14T10:00:00Z",  // Set automatically upon creation
      "reviewed_by": null,  // null for auto-approved applications
      "rejection_reason": ""
    }
    
    Response (404 Not Found) - If no application exists:
    {
      "detail": "Not found."
    }


76. GET DISTRIBUTOR APPLICATION BY ID
    Method: GET
    URL: /api/users/distributor-application/{id}/
    Authentication: Required
    Description: Get specific distributor application by ID. Access based on permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can view any application
    - Staff: Can view any application
    - Normal Users: Can only view their own application
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "approved",
      "company_name": "ABC Distributors Pvt Ltd",
      "business_registration_number": "REG123456",
      "tax_id": "TAX789012",
      "years_in_business": 5,
      "previous_distribution_experience": "5 years of experience in EV distribution",
      "product_interest": "Electric vehicles and accessories",
      "reference_name": "John Smith",
      "reference_contact": "+919876543210",
      "reference_relationship": "Business Partner",
      "is_distributor_terms_and_conditions_accepted": true,
      "business_license": "http://localhost:8000/media/distributor/business_license/license_1.pdf",
      "tax_documents": "http://localhost:8000/media/distributor/tax_documents/tax_1.pdf",
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": "2026-01-14T11:00:00Z",
      "reviewed_by": 2,
      "rejection_reason": ""
    }
    
    Error Response (404 Not Found):
    {
      "detail": "Not found."
    }


77. UPDATE DISTRIBUTOR APPLICATION STATUS (Admin/Staff Only)
    Method: POST
    URL: /api/users/distributor-application/{id}/update-status/
    Authentication: Required (Admin, Staff, or Superuser)
    Description: Reject or re-approve distributor application. Applications are automatically approved upon creation, but admin/staff can reject them if needed. Setting status to 'approved' sets user.is_distributor = True. Setting status to 'rejected' sets user.is_distributor = False.
    
    Permission Requirements:
    - Superuser (is_superuser=True)
    - Admin users (role='admin' with is_staff=True)
    - Staff users (role='staff' with is_staff=True)
    
    Request Body:
    {
      "status": "approved"  // Required: "approved" or "rejected"
      "reason": "Insufficient business experience"  // Optional, only used when status is "rejected"
    }
    
    Example Request (Re-approve):
    POST /api/users/distributor-application/1/update-status/
    {
      "status": "approved"
    }
    Note: Applications are automatically approved upon creation. This endpoint is mainly for re-approving previously rejected applications.
    
    Example Request (Reject):
    POST /api/users/distributor-application/1/update-status/
    {
      "status": "rejected",
      "reason": "Insufficient business experience"
    }
    Note: Rejecting an application will set user.is_distributor = False, removing distributor privileges.
    
    Response (200 OK) - When Approved:
    {
      "status": "approved",
      "message": "Application approved. User user@example.com is now a distributor."
    }
    
    Response (200 OK) - When Rejected:
    {
      "status": "rejected",
      "message": "Application rejected."
    }
    
    Error Response (400 Bad Request):
    {
      "error": "Application is already approved"  // or "Application is already rejected"
    }
    
    Error Response (400 Bad Request):
    {
      "error": "Invalid status. Must be 'approved' or 'rejected'"
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Applications are automatically approved upon creation (via CREATE endpoint)
    - This endpoint is primarily for rejecting applications or re-approving previously rejected ones
    - Upon approval (or re-approval), user.is_distributor is automatically set to True
    - Upon rejection, user.is_distributor is automatically set to False
    - User can earn from binary pairs and referrals only when is_distributor = True
    - Only one application per user is allowed
    - Normal users cannot update application status
    - Reason field is optional and only used when status is "rejected"


78. LIST ALL DISTRIBUTOR APPLICATIONS (Admin/Staff Only)
    Method: GET
    URL: /api/users/distributor-application/list_all/
    Authentication: Required (Admin, Staff, or Superuser)
    Description: List all distributor applications with filtering and pagination. Admin/Staff/Superuser only.
    
    Permission Requirements:
    - Superuser (is_superuser=True)
    - Admin users (role='admin' with is_staff=True)
    - Staff users (role='staff' with is_staff=True)
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20, max: 100)
    - status: Filter by status (pending, approved, rejected)
    - submitted_date_from: Filter by submission date start (YYYY-MM-DD)
    - submitted_date_to: Filter by submission date end (YYYY-MM-DD)
    - reviewed_date_from: Filter by review date start (YYYY-MM-DD)
    - reviewed_date_to: Filter by review date end (YYYY-MM-DD)
    - user_id: Filter by specific user ID
    - ordering: Sort results (default: -submitted_at)
      Options: submitted_at, -submitted_at, reviewed_at, -reviewed_at, status, -status
    
    Example Requests:
    GET /api/users/distributor-application/list_all/
    GET /api/users/distributor-application/list_all/?status=pending
    GET /api/users/distributor-application/list_all/?submitted_date_from=2026-01-01&submitted_date_to=2026-01-31
    GET /api/users/distributor-application/list_all/?user_id=5&ordering=-submitted_at
    GET /api/users/distributor-application/list_all/?reviewed_date_from=2026-01-01&reviewed_date_to=2026-01-31&status=approved
    
    Response (200 OK):
    {
      "count": 50,
      "next": "http://localhost:8000/api/users/distributor-application/list_all/?page=2",
      "previous": null,
      "results": [
        {
          "id": 1,
          "user": 1,
          "user_email": "user@example.com",
          "user_username": "user@example.com",
          "user_full_name": "John Doe",
          "status": "pending",
          "company_name": "ABC Distributors Pvt Ltd",
          "business_registration_number": "REG123456",
          "tax_id": "TAX789012",
          "years_in_business": 5,
          "submitted_at": "2026-01-14T10:00:00Z",
          "reviewed_at": null,
          "reviewed_by": null,
          "rejection_reason": ""
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Only Admin/Staff/Superuser can access this endpoint
    - Normal users cannot access this endpoint
    - All filters can be combined
    - Date filters use inclusive ranges (>= for from, <= for to)
    - Default ordering is by submission date (newest first)
    - Invalid filter values are ignored (e.g., invalid user_id)


================================================================================
                            NOMINEE APIs
================================================================================

22. CREATE/UPDATE NOMINEE
    Method: POST / PUT / PATCH
    URL: /api/users/nominee/
    Authentication: Required
    Description: Create or update nominee information
    
    Request Body:
    {
      "full_name": "Jane Doe",
      "relationship": "spouse",  // "spouse", "son", "daughter", "father", "mother", "brother", "sister", "other"
      "date_of_birth": "1990-01-01",
      "mobile": "+919876543211",
      "email": "jane@example.com",
      "address_line1": "123 Main Street",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001",
      "id_proof_type": "Aadhaar",
      "id_proof_number": "987654321098",
      "id_proof_document": <file>,
      "kyc_status": "pending"  // Read-only: pending/verified/rejected (set to pending when id proof submitted)
    }
    
    Response (201 Created / 200 OK):
    {
      "id": 1,
      "user": 1,
      "full_name": "Jane Doe",
      "relationship": "spouse",
      "id_proof_type": "Aadhaar",
      "id_proof_number": "987654321098",
      "id_proof_document": "http://localhost:8000/media/nominee/id_proof/id_1.jpg",
      "kyc_status": "pending",
      "kyc_submitted_at": "2026-01-07T12:00:00Z",
      ...
    }


23. GET NOMINEE
    Method: GET
    URL: /api/users/nominee/
    Authentication: Required
    Description: Get user's nominee information
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "full_name": "Jane Doe",
      "relationship": "spouse",
      "kyc_status": "pending",
      "kyc_submitted_at": "2026-01-07T12:00:00Z",
      "kyc_verified_at": null,
      "kyc_verified_by": null,
      "kyc_rejection_reason": "",
      ...
    }


24. UPDATE NOMINEE KYC STATUS (Admin Only)
    Method: POST
    URL: /api/users/nominee/{id}/update-kyc-status/
    Authentication: Required (Admin)
    Description: Update nominee KYC status - verify or reject nominee KYC submissions. This endpoint is restricted to admin/superuser.
    
    Request Body:
    {
      "status": "verified"  // or "rejected"
      "reason": "ID document is blurred"  // Optional, only required/used when status is "rejected"
    }
    
    Response (200 OK):
    {
      "status": "verified"  // or "rejected"
    }
    
    Error Response (400):
    {
      "error": "Invalid status. Must be 'verified' or 'rejected'"
    }
    or
    {
      "error": "Nominee KYC is already verified"  // or "Nominee KYC is already rejected"
    }

    Notes:
    - Business logic in booking/payouts should only consider nominees with `kyc_status == 'verified'` as verified nominees.
    - Admin actions set `kyc_verified_by` and timestamps.


================================================================================
                            BOOKING APIs
================================================================================

24. CREATE BOOKING
    Method: POST
    URL: /api/booking/bookings/
    Authentication: Required
    Description: Create a new EV booking (minimum ₹500)
    
    Request Body:
    {
      "vehicle_model_code": "EV-RED-40K-A9F3X2",  // Vehicle model code (string) - Required - Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_color": "Red",            // Required - must match the color in the vehicle's model_code
      "battery_variant": "40kWh",         // Required - must match the battery variant in the vehicle's model_code
      "booking_amount": 500,              // Minimum ₹500
      "total_amount": 50000,              // Required - must match vehicle price
      "payment_option": "full_payment",   // "full_payment" or "emi_options"
      "delivery_city": "Mumbai",          // Required
      "delivery_state": "Maharashtra",    // Required
      "delivery_pin": "400001",           // Required
      "terms_accepted": true,             // Required
      "referral_code": "ABC12345",        // Optional - Referral code of referring user
      "manual_placement": false,           // Optional - If true, skip automatic binary tree placement (default: false)
      "join_distributor_program": false,  // Optional
      "payment_gateway_ref": "TXN123",    // Optional
      "emi_amount": 5000,                 // Optional
      "emi_duration_months": 10,          // Optional
      "emi_start_date": "2026-02-01"      // Optional
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "booking_number": "EVABC1234",
      "vehicle_model": 1,
      "model_code": "EV-RED-40K-A9F3X2",          // Vehicle model code (read-only) - Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_details": {
        "id": 1,
        "name": "EV Model X",
        "model_code": "EV-RED-40K-A9F3X2",
        "vehicle_color": ["red"],  // Single color per vehicle
        "battery_variant": ["40kWh"],  // Single battery variant per vehicle
        "price": "50000.00"
      },
      "vehicle_color": "Red",
      "battery_variant": "40kWh",
      "booking_amount": "500.00",
      "total_amount": "50000.00",
      "total_paid": "0.00",
      "remaining_amount": "50000.00",
      "status": "pending",  // "pending", "active", "completed", "cancelled", "expired"
      "referred_by": 5,     // User ID of referrer (if referral_code was used)
      "delivery_city": "Mumbai",
      "delivery_state": "Maharashtra",
      "delivery_pin": "400001",
      "terms_accepted": true,
      "expires_at": "2026-02-05T12:00:00Z",
      "reservation_status": "reserved",  // "reserved", "released", "completed" - Stock reservation status
      "reservation_expires_at": "2026-01-07T12:00:00Z",  // When reservation expires (null = never expires)
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Note on Stock Reservation:
    - When booking is created, a stock reservation is automatically created
    - Vehicle stock (available_quantity) is reduced by 1
    - Reservation expires based on BOOKING_RESERVATION_TIMEOUT_HOURS setting (null = never expires)
    - If reservation expires and payment is not completed, stock is automatically released
    - Reservation is completed when first payment is confirmed (status='completed')
    
    Note on Referral Code:
    - If referral_code is provided, the system validates it and sets referred_by automatically
    - User cannot use their own referral code (self-referral prevention)
    - If user.referred_by is not set, it will be set from the referral_code
    - The system stores whether the referrer was a distributor when the booking was created (referrer_was_distributor field)
    - Commission is granted to the referrer after successful payment capture ONLY if referrer_was_distributor is True
      * Commission = payment_amount × REFERRAL_COMMISSION_PERCENTAGE / 100
      * Commission is granted on every successful payment for the booking
      * No retroactive commissions: Only bookings created AFTER the referrer becomes a distributor get commission
    
    Note on Binary Tree Placement:
    - Users are NOT automatically placed in the binary tree when booking is created
    - IMPORTANT: Placement APIs can ONLY be called AFTER user has at least one successful payment
    - Referrer must place users AFTER payment completion, either:
      1. Automatically via /api/binary/nodes/auto_place_pending/ (uses left-priority algorithm)
      2. Manually via /api/binary/nodes/place_user/ (choose specific position)
    - Placement Rules (when using auto_place_pending):
      1. First 2 direct referrals: 1st user → LEFT, 2nd user → RIGHT
      2. From 3rd referral onward: Follow LEFT-side chain (traverse left children to find left-most available position)
      3. Referral-based override: If user joins using a specific parent's referral code (e.g., User B's code):
         - Place in that parent's tree (not root)
         - Check parent's LEFT first, then RIGHT if left is occupied
      4. Default placement side is configurable via Platform Settings (binary_tree_default_placement_side)
         - If set to RIGHT: Same logic applies in mirror form (right-chain pattern)
    - Referrer can view pending users via /api/binary/nodes/pending_users/
    - Parents can choose left/right for their direct referrals via /api/binary/nodes/choose_side_for_direct_referral/
    - Parents can swap or move their direct children via /api/binary/nodes/swap_direct_children/ and /api/binary/nodes/move_user/
    
    Note on Direct User Commission:
    - Commission is paid when user is placed in binary tree (via placement APIs)
    - Commission is ONLY paid if user has at least one successful payment
    - Commission timing: Paid when placement happens, regardless of when payment was completed
    - When User A is added as a direct child of User B, User B receives direct user commission (configurable, default: ₹1000)
    - Direct user commission is paid to ALL eligible ancestors (not just direct parent) if they have < 3 total descendants
    - After 3 total descendants are added, binary commission activates automatically
    - 20% TDS is deducted from direct user commission (configurable percentage)
    - Net amount (₹800 = ₹1000 - ₹200 TDS) is credited to referrer's wallet immediately upon placement
    - TDS is deducted from referrer's oldest active booking remaining amount
    - Only distributors can receive commissions
    - Note: Direct user commissions are NOT restricted for non-Active Buyer distributors (can earn unlimited before binary activation)
    
    Error Response (400):
    {
      "vehicle_model_code": ["Vehicle with model_code 'EV-INVALID' not found"],
      "booking_amount": ["Minimum booking amount is ₹500"],
      "total_amount": ["Total amount must match vehicle price (₹50000.00)"],
      "delivery_city": ["Delivery city is required"],
      "vehicle_model": ["Insufficient stock. Available: 0, Required: 1"]
    }
    
    Note on Stock Availability:
    - System checks vehicle stock availability before creating booking
    - If insufficient stock, booking creation fails with error message
    - Stock is automatically reserved when booking is created successfully
    
    Rate Limit: 10 requests per minute per IP


25. LIST BOOKINGS
    Method: GET
    URL: /api/booking/bookings/
    Authentication: Required
    Description: List user's bookings (admin sees all)
    
    Query Parameters:
    - page: Page number
    - status: Filter by status (pending, active, completed, cancelled, expired)
    
    Response (200 OK):
    {
      "count": 10,
      "results": [
        {
          "id": 1,
          "booking_number": "EVABC1234",
          "vehicle_model": 1,
          "vehicle_details": {
            "id": 1,
            "name": "EV Model X",
            "model_code": "EV-RED-40K-A9F3X2",
            "vehicle_color": ["red"],
            "battery_variant": ["40kWh"],
            "price": "50000.00"
          },
          "total_amount": "50000.00",
          "status": "pending",
          ...
        }
      ]
    }


26. GET BOOKING DETAILS
    Method: GET
    URL: /api/booking/bookings/{id}/
    Authentication: Required
    Description: Get specific booking details
    
    Response (200 OK):
    {
      "id": 1,
      "booking_number": "EVABC1234",
      "user": 1,
          "vehicle_model": 1,
          "vehicle_details": {
            "id": 1,
            "name": "EV Model X",
            "model_code": "EV-RED-40K-A9F3X2",
            "vehicle_color": ["red"],
            "battery_variant": ["40kWh"],
        "price": "50000.00"
      },
      "vehicle_color": "Red",
      "battery_variant": "40kWh",
      "total_amount": "50000.00",
      "total_paid": "5000.00",
      "remaining_amount": "45000.00",
      "status": "active",
      "delivery_city": "Mumbai",
      "delivery_state": "Maharashtra",
      "delivery_pin": "400001",
      "terms_accepted": true,
      "referred_by": 5,
      "join_distributor_program": false,
      "expires_at": "2026-02-05T12:00:00Z",
      "reservation_status": "reserved",  // "reserved", "released", "completed" - Stock reservation status
      "reservation_expires_at": "2026-01-07T12:00:00Z",  // When reservation expires (null = never expires)
      "emi_amount": "5000.00",
      "emi_paid_count": 1,
      "emi_total_count": 10,
      ...
    }


27. MAKE PAYMENT FOR BOOKING
    Method: POST
    URL: /api/booking/bookings/{id}/make_payment/
    Authentication: Required
    Description: Make a payment for booking
    
    Request Body:
    {
      "amount": 5000,
      "payment_method": "online"  // "online", "bank_transfer", "cash", "wallet"
    }
    
    Response (201 Created):
    {
      "id": 1,
      "booking": 1,
      "user": 1,
      "amount": "5000.00",
      "payment_method": "online",
      "status": "pending",  // Payment status: "pending", "completed", "failed", "refunded"
      "transaction_id": null,
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": null
    }
    
    Error Response (400):
    {
      "error": "Amount exceeds remaining amount"
    }
    
    Note: 
    - Payment is created with status='pending' (NOT automatically completed)
    - Payment status must be changed to 'completed' by:
      * Admin/Staff via /api/booking/payments/{id}/update_status/ endpoint
      * Payment gateway webhook (when integrated)
    - Only when payment status becomes 'completed':
      * Booking payment is processed (total_paid updated)
      * If total_paid ≥ ₹5000: booking status changes to 'active' (Active Buyer)
      * If remaining_amount ≤ 0: booking status changes to 'completed'
      * Stock reservation is marked as 'completed'
      * Referral commission is granted (if applicable)
    - Active Buyer status is updated when total paid reaches ₹5000
    - If booking was created with a referral_code, commission is automatically granted to the referrer when payment is confirmed
      * Commission = payment_amount × REFERRAL_COMMISSION_PERCENTAGE / 100
      * Commission is granted on every confirmed payment for the booking
      * Commission is only granted if referrer_was_distributor is True (referrer was distributor when booking was created)
      * No retroactive commissions: Only bookings created AFTER referrer becomes distributor get commission


28. ACCEPT PAYMENT (Admin/Staff Only)
    Method: POST
    URL: /api/booking/bookings/{id}/accept_payment/
    Authentication: Required (Admin or Staff)
    Description: Accept payment on behalf of a user (for manual payment processing)
    
    Request Body:
    {
      "amount": 5000,
      "payment_method": "cash",  // "online", "bank_transfer", "cash", "wallet"
      "transaction_id": "TXN123456",  // Optional - transaction reference
      "notes": "Payment received at counter"  // Optional - additional notes
    }
    
    Response (201 Created):
    {
      "id": 1,
      "booking": 1,
      "booking_number": "EVABC1234",
      "user": 1,
      "amount": "5000.00",
      "payment_method": "cash",
      "status": "completed",
      "transaction_id": "TXN123456",
      "notes": "Payment received at counter",
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "Amount exceeds remaining amount"
    }
    
    Error Response (403):
    {
      "error": "Permission denied. Only admin or staff can accept payments."
    }
    
    Note:
    - Only admin or staff can use this endpoint
    - Payment is automatically marked as 'completed' (admin/staff approval)
    - When payment status becomes 'completed':
      * Booking payment is processed (total_paid updated)
      * Stock reservation is marked as 'completed'
      * Booking status and referral commission are processed automatically


29. LIST PAYMENTS
    Method: GET
    URL: /api/booking/payments/
    Authentication: Required
    Description: List payment history (users see their own, admin/staff see all)
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "booking_number": "EVABC1234",
          "amount": "5000.00",
          "payment_method": "online",
          "status": "completed",
          "payment_date": "2026-01-06T12:00:00Z"
        }
      ]
    }


30. CREATE PAYMENT (Admin/Staff Only)
    Method: POST
    URL: /api/booking/payments/
    Authentication: Required (Admin or Staff)
    Description: Create a payment record (admin/staff only)
    
    Request Body:
    {
      "booking": 1,  // Booking ID - Required
      "amount": 5000,
      "payment_method": "cash",  // "online", "bank_transfer", "cash", "wallet"
      "status": "completed",  // "pending", "completed", "failed", "refunded"
      "transaction_id": "TXN123456",  // Optional
      "notes": "Payment received"  // Optional
    }
    
    Response (201 Created):
    {
      "id": 1,
      "booking": 1,
      "booking_number": "EVABC1234",
      "user": 1,
      "amount": "5000.00",
      "payment_method": "cash",
      "status": "completed",
      "transaction_id": "TXN123456",
      "notes": "Payment received",
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (403):
    {
      "detail": "Only admin or staff can create payments"
    }
    
    Note:
    - User is automatically set from booking.user
    - If status is 'completed', booking payment is processed automatically
    - Stock reservation is marked as 'completed' when payment status becomes 'completed'


31. UPDATE PAYMENT STATUS (Admin/Staff Only)
    Method: PATCH
    URL: /api/booking/payments/{id}/update_status/
    Authentication: Required (Admin or Staff)
    Description: Update payment status (admin/staff only)
    
    Request Body:
    {
      "status": "completed",  // "pending", "completed", "failed", "refunded"
      "transaction_id": "TXN123456",  // Optional - update transaction ID
      "notes": "Payment verified"  // Optional - update notes
    }
    
    Response (200 OK):
    {
      "id": 1,
      "booking": 1,
      "booking_number": "EVABC1234",
      "user": 1,
      "amount": "5000.00",
      "payment_method": "cash",
      "status": "completed",
      "transaction_id": "TXN123456",
      "notes": "Payment verified",
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "Invalid status. Valid choices: ['pending', 'completed', 'failed', 'refunded']"
    }
    
    Error Response (403):
    {
      "error": "Permission denied. Only admin or staff can update payment status."
    }
    
    Note:
    - Valid status transitions:
      * pending -> completed, failed
      * completed -> refunded, failed
      * failed -> pending, completed
      * refunded -> (no transitions allowed)
    - If status changes to 'completed':
      * Booking payment is processed automatically (total_paid updated)
      * Stock reservation is marked as 'completed' (if exists)
      * Booking status updated (active/completed based on payment amount)
      * Referral commission is granted (if applicable)


32. CANCEL BOOKING
    Method: POST
    URL: /api/booking/bookings/{id}/cancel/
    Authentication: Required
    Description: Cancel a booking and release stock reservation
    
    Response (200 OK):
    {
      "id": 1,
      "booking_number": "EVABC1234",
      "status": "cancelled",
      "reservation_status": "released",
      "vehicle_color": "Red",
      "battery_variant": "40kWh",
      "total_amount": "50000.00",
      "total_paid": "0.00",
      "remaining_amount": "50000.00",
      ...
    }
    
    Error Response (400):
    {
      "error": "Cannot cancel booking with status: completed"
    }
    
    Error Response (403):
    {
      "error": "Permission denied"
    }
    
    Note:
    - User can cancel their own booking, admin/staff can cancel any booking
    - When booking is cancelled:
      * Booking status is set to 'cancelled'
      * Stock reservation is released (if exists)
      * Vehicle stock (available_quantity) is restored
    - Cannot cancel bookings with status 'cancelled' or 'completed'


================================================================================
                        VEHICLE INVENTORY APIs
================================================================================

33. UPLOAD IMAGES
    Method: POST
    URL: /api/inventory/images/upload/
    Authentication: Required (Admin/Superuser only)
    Description: Upload images independently (without vehicle association). Returns image IDs and URLs that can be used in vehicle creation.
    
    Content-Type: multipart/form-data
    
    Request Body (form-data):
    - images[]: @image1.jpg (required, at least one file)
    - images[]: @image2.jpg (optional, multiple files)
    
    Alternative formats also supported:
    - images_data[]: @image1.jpg
    - images[0]: @image1.jpg, images[1]: @image2.jpg
    
    Response (201 Created):
    [
      {
        "id": 1,
        "image_url": "http://localhost:8000/media/vehicles/images/image1.jpg",
        "created_at": "2026-01-08T12:00:00Z"
      },
      {
        "id": 2,
        "image_url": "http://localhost:8000/media/vehicles/images/image2.jpg",
        "created_at": "2026-01-08T12:00:01Z"
      }
    ]
    
    Error Response (400):
    {
      "error": "No images provided. Please upload at least one image file."
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can upload images."
    }
    
    Usage Flow:
    1. Upload images using this endpoint
    2. Get image IDs from response (e.g., [1, 2])
    3. Use these IDs in vehicle creation: {"image_ids": [1, 2], ...}


34. LIST VEHICLES
    Method: GET
    URL: /api/inventory/vehicles/
    Authentication: Required (All authenticated users)
    Description: List all available vehicles grouped by name. Each vehicle name contains all its variants (color-battery combinations). Supports pagination, filtering, and search.
    
    Query Parameters:
    - page: (optional) Page number (default: 1)
    - page_size: (optional) Number of vehicle groups per page (default: 10, max: 100)
    - name: (optional) Filter by vehicle name (case-insensitive, partial match)
    - model_code: (optional) Filter by model code (case-insensitive, partial match)
    - status: (optional) Filter by status (available, out_of_stock, discontinued)
    - color: (optional) Filter by vehicle color (e.g., "white", "red", "blue")
    - battery: (optional) Filter by battery variant (e.g., "40kWh", "60kWh")
    - min_price: (optional) Filter by minimum price (numeric)
    - max_price: (optional) Filter by maximum price (numeric)
    - search: (optional) Search across name, model_code, description, and features (case-insensitive)
    
    Examples:
    - /api/inventory/vehicles/?page=1&page_size=20
    - /api/inventory/vehicles/?name=EV Model X
    - /api/inventory/vehicles/?model_code=EV-WHT
    - /api/inventory/vehicles/?status=available
    - /api/inventory/vehicles/?color=white&battery=40kWh
    - /api/inventory/vehicles/?min_price=40000&max_price=60000
    - /api/inventory/vehicles/?search=premium
    - /api/inventory/vehicles/?page=2&page_size=10&status=available&search=EV
    
    Response (200 OK):
    {
      "count": 1,  // Number of unique vehicle names (groups) matching filters
      "next": "http://127.0.0.1:8000/api/inventory/vehicles/?page=2",  // URL for next page (null if last page)
      "previous": null,  // URL for previous page (null if first page)
      "page_size": 10,  // Number of vehicle groups per page
      "current_page": 1,  // Current page number
      "total_pages": 1,  // Total number of pages
      "results": [
        {
          "name": "EV Model X2",
          "variants": [
            {
              "id": 19,
              "model_code": "EV-BLU-60K-TMMR0A",
              "vehicle_color": ["blue"],
              "battery_variant": ["60kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.403303+05:30"
            },
            {
              "id": 18,
              "model_code": "EV-BLU-40K-SCDA4J",
              "vehicle_color": ["blue"],
              "battery_variant": ["40kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.402882+05:30"
            },
            {
              "id": 17,
              "model_code": "EV-RED-60K-KE16X4",
              "vehicle_color": ["red"],
              "battery_variant": ["60kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.402442+05:30"
            },
            {
              "id": 16,
              "model_code": "EV-RED-40K-RZ2O33",
              "vehicle_color": ["red"],
              "battery_variant": ["40kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.402047+05:30"
            },
            {
              "id": 15,
              "model_code": "EV-WHT-60K-2EZP7T",
              "vehicle_color": ["white"],
              "battery_variant": ["60kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.401623+05:30"
            },
            {
              "id": 14,
              "model_code": "EV-WHT-40K-QKUK9J",
              "vehicle_color": ["white"],
              "battery_variant": ["40kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": "http://127.0.0.1:8000/media/vehicles/images/Screenshot_2025-12-29_095141_yNKhXBN.png",
              "image_count": 2,
              "created_at": "2026-01-09T09:49:41.396665+05:30"
            }
          ]
        }
      ]
    }
    
    Notes:
    - Vehicles are grouped by name, with all color-battery variants under each name
    - Pagination is based on vehicle groups (names), not individual vehicles
    - count refers to the number of unique vehicle names matching the filters
    - All filters can be combined (e.g., ?name=EV&status=available&color=white&min_price=40000)
    - Search parameter searches across multiple fields: name, model_code, description, and features
    - Color and battery filters use array containment (vehicle must have that color/battery in its array)
    - Price filters accept numeric values (decimals supported)
    - Results are ordered by creation date (newest first)
    - Default page size is 10, maximum is 100
    - Use page parameter for pagination (e.g., ?page=2)
    - Use page_size parameter to change items per page (e.g., ?page_size=20)
    - Each group contains all variants (color-battery combinations) for that vehicle name
    - count represents the number of unique vehicle names, not individual vehicles
    - Each variant includes: id, model_code, vehicle_color, battery_variant, price, status, primary_image_url, image_count, created_at
    - model_code format: EV-{COLOR_CODE}-{BATTERY_CODE}-{RANDOM} (e.g., EV-WHT-40K-A9F3X2)
      - COLOR_CODE uses the first color from vehicle_color array
      - BATTERY_CODE extracted from battery variant (40kWh → 40K)
    - vehicle_color: Array of available colors (e.g., ["white", "red", "blue"])
    - battery_variant: Array with single battery variant (e.g., ["40kWh"])
    - Filtering by status or search works on individual variants, but results are still grouped by name
    
    Error Response (401):
    {
      "detail": "Authentication credentials were not provided."
    }


35. GET VEHICLE DETAILS
    Method: GET
    URL: /api/inventory/vehicles/{id}/
    Authentication: Required (All authenticated users)
    Description: Get detailed information about a specific vehicle including all images, features, and specifications
    
    Notes:
    - Each vehicle has multiple colors and a single battery variant
    - model_code format: EV-{COLOR_CODE}-{BATTERY_CODE}-{RANDOM} (e.g., EV-WHT-40K-A9F3X2)
      - COLOR_CODE uses the first color from vehicle_color array
      - BATTERY_CODE extracted from battery variant (40kWh → 40K)
    - vehicle_color: Array of available colors (e.g., ["white", "red", "blue"])
    - battery_variant: Array with single battery variant (e.g., ["40kWh"])
    - features: Optional field, returns empty array [] if not set
    - specifications: Optional field, returns empty object {} if not set
    - No limit on number of features or specifications
    - You can add any custom specification keys and values
    
    Response (200 OK):
    {
      "id": 1,
      "name": "EV Model X",
      "model_code": "EV-WHT-40K-A9F3X2",  // Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_color": ["white", "red", "blue"],  // Array of available colors
      "battery_variant": ["40kWh"],  // Single battery variant per vehicle (array with one element)
      "price": "50000.00",
      "status": "available",
      "description": "Premium electric vehicle with advanced features",
      "features": [
        "USB Charging Port",
        "Parking Mode",
        "Reverse Gear"
      ],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Charging Duration": "4-5h",
        "Max Speed": "25 km/h",
        "Mileage": "125+ km",
        "Battery Type": "Lithium-ion Battery",
        "Motor Type": "Brushless DC",
        "Frame Type": "Steel",
        "Tyre Type": "Tubeless",
        "Dimension": "1850×710×1120 MM",
        "Net Weight": "80KG",
        "Head Light": "LED Projector Light",
        "Riding Mode": "Eco-Power-Sport",
        "Brake": "Front Disc - Rear Drum",
        "Tyre Size": "90/100-10 53J",
        "Wheel Base": "1630mm",
        "Meter Type": "Digital"
      },
      "images": [
        {
          "id": 1,
          "image": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
          "image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
          "is_primary": true,
          "alt_text": "EV Model X - Front View",
          "order": 0,
          "created_at": "2026-01-06T12:00:00Z"
        },
        {
          "id": 2,
          "image": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
          "image_url": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
          "is_primary": false,
          "alt_text": "EV Model X - Side View",
          "order": 1,
          "created_at": "2026-01-06T12:01:00Z"
        }
      ],
      "primary_image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T15:00:00Z"
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


36. CREATE VEHICLE
    Method: POST
    URL: /api/inventory/vehicles/
    Authentication: Required (Admin/Superuser only)
    Description: Create vehicles. If color_images provided, creates one vehicle per color-battery combination. Otherwise, creates one vehicle per battery variant. Images must be uploaded first using /api/inventory/images/upload/ and linked via color_images or image_ids.
    
    Content-Type: application/json
    
    Request Body (JSON):
    {
      "name": "EV Model X",
      "vehicle_color": ["white", "red", "blue"],  // Array of colors
      "battery_variant": ["40kWh", "60kWh"],  // Array of battery variants
      "price": 50000,  // Base price - used for all variants if battery_pricing not provided
      "battery_pricing": {  // Optional: Dictionary mapping battery variant names to prices
        "40kWh": 50000,
        "60kWh": 60000
      },
      "status": "available",
      "description": "Premium electric vehicle",
      "features": ["USB Charging Port", "Parking Mode", "Reverse Gear"],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Max Speed": "25 km/h"
      },
      "color_images": {  // Optional: Map colors to image IDs for per-color images
        "white": [1, 2, 3],
        "red": [4, 5],
        "blue": [6, 7, 8]
      },
      "image_ids": [1, 2, 3],  // Optional: Fallback - links to first vehicle if color_images not provided
      "initial_quantity": 10  // Optional: Initial stock quantity for each vehicle variant. Defaults to 0 if not provided.
    }
    
    Field Descriptions:
    - name: (required) Vehicle name
    - model_code: (auto-generated, read-only) Automatically generated model code in format EV-{COLOR}-{BATTERY}-{RANDOM} (e.g., EV-WHT-40K-A9F3X2). Do not include in request.
    - vehicle_color: (required) Array of vehicle colors (e.g., ["white", "red", "blue"])
    - battery_variant: (required) Array of battery variants (e.g., ["40kWh", "60kWh"])
    - price: (required) Base vehicle price - used for all variants if battery_pricing not provided, or as fallback for battery variants not in battery_pricing
    - battery_pricing: (optional) Dictionary mapping battery variant names to prices (e.g., {"40kWh": 50000, "60kWh": 60000})
      - If provided, each battery variant uses its specified price
      - If a battery variant is not in battery_pricing, it uses the base price field
      - All keys in battery_pricing must exist in battery_variant array
      - All prices must be non-negative numbers
      - If not provided, all variants use the base price field value
    - status: (optional, default: "available") Status: "available", "out_of_stock", "discontinued"
    - description: (optional) Vehicle description (applies to all created vehicles)
    - features: (optional) Array of feature strings - unlimited items (applies to all created vehicles)
    - specifications: (optional) Object with key-value pairs - unlimited custom fields (applies to all created vehicles)
    - color_images: (optional) Dictionary mapping color names to arrays of image IDs (e.g., {"white": [1,2,3], "red": [4,5]})
      - If provided, creates one vehicle per color-battery combination with images linked per color
      - Keys must match colors in vehicle_color array
      - All image IDs must reference unlinked images from /api/inventory/images/upload/
    - image_ids: (optional) Array of image IDs from /api/inventory/images/upload/ endpoint
      - Only used if color_images is not provided (backward compatibility)
      - Images are linked to the first created vehicle
    - initial_quantity: (optional, default: 0) Initial stock quantity for the vehicle
      - Applies to each variant created (each color-battery combination gets this quantity)
      - Must be a non-negative integer (0 or greater)
      - Creates VehicleStock record automatically for each vehicle with the specified quantity
      - If not provided, VehicleStock is still created with quantity 0
    
    Notes:
    - Pricing Behavior:
      - If battery_pricing is provided: Each battery variant uses its specified price from battery_pricing
      - If battery_pricing is not provided: All variants use the base price field value
      - If battery_pricing is provided but missing some battery variants: Missing variants fall back to base price
      - Example: battery_variant=["40kWh", "60kWh"], battery_pricing={"40kWh": 50000} → 40kWh uses ₹50000, 60kWh uses base price
      - All keys in battery_pricing must match battery variant names in battery_variant array
      - Prices in battery_pricing must be non-negative numbers (zero allowed for promotional pricing)
    - If color_images provided: Creates one vehicle per color-battery combination (e.g., 3 colors × 2 batteries = 6 vehicles)
      - Each vehicle has a single color and single battery variant
      - Images are linked to vehicles based on color mapping in color_images
      - Example: color_images={"white": [1,2], "red": [3,4]} links images 1,2 to white vehicles and 3,4 to red vehicles
    - If color_images NOT provided: Creates one vehicle per battery variant (backward compatibility)
      - Each vehicle contains all colors in vehicle_color array
      - Example: 3 colors + 2 batteries = 2 vehicles created (each with all 3 colors)
      - Images from image_ids are linked to the first created vehicle only
    - model_code format: EV-{COLOR_CODE}-{BATTERY_CODE}-{RANDOM}
      - COLOR_CODE: 3-letter code from color (WHT, RED, BLU, BLK, GRY, etc.)
      - BATTERY_CODE: Extracted from battery variant (40kWh → 40K, 60kWh → 60K)
      - RANDOM: 6 random alphanumeric characters
      Example: EV-WHT-40K-A9F3X2 (Color: white, Battery: 40kWh)
    - color_images: Optional dictionary mapping color names to arrays of image IDs
      - Keys must match colors in vehicle_color array
      - All image IDs must reference images uploaded via /api/inventory/images/upload/
      - Images must be unlinked (not already associated with another vehicle)
    - image_ids: Optional array of image IDs (fallback if color_images not provided)
      - Only used if color_images is not provided
      - Images are linked to the first created vehicle only
    - Features and specifications are completely optional - can be omitted or left empty
    - No limit on number of features or specifications
    - First image for each vehicle will be set as primary if no primary exists
    - initial_quantity: Optional field to set initial stock quantity when creating vehicles
      - Each vehicle variant (color-battery combination) gets its own VehicleStock with the specified quantity
      - If not provided, defaults to 0 (VehicleStock still created)
      - Use /api/inventory/stock/ endpoints to view or update stock quantities after creation
    
    Response (201 Created) - Array of created vehicles:
    [
      {
        "id": 1,
        "name": "EV Model X",
        "model_code": "EV-WHT-40K-A9F3X2",  // Color: white, Battery: 40kWh (when color_images provided)
        "vehicle_color": ["white"],  // Single color per vehicle when color_images provided
        "battery_variant": ["40kWh"],  // Single battery per vehicle
        "price": "50000.00",  // Price from battery_pricing or base price
        "status": "available",
        "description": "Premium electric vehicle",
        "features": [
          "USB Charging Port",
          "Parking Mode",
          "Reverse Gear"
        ],
        "specifications": {
          "Battery": "60V × 50AH",
          "Motor Power": "48V/60V/72V 1000W",
          "Charging Duration": "4-5h",
          "Max Speed": "25 km/h",
          "Mileage": "125+ km",
          "Battery Type": "Lithium-ion Battery",
          "Motor Type": "Brushless DC"
        },
        "images": [
          {
            "id": 1,
            "image": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
            "image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
            "is_primary": true,
            "alt_text": "",
            "order": 0
          },
          {
            "id": 2,
            "image": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
            "image_url": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
            "is_primary": false,
            "alt_text": "",
            "order": 1
          }
        ],
        "primary_image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
        "stock_total_quantity": 10,
        "stock_available_quantity": 10,
        "stock_reserved_quantity": 0,
        "created_at": "2026-01-08T12:00:00Z",
        "updated_at": "2026-01-08T12:00:00Z"
      },
      {
        "id": 2,
        "name": "EV Model X",
        "model_code": "EV-WHT-60K-B7C4Y1",  // Color: white, Battery: 60kWh (when color_images provided)
        "vehicle_color": ["white"],  // Single color per vehicle when color_images provided
        "battery_variant": ["60kWh"],  // Single battery per vehicle
        "price": "60000.00",  // Price from battery_pricing or base price
        "status": "available",
        "description": "Premium electric vehicle",
        "features": [
          "USB Charging Port",
          "Parking Mode",
          "Reverse Gear"
        ],
        "specifications": {
          "Battery": "60V × 50AH",
          "Motor Power": "48V/60V/72V 1000W",
          "Charging Duration": "4-5h",
          "Max Speed": "25 km/h",
          "Mileage": "125+ km",
          "Battery Type": "Lithium-ion Battery",
          "Motor Type": "Brushless DC"
        },
        "images": [],
        "primary_image_url": null,
        "stock_total_quantity": 10,
        "stock_available_quantity": 10,
        "stock_reserved_quantity": 0,
        "created_at": "2026-01-08T12:00:00Z",
        "updated_at": "2026-01-08T12:00:00Z"
      },
      {
        "id": 3,
        "name": "EV Model X",
        "model_code": "EV-RED-40K-C8D5Z2",  // Red, 40kWh
        "vehicle_color": ["red"],
        "battery_variant": ["40kWh"],
        "price": "50000.00",  // Price from battery_pricing or base price
        "status": "available",
        "description": "Premium electric vehicle",
        "features": [
          "USB Charging Port",
          "Parking Mode",
          "Reverse Gear"
        ],
        "specifications": {
          "Battery": "60V × 50AH",
          "Motor Power": "48V/60V/72V 1000W",
          "Charging Duration": "4-5h",
          "Max Speed": "25 km/h",
          "Mileage": "125+ km",
          "Battery Type": "Lithium-ion Battery",
          "Motor Type": "Brushless DC"
        },
        "images": [],
        "primary_image_url": null,
        "created_at": "2026-01-08T12:00:00Z",
        "updated_at": "2026-01-08T12:00:00Z"
      }
      // ... more vehicles for each color-battery combination
    ]
    
    Error Response (400):
    {
      "name": ["This field is required."],
      "image_ids": ["Image IDs [5, 6] do not exist or are already linked to a vehicle. Please upload images first using /api/inventory/images/upload/"],
      "battery_pricing": ["Battery variants ['80kWh'] in battery_pricing are not in battery_variant array."],
      "price": ["Price is required when battery_pricing is not provided."]
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Example Workflow:
    1. Upload images: POST /api/inventory/images/upload/ → Get [1, 2, 3]
    2. Create vehicle: POST /api/inventory/vehicles/ with {"image_ids": [1, 2, 3], ...}


37. UPDATE VEHICLE
    Method: PATCH / PUT
    URL: /api/inventory/vehicles/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Update vehicle information. To add images, upload them first and include image_ids.
    
    Content-Type: application/json
    
    Request Body (JSON example):
    {
      "name": "EV Model X Updated",
      "price": 55000,
      "status": "out_of_stock",
      "description": "Updated description",
      "features": ["USB Charging Port", "Parking Mode", "Reverse Gear", "LED Lights"],
      "specifications": {
        "Battery": "60V × 50AH",
        "Max Speed": "30 km/h"
      },
      "color_images": {
        "white": [1, 2, 3],
        "red": [4, 5]
      },
      "image_ids": [4, 5],  // Fallback if color_images not provided
      "initial_quantity": 25  // Or use stock_quantity (both supported)
    }
    
    Notes:
    - All fields are optional (partial update)
    - model_code is read-only and cannot be updated (it is auto-generated when the vehicle is created)
    - vehicle_color: Array of available colors (e.g., ["white", "red", "blue"]). Can be updated to change available colors.
    - battery_variant: Array with single battery variant (e.g., ["40kWh"]). Can be updated to change battery variant.
    - Features and specifications are optional - can be omitted, updated, or left empty
    - No limit on number of features or specifications
    - color_images: (optional) Dictionary mapping color names to arrays of image IDs (e.g., {"white": [1, 2, 3], "red": [4, 5]})
      - Takes precedence over image_ids if both are provided
      - Colors in color_images are automatically added to vehicle_color if not already present
      - All image IDs must reference unlinked images from /api/inventory/images/upload/
      - Images are linked to the vehicle based on color mapping
      - **REPLACE behavior**: If color_images is provided, ALL existing images are removed and replaced with the new images from color_images
    - image_ids: (optional) Array of image IDs from /api/inventory/images/upload/ to link to vehicle
      - Only used if color_images is not provided (fallback, backward compatibility)
      - **MERGE behavior**: Adds new images, removes images not in the array, keeps existing images that are in the array
      - Images are reordered to match the order in image_ids array
      - Only unlinked images can be added (images already linked to other vehicles will be rejected)
    - image_ids: (optional) Array of image IDs from /api/inventory/images/upload/ to link to vehicle
      - Only used if color_images is not provided (fallback, backward compatibility)
      - Only unlinked images can be added (images already linked to other vehicles will be rejected)
      - Existing images are updated/reordered based on image_ids array
    - initial_quantity: (optional) Update stock quantity for this vehicle (same as CREATE endpoint)
      - Must be a non-negative integer (0 or greater)
      - Creates VehicleStock record if it doesn't exist
      - Updates total_quantity and adjusts available_quantity accordingly
      - If new quantity is less than current reserved quantity, available_quantity is set to 0
      - If new quantity is greater than or equal to reserved quantity, available_quantity = new_quantity - reserved_quantity
      - stock_quantity is also supported as an alias for backward compatibility
    
    Response (200 OK):
    {
      "id": 1,
      "name": "EV Model X Updated",
      "model_code": "EV-WHT-40K-A9F3X2",  // Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_color": ["white", "red", "blue"],  // Array of available colors
      "battery_variant": ["40kWh"],  // Single battery variant per vehicle
      "price": "55000.00",
      "status": "out_of_stock",
      "description": "Updated description",
      "features": [
        "USB Charging Port",
        "Parking Mode",
        "Reverse Gear",
        "LED Lights"
      ],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Max Speed": "30 km/h"
      },
      "images": [...],
      "primary_image_url": "...",
      "stock_total_quantity": 10,
      "stock_available_quantity": 7,
      "stock_reserved_quantity": 3,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


38. DELETE VEHICLE
    Method: DELETE
    URL: /api/inventory/vehicles/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Delete a vehicle and all associated images
    
    Response (204 No Content):
    (Empty response body)
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


39. ADD IMAGES TO VEHICLE
    Method: POST
    URL: /api/inventory/vehicles/{id}/add-images/
    Authentication: Required (Admin/Superuser only)
    Description: Add additional images to an existing vehicle
    
    Content-Type: multipart/form-data
    
    Request Body (form-data):
    - images_data[]: @image1.jpg (required, at least one file)
    - images_data[]: @image2.jpg (optional)
    
    Response (201 Created):
    [
      {
        "id": 4,
        "image": "http://localhost:8000/media/vehicles/images/evx-red-4.jpg",
        "image_url": "http://localhost:8000/media/vehicles/images/evx-red-4.jpg",
        "is_primary": false,
        "alt_text": "",
        "order": 3,
        "created_at": "2026-01-06T17:00:00Z"
      },
      {
        "id": 5,
        "image": "http://localhost:8000/media/vehicles/images/evx-red-5.jpg",
        "image_url": "http://localhost:8000/media/vehicles/images/evx-red-5.jpg",
        "is_primary": false,
        "alt_text": "",
        "order": 4,
        "created_at": "2026-01-06T17:00:01Z"
      }
    ]
    
    Error Response (400):
    {
      "error": "No images provided"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }


40. REMOVE IMAGE FROM VEHICLE
    Method: DELETE
    URL: /api/inventory/vehicles/{id}/remove-image/{image_id}/
    Authentication: Required (Admin/Superuser only)
    Description: Remove a specific image from a vehicle
    
    Response (204 No Content):
    {
      "message": "Image deleted successfully"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "error": "Image not found"
    }


41. SET PRIMARY IMAGE
    Method: PATCH
    URL: /api/inventory/vehicles/{id}/set-primary-image/{image_id}/
    Authentication: Required (Admin/Superuser only)
    Description: Set a specific image as the primary/featured image for a vehicle
    
    Response (200 OK):
    {
      "id": 3,
      "image": "http://localhost:8000/media/vehicles/images/evx-red-3.jpg",
      "image_url": "http://localhost:8000/media/vehicles/images/evx-red-3.jpg",
      "is_primary": true,
      "alt_text": "EV Model X - Interior",
      "order": 2,
      "created_at": "2026-01-06T12:02:00Z"
    }
    
    Note: Setting a new primary image automatically unchecks the previous primary image
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "error": "Image not found"
    }


42. LIST VEHICLE STOCK
    Method: GET
    URL: /api/inventory/stock/
    Authentication: Required (Admin/Superuser only)
    Description: List all vehicle stock records with filtering options
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    - vehicle_id: Filter by vehicle ID
    - model_code: Filter by vehicle model code (partial match)
    - vehicle_name: Filter by vehicle name (partial match)
    - min_available: Filter by minimum available quantity
    - max_available: Filter by maximum available quantity
    
    Response (200 OK):
    {
      "count": 50,
      "next": "http://localhost:8000/api/inventory/stock/?page=2",
      "previous": null,
      "results": [
        {
          "id": 1,
          "vehicle": 1,
          "vehicle_name": "EV Model X",
          "vehicle_model_code": "EV-RED-40K-A9F3X2",
          "total_quantity": 10,
          "available_quantity": 7,
          "reserved_quantity": 3,
          "created_at": "2026-01-06T12:00:00Z",
          "updated_at": "2026-01-06T15:00:00Z"
        }
      ]
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }


43. GET VEHICLE STOCK BY ID
    Method: GET
    URL: /api/inventory/stock/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Get specific vehicle stock record
    
    Response (200 OK):
    {
      "id": 1,
      "vehicle": 1,
      "vehicle_name": "EV Model X",
      "vehicle_model_code": "EV-RED-40K-A9F3X2",
      "total_quantity": 10,
      "available_quantity": 7,
      "reserved_quantity": 3,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T15:00:00Z"
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


44. UPDATE VEHICLE STOCK
    Method: PATCH / PUT
    URL: /api/inventory/stock/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Update vehicle stock quantity
    
    Request Body:
    {
      "total_quantity": 15
    }
    
    Response (200 OK):
    {
      "id": 1,
      "vehicle": 1,
      "vehicle_name": "EV Model X",
      "vehicle_model_code": "EV-RED-40K-A9F3X2",
      "total_quantity": 15,
      "available_quantity": 12,  // Automatically increased by 5 (15-10)
      "reserved_quantity": 3,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    Error Response (400):
    {
      "total_quantity": ["Total quantity cannot be less than reserved quantity (3)"]
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Note:
    - total_quantity: Can be updated (admin sets this)
    - available_quantity: Read-only (automatically calculated)
    - reserved_quantity: Read-only (calculated: total_quantity - available_quantity)
    - When total_quantity is increased: available_quantity is automatically increased by the difference
    - When total_quantity is decreased: available_quantity is decreased, but cannot go below reserved quantity
    - Cannot set total_quantity less than current reserved quantity


45. UPDATE STOCK BY VEHICLE ID
    Method: POST
    URL: /api/inventory/stock/by-vehicle/{vehicle_id}/
    Authentication: Required (Admin/Superuser only)
    Description: Update or create stock for a specific vehicle by vehicle ID
    
    Request Body:
    {
      "total_quantity": 20
    }
    
    Response (200 OK):
    {
      "id": 1,
      "vehicle": 5,
      "vehicle_name": "EV Model Y",
      "vehicle_model_code": "EV-BLU-60K-XYZ789",
      "total_quantity": 20,
      "available_quantity": 20,  // If stock was just created, available = total
      "reserved_quantity": 0,
      "created_at": "2026-01-06T16:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    Error Response (404):
    {
      "error": "Vehicle not found"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Note:
    - If stock doesn't exist for the vehicle, it will be created automatically
    - If stock exists, it will be updated
    - Same validation rules apply as UPDATE VEHICLE STOCK endpoint


================================================================================
                            WALLET APIs
================================================================================

46. GET MY WALLET
    Method: GET
    URL: /api/wallet/my_wallet/
    Authentication: Required
    Description: Get current user's wallet balance and details
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "balance": "15000.00",
      "total_earned": "20000.00",
      "total_withdrawn": "5000.00",
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T15:00:00Z"
    }


47. LIST WALLET TRANSACTIONS
    Method: GET
    URL: /api/wallet/transactions/
    Authentication: Required
    Description: Get wallet transaction history
    
    Query Parameters:
    - page: Page number
    - transaction_type: Filter by type (REFERRAL_BONUS, BINARY_PAIR, EMI_DEDUCTION, PAYOUT, etc.)
    - start_date: Filter from date (YYYY-MM-DD)
    - end_date: Filter to date (YYYY-MM-DD)
    
    Response (200 OK):
    {
      "count": 50,
      "results": [
        {
          "id": 1,
          "user": 1,
          "transaction_type": "BINARY_PAIR",
          "amount": "500.00",
          "balance_before": "10000.00",
          "balance_after": "10500.00",
          "description": "Binary pair earning (Pair #1)",
          "reference_id": 1,
          "reference_type": "binary_pair",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }
    
    Transaction Types:
    - REFERRAL_BONUS: Referral earnings
    - BINARY_PAIR: Binary pair matching earnings (legacy)
    - BINARY_PAIR_COMMISSION: Binary pair commission after activation (new commission structure)
    - DIRECT_USER_COMMISSION: Commission for direct user addition before activation (net amount after TDS)
    - TDS_DEDUCTION: TDS deducted from all binary commissions (direct user and pairs, deducted from booking remaining amount)
    - EXTRA_DEDUCTION: Extra deduction for 6th+ binary pairs (additional 20%, deducted from booking remaining amount)
    - EMI_DEDUCTION: Automatic EMI deductions
    - RESERVE_DEDUCTION: Reserve fund deductions
    - PAYOUT: Withdrawal transactions
    - DEPOSIT: Manual deposits
    - REFUND: Refund transactions


================================================================================
                            BINARY APIs
================================================================================

48. GET MY BINARY TREE
    Method: GET
    URL: /api/binary/nodes/my_tree/
    Authentication: Required
    Description: Get current user's binary tree information
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "parent": null,
      "side": null,
      "level": 0,
      "left_count": 5,
      "right_count": 3,
      "binary_commission_activated": true,  // Whether binary commission is activated
      "activation_timestamp": "2026-01-06T12:00:00Z",  // Timestamp when binary commission was activated
      "direct_children_count": 3,  // Count of direct children (left + right)
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (404):
    {
      "message": "No binary node found"
    }
    
    Notes:
    - binary_commission_activated: True if user has reached the activation threshold (default: 3 total descendants)
    - activation_timestamp: Timestamp when binary commission was activated (used to determine pairing eligibility)
    - direct_children_count: Number of direct children (nodes where parent = this node)
    - Binary commission activates when total descendants >= activation_count (configurable via settings)
    - Pair Matching Eligibility: Only members created at or after activation_timestamp are eligible for pairing


49. LIST BINARY NODES
    Method: GET
    URL: /api/binary/nodes/
    Authentication: Required
    Description: List binary nodes (admin sees all)
    
    Response (200 OK):
    {
      "count": 100,
      "results": [
        {
          "id": 1,
          "user": 1,
          "parent": null,
          "side": null,
          "left_count": 5,
          "right_count": 3,
          ...
        }
      ]
    }


50. CHECK FOR BINARY PAIRS
    Method: POST
    URL: /api/binary/pairs/check_pairs/
    Authentication: Required
    Description: Manually trigger pair checking. Only works if binary commission is activated (user has 3+ direct children).
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "left_user": 2,
      "right_user": 3,
      "pair_amount": "2000.00",  // Commission amount (configurable, default: ₹2000)
      "earning_amount": "2000.00",  // Net amount after TDS (if applicable)
      "status": "matched",
      "pair_month": 1,
      "pair_year": 2026,
      "pair_number_after_activation": 1,  // Pair number after activation (null if before activation)
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Response (200 OK) - No pairs:
    {
      "message": "No pairs available"
    }
    
    Notes:
    - Maximum 10 pairs per DAY per user (configurable daily limit)
    - Binary commission must be activated (user must have 3+ total descendants)
    - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
      * Pre-activation members (1st and 2nd members) are EXCLUDED from pairing
      * Member that triggered activation (3rd member) is INCLUDED in pairing
      * All members added after activation are INCLUDED in pairing
      * Example: If User A has B (1st), C (2nd), D (3rd - triggers activation), E (4th):
        - B and C are excluded from pairing
        - D and E can be paired (not B and C)
    - Commission amount is configurable via Platform Settings (default: ₹2000)
    - 20% TDS is applied on ALL pair commissions (1st pair onwards, configurable percentage)
    - Extra 20% deduction applies from 6th pair onwards (configurable threshold and percentage)
    - Pairs 1-5: ₹2000 - 20% TDS = ₹1600 credited
    - Pairs 6+: ₹2000 - 20% TDS - 20% extra = ₹1200 credited (extra deducted from booking balance)
    - TDS and extra deduction are deducted from user's oldest active booking remaining amount
    - earning_amount shows net amount after TDS and extra deduction (if applicable)
    - Daily limit reset: Resets at midnight (00:00 server time)
    - After 10 pairs in a day: SHORT leg (fewer remaining members) is ignored, LONG leg (more remaining) is carried forward


51. LIST BINARY PAIRS
    Method: GET
    URL: /api/binary/pairs/
    Authentication: Required
    Description: List binary pairs for user
    
    Query Parameters:
    - pair_month: Filter by month (1-12)
    - pair_year: Filter by year
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "user": 1,
          "left_user": 2,
          "right_user": 3,
          "pair_amount": "2000.00",  // Commission amount (configurable)
          "earning_amount": "2000.00",  // Net amount after TDS (if applicable)
          "status": "processed",
          "pair_month": 1,
          "pair_year": 2026,
          "pair_number_after_activation": 1,  // Pair number after activation (null if before activation)
          "matched_at": "2026-01-06T12:00:00Z"
        }
      ]
    }
    
    Notes:
    - pair_amount: Gross commission amount (configurable via settings, default: ₹2000)
    - earning_amount: Net amount credited to wallet (after TDS and extra deduction if applicable)
    - pair_number_after_activation: Tracks which pair this is after binary commission activation
    - pair_date: Date when pair was created (for daily limit tracking)
    - is_carry_forward_pair: Whether this pair used carried-forward members from previous day
    - extra_deduction_applied: Amount of extra deduction applied (for 6th+ pairs)
    - 20% TDS is applied on ALL pair commissions (1st pair onwards)
    - Extra 20% deduction applies from 6th pair onwards (configurable threshold)
    - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
      * Pre-activation members (1st and 2nd) are excluded, 3rd member (activation trigger) and all subsequent members are included


52. LIST BINARY EARNINGS
    Method: GET
    URL: /api/binary/earnings/
    Authentication: Required
    Description: List binary earnings history
    
    Response (200 OK):
    {
      "count": 10,
      "results": [
        {
          "id": 1,
          "user": 1,
          "binary_pair": 1,
          "amount": "2000.00",  // Gross commission amount
          "pair_number": 1,
          "emi_deducted": "0.00",
          "net_amount": "2000.00",  // Net amount after TDS (if applicable)
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }
    
    Business Rules:
    - Binary commission only activates after user has 3 total descendants (configurable threshold)
    - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
      * Pre-activation members (1st and 2nd members) are EXCLUDED from pairing
      * Member that triggered activation (3rd member) is INCLUDED in pairing
      * All members added after activation are INCLUDED in pairing
    - Commission amount is configurable via Platform Settings (default: ₹2000 per pair)
    - 20% TDS is applied on ALL binary pair commissions (1st pair onwards, configurable percentage)
    - Extra 20% deduction applies from 6th pair onwards (configurable threshold, default: 5 pairs)
    - Daily pair limit: Maximum 10 pairs per day (configurable, default: 10 pairs = ₹20,000 before deductions)
    - Pairs 1-5: ₹2000 - 20% TDS = ₹1600 credited
    - Pairs 6+: ₹2000 - 20% TDS - 20% extra = ₹1200 credited (extra deducted from booking balance)
    - TDS and extra deduction are deducted from user's oldest active booking remaining amount
    - If no active booking exists, TDS is still recorded but not deducted from any booking
    - After 10 pairs in a day: SHORT leg (fewer remaining members) is ignored, LONG leg (more remaining) is carried forward to next day
    - Carry-forward: Next day, new members on ignored side match with carried-forward members from long leg


53. GET FULL TREE STRUCTURE
    Method: GET
    URL: /api/binary/nodes/tree_structure/
    Authentication: Required
    Description: Get full binary tree structure with all children (recursive tree view). Supports pagination and filtering by side.
    
    Query Parameters:
    - side: Filter by side ("left", "right", "both") - default: "both"
      * "left": Returns only left side members and left_child (excludes right_side_members and right_child)
      * "right": Returns only right side members and right_child (excludes left_side_members and left_child)
      * "both": Returns both sides (default behavior)
    - page: Page number for side members pagination (default: 1, optional)
      * If not provided, returns all members (backward compatibility)
      * Only applies to left_side_members and right_side_members arrays
    - page_size: Items per page for side members (default: 20, max: 100, optional)
      * If not provided, returns all members (backward compatibility)
      * Only applies to left_side_members and right_side_members arrays
    - min_depth: Minimum depth to include (default: 0, optional)
      * Filters members based on their depth level in the tree
    - max_depth: Maximum depth to traverse (default: 5, optional)
      * Limits how deep the tree is traversed (prevents excessive recursion)
    
    Example Requests:
    GET /api/binary/nodes/tree_structure/
    GET /api/binary/nodes/tree_structure/?side=left
    GET /api/binary/nodes/tree_structure/?side=right
    GET /api/binary/nodes/tree_structure/?page=1&page_size=20
    GET /api/binary/nodes/tree_structure/?side=left&page=1&page_size=10
    GET /api/binary/nodes/tree_structure/?min_depth=1&max_depth=3
    GET /api/binary/nodes/tree_structure/?side=left&page=2&page_size=20&max_depth=5
    
    Response (200 OK):
    {
      "id": 1,
      "user_id": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "user_mobile": "+919876543210",
      "user_first_name": "John",
      "user_last_name": "Doe",
      "user_city": "Mumbai",
      "user_state": "Maharashtra",
      "is_distributor": true,
      "is_active_buyer": true,
      "referral_code": "REF00001",
      "date_joined": "2026-01-06T12:00:00Z",
      "wallet_balance": "15000.00",
      "total_bookings": 5,
      "total_binary_pairs": 10,
      "total_earnings": "20000.00",
      "parent": null,
      "side": null,
      "level": 0,
      "left_count": 5,
      "right_count": 3,
      "binary_commission_activated": true,
      "activation_timestamp": "2026-01-06T12:00:00Z",
      "left_side_members": {
        "count": 50,
        "page": 1,
        "page_size": 20,
        "total_pages": 3,
        "next": "http://localhost:8000/api/binary/nodes/tree_structure/?side=both&page=2&page_size=20",
        "previous": null,
        "results": [
          {
            "node_id": 4,
            "user_id": 4,
            "user_email": "user4@example.com",
            "user_username": "user4@example.com",
            "user_full_name": "Alice Brown",
            "user_mobile": "+919876543212",
            "user_first_name": "Alice",
            "user_last_name": "Brown",
            "user_city": "Bangalore",
            "user_state": "Karnataka",
            "is_distributor": false,
            "is_active_buyer": false,
            "referral_code": "REF00004",
            "date_joined": "2026-01-08T14:00:00Z",
            "wallet_balance": "0.00",
            "total_bookings": 0,
            "total_binary_pairs": 0,
            "total_earnings": "0.00",
            "parent": 2,
            "side": "left",
            "level": 2,
            "left_count": 0,
            "right_count": 0,
            "created_at": "2026-01-08T14:00:00Z",
            "updated_at": "2026-01-08T14:00:00Z"
          }
          // ... more members (up to page_size)
        ]
      },
      // Note: If side="left", right_side_members will be null
      // Note: If pagination not requested, left_side_members and right_side_members return as arrays (backward compatibility)
      "right_side_members": {
        "count": 30,
        "page": 1,
        "page_size": 20,
        "total_pages": 2,
        "next": "http://localhost:8000/api/binary/nodes/tree_structure/?side=both&page=2&page_size=20",
        "previous": null,
        "results": [
          {
            "node_id": 6,
            "user_id": 6,
            "user_email": "user6@example.com",
            "user_username": "user6@example.com",
            "user_full_name": "David Lee",
            "user_mobile": "+919876543215",
            "user_first_name": "David",
            "user_last_name": "Lee",
            "user_city": "Hyderabad",
            "user_state": "Telangana",
            "is_distributor": false,
            "is_active_buyer": false,
            "referral_code": "REF00006",
            "date_joined": "2026-01-10T11:00:00Z",
            "wallet_balance": "0.00",
            "total_bookings": 0,
            "total_binary_pairs": 0,
            "total_earnings": "0.00",
            "parent": 3,
            "side": "left",
            "level": 2,
            "left_count": 0,
            "right_count": 0,
            "created_at": "2026-01-10T11:00:00Z",
            "updated_at": "2026-01-10T11:00:00Z"
          }
          // ... more members (up to page_size)
        ]
      },
      "left_child": {
        "id": 2,
        "user_id": 2,
        "user_email": "user2@example.com",
        "user_username": "user2@example.com",
        "user_full_name": "Jane Smith",
        "user_mobile": "+919876543211",
        "user_first_name": "Jane",
        "user_last_name": "Smith",
        "user_city": "Delhi",
        "user_state": "Delhi",
        "is_distributor": false,
        "is_active_buyer": true,
        "referral_code": "REF00002",
        "date_joined": "2026-01-07T10:00:00Z",
        "wallet_balance": "5000.00",
        "total_bookings": 2,
        "total_binary_pairs": 3,
        "total_earnings": "8000.00",
        "parent": 1,
        "side": "left",
        "level": 1,
        "left_count": 2,
        "right_count": 1,
        "left_child": {
          "id": 4,
          "user_id": 4,
          "user_email": "user4@example.com",
          "user_username": "user4@example.com",
          "user_full_name": "Alice Brown",
          "user_mobile": "+919876543212",
          "user_first_name": "Alice",
          "user_last_name": "Brown",
          "user_city": "Bangalore",
          "user_state": "Karnataka",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00004",
          "date_joined": "2026-01-08T14:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 2,
          "side": "left",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-08T14:00:00Z",
          "updated_at": "2026-01-08T14:00:00Z"
        },
        "right_child": {
          "id": 5,
          "user_id": 5,
          "user_email": "user5@example.com",
          "user_username": "user5@example.com",
          "user_full_name": "Charlie Wilson",
          "user_mobile": "+919876543213",
          "user_first_name": "Charlie",
          "user_last_name": "Wilson",
          "user_city": "Chennai",
          "user_state": "Tamil Nadu",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00005",
          "date_joined": "2026-01-09T09:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 2,
          "side": "right",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-09T09:00:00Z",
          "updated_at": "2026-01-09T09:00:00Z"
        },
        "created_at": "2026-01-07T10:00:00Z",
        "updated_at": "2026-01-07T10:00:00Z"
      },
      "right_child": {
        "id": 3,
        "user_id": 3,
        "user_email": "user3@example.com",
        "user_username": "user3@example.com",
        "user_full_name": "Bob Johnson",
        "user_mobile": "+919876543214",
        "user_first_name": "Bob",
        "user_last_name": "Johnson",
        "user_city": "Pune",
        "user_state": "Maharashtra",
        "is_distributor": false,
        "is_active_buyer": true,
        "referral_code": "REF00003",
        "date_joined": "2026-01-07T15:00:00Z",
        "wallet_balance": "3000.00",
        "total_bookings": 1,
        "total_binary_pairs": 2,
        "total_earnings": "5000.00",
        "parent": 1,
        "side": "right",
        "level": 1,
        "left_count": 1,
        "right_count": 2,
        "left_child": {
          "id": 6,
          "user_id": 6,
          "user_email": "user6@example.com",
          "user_username": "user6@example.com",
          "user_full_name": "David Lee",
          "user_mobile": "+919876543215",
          "user_first_name": "David",
          "user_last_name": "Lee",
          "user_city": "Hyderabad",
          "user_state": "Telangana",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00006",
          "date_joined": "2026-01-10T11:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 3,
          "side": "left",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-10T11:00:00Z",
          "updated_at": "2026-01-10T11:00:00Z"
        },
        "right_child": {
          "id": 7,
          "user_id": 7,
          "user_email": "user7@example.com",
          "user_username": "user7@example.com",
          "user_full_name": "Emma Davis",
          "user_mobile": "+919876543216",
          "user_first_name": "Emma",
          "user_last_name": "Davis",
          "user_city": "Kolkata",
          "user_state": "West Bengal",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00007",
          "date_joined": "2026-01-11T08:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 3,
          "side": "right",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-11T08:00:00Z",
          "updated_at": "2026-01-11T08:00:00Z"
        },
        "created_at": "2026-01-07T15:00:00Z",
        "updated_at": "2026-01-07T15:00:00Z"
      },
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (404):
    {
      "message": "No binary node found"
    }
    
    Error Response (400):
    {
      "error": "Invalid max_depth parameter"
    }
    
    Response when filtering by left side only (side=left):
    {
      // ... root node fields ...
      "left_child": { ... },  // Included
      "right_child": null,     // Excluded when side="left"
      "left_side_members": { ... },  // Paginated structure
      "right_side_members": null,    // Excluded when side="left"
      "pending_users": [ ... ]
    }
    
    Response when filtering by right side only (side=right):
    {
      // ... root node fields ...
      "left_child": null,      // Excluded when side="right"
      "right_child": { ... },  // Included
      "left_side_members": null,     // Excluded when side="right"
      "right_side_members": { ... }, // Paginated structure
      "pending_users": [ ... ]
    }
    
    Response without pagination (backward compatibility):
    {
      // ... root node fields ...
      "left_side_members": [ ... ],  // Array (not paginated)
      "right_side_members": [ ... ], // Array (not paginated)
      "pending_users": [ ... ]
    }
    
    Notes:
    - Returns recursive tree structure with all child nodes
    - Root node is always included regardless of filters
    - Direct children (left_child, right_child) are conditionally included based on side filter
    - Side filtering: When side="left", right_side_members and right_child are excluded (set to null)
    - Side filtering: When side="right", left_side_members and left_child are excluded (set to null)
    - Pagination: Only applies to left_side_members and right_side_members arrays
    - Pagination: If page and page_size are not provided, returns all members as arrays (backward compatibility)
    - Pagination: When pagination is requested, side_members return as objects with count, page, page_size, total_pages, next, previous, and results
    - Depth filtering: min_depth and max_depth filter members based on their level in the tree
    - max_depth parameter limits how deep the tree is traversed (prevents excessive recursion)
    - Only tree owner can view their own tree structure
    - Each node includes comprehensive member details:
      * Basic Info: user_id, user_email, user_username, user_full_name, user_mobile
      * Personal Details: user_first_name, user_last_name, user_city, user_state
      * Status: is_distributor, is_active_buyer, referral_code, date_joined
      * Financial: wallet_balance, total_earnings
      * Activity: total_bookings, total_binary_pairs
      * Tree Position: parent, side, level, left_count, right_count
      * Binary Commission: binary_commission_activated, activation_timestamp (timestamp when activation occurred)
      * Children: left_child, right_child (recursive structure)
      * Side Members: left_side_members, right_side_members (paginated or flat lists of all members on each side)
    - Pair Matching Eligibility: Only members created at or after activation_timestamp are eligible for pairing
      * Pre-activation members (1st and 2nd) are excluded, 3rd member (activation trigger) and all subsequent members are included
    - left_side_members: Paginated object or array containing all members on the left side with full details (all levels)
    - right_side_members: Paginated object or array containing all members on the right side with full details (all levels)
    - left_child/right_child: Recursive tree structure showing parent-child relationships (conditionally included based on side filter)
    - left_side_members/right_side_members: Paginated objects or flat lists showing all members on each side for easy access
    - All member details are included for each node in the tree (both left and right sides, unless filtered)
    - Wallet balance and earnings are returned as strings with 2 decimal places
    - If user doesn't have a wallet, balance and earnings default to "0.00"
    - Backward Compatibility: Existing API calls without new parameters work exactly as before (returns all members as arrays)


54. MANUALLY PLACE USER IN TREE
    Method: POST
    URL: /api/binary/nodes/place_user/
    Authentication: Required
    Description: Manually place a user in a specific position in the binary tree. Only the tree owner (referrer) can place users who used their referral code.
    
    Request Body:
    {
      "target_user_id": 8,
      "parent_node_id": 5,
      "side": "left",  // "left" or "right"
      "allow_replacement": false  // Optional, default: false
    }
    
    Response (201 Created):
    {
      "id": 10,
      "user": 8,
      "user_email": "user8@example.com",
      "parent": 5,
      "parent_username": "user5@example.com",
      "side": "left",
      "level": 2,
      "left_count": 0,
      "right_count": 0,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "target_user_id, parent_node_id, and side are required"
    }
    OR
    {
      "error": "side must be 'left' or 'right'"
    }
    OR
    {
      "error": "Position left under parent node 5 is already occupied"
    }
    
    Error Response (403):
    {
      "error": "You can only place users in your own binary tree"
    }
    OR
    {
      "error": "This user did not use your referral code and cannot be placed in your tree"
    }
    
    Error Response (404):
    {
      "error": "Target user not found"
    }
    OR
    {
      "error": "Parent node not found"
    }
    
    Notes:
    - IMPORTANT: User must have at least one successful payment before placement
    - If user has no successful payment, placement fails with error message
    - Only the tree owner (referrer) can place users in their tree
    - Target user must have used referrer's referral code (checked via user.referred_by or booking.referred_by)
    - If user already has a node, it will be moved to the new position
    - If position is occupied and allow_replacement=false, returns error
    - Parent node must belong to referrer's tree
    - Automatically updates parent counts after placement
    - Commission is automatically paid when placement succeeds (if user has successful payment)
    - Response includes 'commission_paid' field indicating if commission was paid


55. MOVE DIRECT CHILD IN TREE
    Method: POST
    URL: /api/binary/nodes/move_user/
    Authentication: Required
    Description: Move a direct child to a different side (left or right) under the same parent. Only allows moving direct children (not descendants). Only the tree owner can move their direct children.
    
    Request Body:
    {
      "node_id": 10,
      "new_side": "right"  // "left" or "right"
    }
    
    Response (200 OK):
    {
      "id": 10,
      "user": 8,
      "user_email": "user8@example.com",
      "parent": 5,
      "parent_username": "user5@example.com",
      "side": "right",
      "level": 2,
      "left_count": 0,
      "right_count": 0,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "node_id and new_side are required"
    }
    OR
    {
      "error": "new_side must be 'left' or 'right'"
    }
    OR
    {
      "error": "You can only move your direct children. This user is not a direct child."
    }
    OR
    {
      "error": "User is already on the right side"
    }
    OR
    {
      "error": "Right side is already occupied"
    }
    
    Error Response (403):
    {
      "error": "You can only move users in your own binary tree"
    }
    
    Error Response (404):
    {
      "error": "Node not found"
    }
    OR
    {
      "error": "No binary node found for current user"
    }
    
    Notes:
    - Only the tree owner can move users in their tree
    - Only allows moving DIRECT CHILDREN (users directly under current user's node)
    - Cannot move descendants (only immediate children)
    - New side must be available (not already occupied)
    - Cannot move to the same side (must be different)
    - Automatically updates parent's left_count and right_count


56. LIST AVAILABLE POSITIONS
    Method: GET
    URL: /api/binary/nodes/available_positions/
    Authentication: Required
    Description: List available positions in the current user's binary tree (nodes with open left or right slots)
    
    Response (200 OK):
    {
      "count": 5,
      "available_positions": [
        {
          "node_id": 1,
          "user_id": 1,
          "user_email": "user@example.com",
          "user_username": "user@example.com",
          "user_full_name": "John Doe",
          "referral_code": "REF00001",
          "referral_code_used": null,
          "level": 0,
          "left_available": true,
          "right_available": false,
          "left_count": 0,
          "right_count": 3
        },
        {
          "node_id": 5,
          "user_id": 5,
          "user_email": "user5@example.com",
          "user_username": "user5@example.com",
          "user_full_name": "Jane Smith",
          "referral_code": "REF00005",
          "referral_code_used": "REF00001",
          "level": 1,
          "left_available": false,
          "right_available": true,
          "left_count": 2,
          "right_count": 0
        }
      ]
    }
    
    Error Response (404):
    {
      "message": "No binary node found"
    }
    
    Notes:
    - Returns all nodes in the tree that have at least one available slot (left or right)
    - Each position includes basic user information: full name, email, and referral code
    - Helps UI show where users can be placed with complete parent node information
    - Only tree owner can view available positions in their tree
    - Fields included:
      * node_id: Binary tree node ID (use this for parent_node_id when placing users)
      * user_id: User ID of the node owner
      * user_email: Email address of the node owner
      * user_username: Username of the node owner
      * user_full_name: Full name of the node owner (first_name + last_name)
      * referral_code: Referral code of the node owner
      * referral_code_used: Referral code that was used by this user when joining (null if none used)
      * level: Depth level in the tree (0 = root)
      * left_available: Boolean indicating if left child slot is available
      * right_available: Boolean indicating if right child slot is available
      * left_count: Total descendants on the left side
      * right_count: Total descendants on the right side


57. LIST PENDING USERS
    Method: GET
    URL: /api/binary/nodes/pending_users/
    Authentication: Required
    Description: List users who used referrer's code but are not yet placed in the tree or are placed but not in referrer's tree
    
    Response (200 OK):
    {
      "count": 3,
      "pending_users": [
        {
          "user_id": 8,
          "user_email": "user8@example.com",
          "user_username": "user8@example.com",
          "user_full_name": "John Doe",
          "has_node": false,
          "node_id": null,
          "in_tree": false
        },
        {
          "user_id": 9,
          "user_email": "user9@example.com",
          "user_username": "user9@example.com",
          "user_full_name": "Jane Smith",
          "has_node": true,
          "node_id": 15,
          "in_tree": false
        }
      ]
    }
    
    Notes:
    - Returns users who:
      * Have referred_by = current user, OR
      * Have bookings with referred_by = current user
    - Includes users who don't have a binary node yet
    - Includes users who have a node but are not in referrer's tree
    - Excludes users who are already placed in referrer's tree
    - Helps referrer identify which users need to be placed manually


57. AUTO PLACE PENDING USERS
    Method: POST
    URL: /api/binary/nodes/auto_place_pending/
    Authentication: Required
    Description: Automatically place pending users in the binary tree using the left-priority placement algorithm. Can place all pending users or a specific user. This is the recommended way to place users automatically after they create bookings with your referral code.
    
    Request Body (all optional):
    {
      "target_user_id": 8,  // Optional: Place specific user only. If omitted, places all pending users
      "referring_user_id": 5  // Optional: Override referring user (uses actual referrer from booking/user by default)
    }
    
    Response (200 OK):
    {
      "placed_count": 3,
      "failed_count": 0,
      "placed_users": [
        {
          "user_id": 8,
          "user_email": "user8@example.com",
          "user_full_name": "John Doe",
          "node_id": 10,
          "parent_node_id": 5,
          "parent_email": "referrer@example.com",
          "side": "left",
          "level": 2
        },
        {
          "user_id": 9,
          "user_email": "user9@example.com",
          "user_full_name": "Jane Smith",
          "node_id": 11,
          "parent_node_id": 5,
          "parent_email": "referrer@example.com",
          "side": "right",
          "level": 2
        }
      ],
      "failed_users": []
    }
    
    Response when no pending users (200 OK):
    {
      "placed_count": 0,
      "failed_count": 0,
      "placed_users": [],
      "failed_users": [],
      "message": "No pending users found"
    }
    
    Error Response (400):
    {
      "error": "Invalid target_user_id"
    }
    
    Error Response (404):
    {
      "error": "User 8 not found or did not use your referral code"
    }
    
    Notes:
    - IMPORTANT: User must have at least one successful payment before placement
    - If user has no successful payment, placement fails with error message
    - Automatically places pending users using the left-priority placement algorithm
    - Placement Rules:
      1. First 2 direct referrals: 1st user → LEFT, 2nd user → RIGHT
      2. From 3rd referral onward: Follow LEFT-side chain (traverse left children to find left-most available position)
      3. Referral-based override: If user used a specific parent's code, place in that parent's tree
      4. Default placement side is configurable via Platform Settings (binary_tree_default_placement_side)
    - If no parameters provided: Places ALL pending users who used referrer's code (and have successful payment)
    - If target_user_id provided: Places only that specific user (must have used referrer's code and have successful payment)
    - Users already in referrer's tree are skipped (not placed again)
    - Commission is automatically paid when placement succeeds (if user has successful payment)
    - Recommended workflow:
      1. User creates booking with referral code → No automatic placement
      2. User makes payment → Payment must be completed (status='completed')
      3. Referrer calls this API → Users are placed automatically using left-priority algorithm
      4. Commission is paid immediately upon successful placement
    - Returns both successfully placed users and failed placements (with error messages)
    - Only tree owner can place users in their tree
    - Response includes 'commission_paid' field indicating if commission was paid


58. SWAP DIRECT CHILDREN
    Method: POST
    URL: /api/binary/nodes/swap_direct_children/
    Authentication: Required
    Description: Swap left and right direct children of current user's node. Only tree owner can swap their direct children. Preserves all descendant nodes (they move with their parent).
    
    Request Body: None (uses current user's node)
    
    Response (200 OK):
    {
      "id": 5,
      "user": 1,
      "user_email": "user1@example.com",
      "parent": null,
      "parent_username": null,
      "side": null,
      "level": 0,
      "left_count": 8,
      "right_count": 5,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:15:00Z"
    }
    
    Error Response (400):
    {
      "error": "Both left and right children must exist to swap"
    }
    
    Error Response (404):
    {
      "error": "No binary node found for current user"
    }
    
    Notes:
    - Swaps the side assignment of left and right direct children
    - Both children must exist to perform swap
    - All descendant nodes move with their parent (entire subtree swaps)
    - Automatically updates parent's left_count and right_count (swapped)
    - Only tree owner can swap their direct children


58. CHOOSE SIDE FOR DIRECT REFERRAL
    Method: POST
    URL: /api/binary/nodes/choose_side_for_direct_referral/
    Authentication: Required
    Description: Pre-select side (left or right) for an upcoming direct referral. Parent can choose left/right for their direct referrals. Only works for users who haven't been placed yet or are not in referrer's tree.
    
    Request Body:
    {
      "target_user_id": 8,
      "side": "left"  // "left" or "right"
    }
    
    Response (201 Created):
    {
      "id": 10,
      "user": 8,
      "user_email": "user8@example.com",
      "parent": 5,
      "parent_username": "user5@example.com",
      "side": "left",
      "level": 2,
      "left_count": 0,
      "right_count": 0,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "target_user_id and side are required"
    }
    OR
    {
      "error": "side must be 'left' or 'right'"
    }
    OR
    {
      "error": "User is already placed in your tree"
    }
    OR
    {
      "error": "Left side is already occupied"
    }
    
    Error Response (403):
    {
      "error": "This user did not use your referral code"
    }
    
    Error Response (404):
    {
      "error": "Target user not found"
    }
    OR
    {
      "error": "No binary node found for current user"
    }
    
    Notes:
    - Parent can pre-select side for their direct referrals
    - Target user must have used referrer's referral code
    - Requested side must be available (not already occupied)
    - Works for users who haven't been placed yet or are placed in another tree
    - If user already has a node but is in another tree, will be moved to referrer's tree
    - Automatically places user on the chosen side
    - Automatically updates parent's left_count or right_count


================================================================================
                            PAYOUT APIs
================================================================================

58. CREATE PAYOUT REQUEST
    Method: POST
    URL: /api/payout/
    Authentication: Required
    Description: Request payout from wallet
    
    Request Body:
    {
      "requested_amount": 10000,
      "bank_name": "State Bank of India",
      "account_number": "1234567890",
      "ifsc_code": "SBIN0001234",
      "account_holder_name": "John Doe",
      "emi_auto_filled": true  // Optional: Auto-fill EMI from payout
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "requested_amount": "10000.00",
      "tds_amount": "500.00",  // 5% TDS (max ₹10,000)
      "net_amount": "9500.00",
      "bank_name": "State Bank of India",
      "status": "pending",
      "emi_auto_filled": true,
      "emi_amount": "2000.00",  // If EMI auto-fill was used
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "requested_amount": ["Insufficient wallet balance"]
    }
    
    TDS Calculation:
    - 5% of requested amount
    - Maximum ₹10,000 ceiling


59. LIST PAYOUTS
    Method: GET
    URL: /api/payout/
    Authentication: Required
    Description: List payout requests (user sees own, admin sees all)
    
    Query Parameters:
    - status: Filter by status (pending, processing, completed, rejected, cancelled)
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "requested_amount": "10000.00",
          "tds_amount": "500.00",
          "net_amount": "9500.00",
          "status": "pending",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


60. PROCESS PAYOUT (Admin Only)
    Method: POST
    URL: /api/payout/{id}/process/
    Authentication: Required (Admin)
    Description: Process payout request (deducts from wallet)
    
    Response (200 OK):
    {
      "id": 1,
      "status": "processing",
      "requested_amount": "10000.00",
      "net_amount": "9500.00",
      ...
    }
    
    Error Response (400):
    {
      "error": "Payout already processed"
    }


61. COMPLETE PAYOUT (Admin Only)
    Method: POST
    URL: /api/payout/{id}/complete/
    Authentication: Required (Admin)
    Description: Mark payout as completed after bank transfer
    
    Request Body:
    {
      "transaction_id": "BANK123456789"
    }
    
    Response (200 OK):
    {
      "id": 1,
      "status": "completed",
      "transaction_id": "BANK123456789",
      "completed_at": "2026-01-06T13:00:00Z",
      ...
    }


62. LIST PAYOUT TRANSACTIONS
    Method: GET
    URL: /api/payout/transactions/
    Authentication: Required
    Description: List payout transaction records
    
    Response (200 OK):
    {
      "count": 10,
      "results": [
        {
          "id": 1,
          "payout_id": 1,
          "user": 1,
          "amount": "10000.00",
          "transaction_type": "payout",
          "description": "Payout request #1",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


================================================================================
                         NOTIFICATION APIs
================================================================================

63. LIST NOTIFICATIONS
    Method: GET
    URL: /api/notifications/
    Authentication: Required
    Description: List user's notifications
    
    Query Parameters:
    - is_read: Filter by read status (true/false)
    - notification_type: Filter by type (booking, payment, wallet, binary, payout, kyc, system)
    
    Response (200 OK):
    {
      "count": 20,
      "results": [
        {
          "id": 1,
          "user": 1,
          "notification_type": "booking",
          "title": "Booking Confirmed",
          "message": "Your booking EVABC1234 has been confirmed",
          "is_read": false,
          "reference_id": 1,
          "reference_type": "booking",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


64. MARK NOTIFICATION AS READ
    Method: POST
    URL: /api/notifications/{id}/mark_read/
    Authentication: Required
    Description: Mark a specific notification as read
    
    Response (200 OK):
    {
      "id": 1,
      "is_read": true,
      "read_at": "2026-01-06T13:00:00Z",
      ...
    }


65. MARK ALL NOTIFICATIONS AS READ
    Method: POST
    URL: /api/notifications/mark_all_read/
    Authentication: Required
    Description: Mark all user's notifications as read
    
    Response (200 OK):
    {
      "message": "All notifications marked as read"
    }


66. GET UNREAD COUNT
    Method: GET
    URL: /api/notifications/unread_count/
    Authentication: Required
    Description: Get count of unread notifications
    
    Response (200 OK):
    {
      "unread_count": 5
    }


================================================================================
                         COMPLIANCE APIs
================================================================================

67. UPLOAD COMPLIANCE DOCUMENT
    Method: POST
    URL: /api/compliance/documents/
    Authentication: Required
    Description: Upload compliance document
    
    Request Body (multipart/form-data):
    {
      "document_type": "tds_certificate",  // "tds_certificate", "pan_card", "aadhaar", "bank_statement", "other"
      "title": "TDS Certificate 2025-26",
      "description": "Annual TDS certificate",
      "file": <file>
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "document_type": "tds_certificate",
      "title": "TDS Certificate 2025-26",
      "is_verified": false,
      "uploaded_at": "2026-01-06T12:00:00Z"
    }


68. LIST COMPLIANCE DOCUMENTS
    Method: GET
    URL: /api/compliance/documents/
    Authentication: Required
    Description: List user's compliance documents
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "document_type": "tds_certificate",
          "title": "TDS Certificate 2025-26",
          "is_verified": true,
          "uploaded_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


79. LIST TDS RECORDS
    Method: GET
    URL: /api/compliance/tds/
    Authentication: Required
    Description: List TDS records for user
    
    Response (200 OK):
    {
      "count": 2,
      "results": [
        {
          "id": 1,
          "user": 1,
          "financial_year": "2025-26",
          "total_payout": "100000.00",
          "tds_deducted": "5000.00",
          "certificate_number": "TDS202526001",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


================================================================================
                            REPORTS APIs
================================================================================

80. DASHBOARD STATISTICS
    Method: GET
    URL: /api/reports/dashboard/
    Authentication: Required
    Description: Get dashboard statistics (different for admin vs user)
    
    Response for User (200 OK):
    {
      "wallet_balance": "15000.00",
      "total_earnings": "20000.00",
      "total_withdrawn": "5000.00",
      "active_bookings": 2,
      "total_bookings": 5,
      "binary_pairs": 10,
      "pending_payouts": 1
    }
    
    Response for Admin (200 OK):
    {
      "total_users": 1000,
      "active_buyers": 500,
      "total_bookings": 2000,
      "total_revenue": "100000000.00",
      "total_wallet_balance": "5000000.00",
      "pending_payouts": 50
    }


81. SALES REPORT (Admin Only)
    Method: GET
    URL: /api/reports/sales/
    Authentication: Required (Admin)
    Description: Get sales report
    
    Query Parameters:
    - start_date: Start date (YYYY-MM-DD)
    - end_date: End date (YYYY-MM-DD)
    
    Response (200 OK):
    {
      "total_sales": "5000000.00",
      "total_transactions": 500,
      "bookings": 200
    }


82. USER REPORT
    Method: GET
    URL: /api/reports/user/
    Authentication: Required
    Description: Get user activity report
    
    Query Parameters (Admin only):
    - user_id: User ID to get report for
    
    Response (200 OK):
    {
      "user": {
        "id": 1,
        "username": "user@example.com",
        "email": "user@example.com",
        "is_active_buyer": true
      },
      "bookings": 5,
      "total_paid": "50000.00",
      "wallet_balance": "15000.00",
      "binary_pairs": 10,
      "payouts": 3
    }


83. WALLET REPORT
    Method: GET
    URL: /api/reports/wallet/
    Authentication: Required
    Description: Get wallet transaction report
    
    Query Parameters:
    - user_id: User ID (admin only)
    - start_date: Start date (YYYY-MM-DD)
    - end_date: End date (YYYY-MM-DD)
    
    Response (200 OK):
    {
      "total_transactions": 50,
      "total_credit": "25000.00",
      "total_debit": "10000.00",
      "by_type": [
        {
          "transaction_type": "BINARY_PAIR",
          "count": 10,
          "total": "5000.00"
        },
        {
          "transaction_type": "REFERRAL_BONUS",
          "count": 5,
          "total": "2500.00"
        }
      ]
    }


84. DISTRIBUTOR DASHBOARD (Distributors Only)
    Method: GET
    URL: /api/reports/distributor-dashboard/
    Authentication: Required (Distributors only)
    Description: Get comprehensive distributor dashboard with team performance, growth trends, sales activity, and commission data. Only accessible to users with is_distributor=True.
    
    Response (200 OK):
    {
      "top_performers": [
        {
          "name": "Amalnath C K",
          "referrals": 3,
          "team": "RSA"
        },
        {
          "name": "Nizamol V K",
          "referrals": 3,
          "team": "RSB"
        },
        {
          "name": "Anupriya Raj",
          "referrals": 2,
          "team": "RSA"
        },
        {
          "name": "Rubina mol k",
          "referrals": 1,
          "team": "RSA"
        },
        {
          "name": "Anamika Soman",
          "referrals": 0,
          "team": "RSA"
        }
      ],
      "team_growth_trend": {
        "months": ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        "counts": [0, 0, 2, 4, 6, 8]
      },
      "team_distribution": {
        "rsa_percentage": 63,
        "rsb_percentage": 38,
        "rsa_count": 5,
        "rsb_count": 3
      },
      "recent_sales_activity": [
        {
          "date": "21 Jan 2026",
          "left_pv": "5000.00",
          "right_pv": "5000.00",
          "matched_pv": "5000.00",
          "commission": "2000.00",
          "net_amount": "1800.00",
          "status": "matched"
        },
        {
          "date": "20 Jan 2026",
          "left_pv": "5000.00",
          "right_pv": "5000.00",
          "matched_pv": "5000.00",
          "commission": "2000.00",
          "net_amount": "1800.00",
          "status": "matched"
        },
        {
          "date": "19 Jan 2026",
          "left_pv": "5000.00",
          "right_pv": "5000.00",
          "matched_pv": "5000.00",
          "commission": "2000.00",
          "net_amount": "1800.00",
          "status": "matched"
        }
      ],
      "commission_trend": {
        "months": ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        "amounts": [9000.0, 9000.0, 9000.0, 9000.0, 9000.0, 9000.0]
      }
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "This endpoint is only available for distributors."
    }
    
    Error Response (404 Not Found):
    {
      "error": "Binary node not found. Please ensure you have a binary tree structure."
    }
    
    Notes:
    - Only users with is_distributor=True can access this endpoint
    - Returns comprehensive analytics for distributors including:
      * Top Performers: Top 5 team members with highest referrals (sorted by referral count)
      * Team Growth Trend: Monthly team member growth for last 6 calendar months
      * Team Distribution: RSA (left) vs RSB (right) distribution as percentages and counts
      * Recent Sales Activity: Last 20 binary pairs with Left PV, Right PV, Matched PV, Commission, Net Amount, and Status
      * Commission Trend: Monthly commission earnings (net_amount) for last 6 calendar months
    - Top Performers:
      * Includes all team members in distributor's binary tree (all descendants)
      * Counts total referrals for each member (direct referrals + booking referrals)
      * Team assignment: RSA for left side, RSB for right side
      * Returns top 5 performers sorted by referral count (descending)
    - Team Growth Trend:
      * Groups team members by month of creation (using BinaryNode created_at)
      * Returns data for last 6 calendar months
      * Handles year rollover correctly
    - Team Distribution:
      * Calculates RSA (left) vs RSB (right) percentages from BinaryNode counts
      * Updates counts before calculation for accuracy
      * Returns percentages and absolute counts
    - Recent Sales Activity:
      * Gets last 20 binary pairs for distributor
      * Left PV: Sum of completed payment amounts for left_user (or booking amount fallback)
      * Right PV: Sum of completed payment amounts for right_user (or booking amount fallback)
      * Matched PV: Minimum of Left PV and Right PV, or pair_amount from BinaryPair
      * Commission: pair_amount or earning_amount from BinaryPair
      * Net Amount: net_amount from BinaryEarning
      * Status: status from BinaryPair (matched, pending, processed)
      * Date: Formatted as "DD MMM YYYY" (e.g., "21 Jan 2026")
    - Commission Trend:
      * Groups BinaryEarning records by month (from created_at)
      * Sums net_amount per month for last 6 calendar months
      * Returns formatted data for bar chart visualization
    - PV (Point Value) Calculation:
      * Left PV: Sum of completed payment amounts for left_user, or booking amount if no payments
      * Right PV: Sum of completed payment amounts for right_user, or booking amount if no payments
      * Matched PV: Minimum of Left PV and Right PV, or pair_amount if available
    - Requires binary node to exist (returns 404 if not found)
    - All monetary values are returned as strings with 2 decimal places
    - Month names are abbreviated (Jan, Feb, Mar, etc.)
    - Team assignment (RSA/RSB) is based on user's side in BinaryNode relative to distributor's tree


85. ADMIN DASHBOARD (Admin/Staff Only)
    Method: GET
    URL: /api/reports/admin-dashboard/
    Authentication: Required (Admin or Staff)
    Description: Get comprehensive admin dashboard with all business intelligence metrics including KPIs, charts, sales funnel, conversion rates, buyer segments, and staff performance. Only accessible to admin and staff roles.
    
    Response (200 OK):
    {
      "kpi_cards": {
        "active_buyers": {
          "value": 8450,
          "change": 8.5,
          "trend": "up"
        },
        "total_visitors": {
          "value": 10000,
          "change": 8.2,
          "trend": "up"
        },
        "pre_booked": {
          "value": 1250,
          "conversion": 12.5
        },
        "paid_orders": {
          "value": 850,
          "conversion": 68.0
        },
        "delivered": {
          "value": 720,
          "conversion": 84.7
        }
      },
      "booking_trends": {
        "months": ["Jan", "Feb", "Mar", "Apr"],
        "bookings": [120, 180, 240, 300],
        "growth": 15.2
      },
      "payment_distribution": {
        "full_payment": {
          "count": 450,
          "percentage": 45.0
        },
        "emi": {
          "count": 300,
          "percentage": 30.0
        },
        "wallet": {
          "count": 150,
          "percentage": 15.0
        },
        "mixed": {
          "count": 100,
          "percentage": 10.0
        }
      },
      "staff_performance": [
        {
          "name": "Rahul",
          "achievement": 85
        },
        {
          "name": "Priya",
          "achievement": 92
        },
        {
          "name": "Amit",
          "achievement": 78
        },
        {
          "name": "Sneha",
          "achievement": 88
        },
        {
          "name": "Vikram",
          "achievement": 68
        }
      ],
      "buyer_growth_trend": {
        "months": ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
        "active_buyers": [3000, 3500, 4000, 4500, 5000, 5500],
        "total_buyers": [7000, 7500, 8000, 8500, 9000, 9500]
      },
      "buyer_segments": {
        "active_buyers": 6100,
        "inactive": 2650,
        "pre_booked": 1250,
        "new_this_month": 950
      },
      "sales_funnel": [
        {
          "stage": "Visitors",
          "count": 10000,
          "percentage": 100.0,
          "drop_off": null
        },
        {
          "stage": "Interested",
          "count": 3500,
          "percentage": 35.0,
          "drop_off": 65.0
        },
        {
          "stage": "Pre-Booked",
          "count": 1250,
          "percentage": 12.5,
          "drop_off": 64.3
        },
        {
          "stage": "Paid",
          "count": 850,
          "percentage": 8.5,
          "drop_off": 32.0
        },
        {
          "stage": "Delivered",
          "count": 720,
          "percentage": 7.2,
          "drop_off": 15.3
        }
      ],
      "conversion_rates": [
        {
          "from": "Visitors",
          "to": "Interested",
          "rate": 35.0,
          "change": 2.5,
          "trend": "up",
          "converted_count": 3500
        },
        {
          "from": "Interested",
          "to": "Pre-Booked",
          "rate": 35.7,
          "change": 1.2,
          "trend": "down",
          "converted_count": 1250
        },
        {
          "from": "Pre-Booked",
          "to": "Paid",
          "rate": 68.0,
          "change": 3.8,
          "trend": "up",
          "converted_count": 850
        },
        {
          "from": "Paid",
          "to": "Delivered",
          "rate": 84.7,
          "change": 0.5,
          "trend": "up",
          "converted_count": 720
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "This endpoint is only available for admin and staff users."
    }
    
    Notes:
    - Only Admin and Staff roles can access this endpoint
    - Returns comprehensive dashboard data including:
      * KPI Cards: Active Buyers, Total Visitors, Pre-Booked, Paid Orders, Delivered with percentage changes and conversion rates
      * Booking Trends: Monthly booking data for last 4 months with growth percentage
      * Payment Distribution: Breakdown by payment type (Full Payment, EMI, Wallet, Mixed) with counts and percentages
      * Staff Performance: Achievement percentages for all staff members based on bookings processed
      * Buyer Growth Trend: Cumulative active buyers and total buyers over last 6 months
      * Buyer Segments: Distribution of buyer categories (Active, Inactive, Pre-Booked, New This Month)
      * Sales Funnel: 5-stage funnel (Visitors → Interested → Pre-Booked → Paid → Delivered) with drop-off percentages
      * Conversion Rates: Stage-to-stage conversion rates with trend indicators (up/down) and percentage changes
    - KPI Cards:
      * Active Buyers: Count of users with is_active_buyer=True, with percentage change vs last month
      * Total Visitors: Total registered users count, with percentage change vs last month
      * Pre-Booked: Bookings with status='pending', with conversion rate from total visitors
      * Paid Orders: Bookings with completed payments, with conversion rate from pre-booked
      * Delivered: Bookings with status='completed', with conversion rate from paid orders
    - Booking Trends:
      * Returns monthly booking counts for last 4 months
      * Growth percentage calculated as ((current_month - previous_month) / previous_month) * 100
      * Month names are abbreviated (Jan, Feb, Mar, etc.)
    - Payment Distribution:
      * Full Payment: Bookings with payment_option='full_payment' and single payment method (not wallet)
      * EMI: Bookings with payment_option='emi_options' (excluding wallet-only)
      * Wallet: Payments made using wallet payment method
      * Mixed: Bookings with multiple different payment methods
      * Percentages are calculated from total bookings with completed payments
    - Staff Performance:
      * Calculates achievement percentage based on bookings processed per staff member
      * Uses default target of 100 bookings per month (can be adjusted)
      * Returns staff members sorted by achievement (descending)
      * Note: Since there's no direct staff assignment tracking, performance is calculated based on total bookings divided among staff
    - Buyer Growth Trend:
      * Returns cumulative counts at end of each month (not new users per month)
      * Active Buyers: Cumulative count of users with is_active_buyer=True at end of each month
      * Total Buyers: Cumulative count of all users at end of each month
      * Returns data for last 6 calendar months
    - Buyer Segments:
      * Active Buyers: Users with is_active_buyer=True
      * Inactive: Users who are not active buyers (is_active_buyer=False, role='user')
      * Pre-Booked: Users with pending bookings (bookings__status='pending')
      * New This Month: Users who joined in the current month
    - Sales Funnel:
      * Visitors: Total registered users
      * Interested: Users with bookings (pre-booked status)
      * Pre-Booked: Same as Interested (users with pending bookings)
      * Paid: Users with completed payments (bookings__payments__status='completed')
      * Delivered: Users with completed bookings (bookings__status='completed')
      * Drop-off percentages calculated between consecutive stages
      * Percentages are relative to total visitors (100%)
    - Conversion Rates:
      * Visitors → Interested: Percentage of visitors who created bookings
      * Interested → Pre-Booked: Percentage of interested users who pre-booked (same as interested in this implementation)
      * Pre-Booked → Paid: Percentage of pre-booked users who made payments
      * Paid → Delivered: Percentage of paid users who received delivery
      * Change: Percentage point change vs previous period
      * Trend: "up" if change >= 0, "down" if change < 0
      * Converted Count: Number of users converted at each stage
    - All monetary values and counts are returned as numbers (not strings)
    - Percentage values are rounded to 1 decimal place
    - Month names are abbreviated (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec)
    - Date calculations use current month and previous month for comparisons
    - Empty data scenarios are handled gracefully (returns 0 or empty arrays)


================================================================================
                         PLATFORM SETTINGS APIs
================================================================================

86. GET PLATFORM SETTINGS
   Method: GET
   URL: /api/settings/
   Authentication: Required (All authenticated users)
   Description: Get current platform settings
   
   Response (200 OK):
   {
     "id": 1,
     "booking_reservation_timeout_minutes": 1440,  // 24 hours in minutes, null = never expires
     "direct_user_commission_amount": "1000.00",  // Commission per direct user before activation (default: ₹1000)
     "binary_commission_activation_count": 3,  // Number of direct users needed to activate binary commission (default: 3)
     "binary_pair_commission_amount": "2000.00",  // Commission per binary pair after activation (default: ₹2000)
     "binary_tds_threshold_pairs": 5,  // Number of pairs after activation before extra deduction starts (default: 5)
     "binary_commission_tds_percentage": "20.00",  // TDS percentage on ALL binary commissions (default: 20%)
     "binary_extra_deduction_percentage": "20.00",  // Extra deduction percentage on 6th+ pairs (default: 20%)
     "binary_daily_pair_limit": 10,  // Maximum binary pairs per day after activation (default: 10 pairs = ₹20,000)
     "binary_tree_default_placement_side": "left",  // Default placement side for binary tree: "left" or "right" (default: "left")
     "updated_at": "2026-01-14T09:00:00Z",
     "updated_by": 1,
     "updated_by_username": "admin@example.com",
     "updated_by_email": "admin@example.com"
   }
   
   Note:
   - Returns singleton settings instance
   - All authenticated users can view settings
   - booking_reservation_timeout_minutes: Integer (minutes) or null (never expires)
   - All binary commission settings are configurable via UPDATE PLATFORM SETTINGS endpoint
   - binary_commission_tds_percentage: Applied to ALL commissions (direct user and pairs)
   - binary_extra_deduction_percentage: Additional deduction for 6th+ pairs (in addition to TDS)
   - binary_daily_pair_limit: Maximum pairs per day (resets at midnight)


87. UPDATE PLATFORM SETTINGS (Admin Only)
   Method: PATCH
   URL: /api/settings/
   Authentication: Required (Admin or Superuser only)
   Description: Update platform settings. Only admin/superuser can modify settings.
   
   Request Body (all fields optional - partial update supported):
   {
     "booking_reservation_timeout_minutes": 1440,  // Integer (minutes) or null (never expires)
     "direct_user_commission_amount": 1000,  // Commission per direct user before activation (default: ₹1000)
     "binary_commission_activation_count": 3,  // Number of direct users needed to activate binary commission (default: 3, min: 1)
     "binary_pair_commission_amount": 2000,  // Commission per binary pair after activation (default: ₹2000)
     "binary_tds_threshold_pairs": 5,  // Number of pairs after activation before extra deduction starts (default: 5, min: 0)
     "binary_commission_tds_percentage": 20,  // TDS percentage on ALL binary commissions (default: 20%, range: 0-100)
     "binary_extra_deduction_percentage": 20,  // Extra deduction percentage on 6th+ pairs (default: 20%, range: 0-100)
     "binary_daily_pair_limit": 10,  // Maximum binary pairs per day after activation (default: 10, min: 1)
     "binary_tree_default_placement_side": "left"  // Default placement side: "left" or "right" (default: "left")
   }
   
   Response (200 OK):
   {
     "id": 1,
     "booking_reservation_timeout_minutes": 1440,
     "direct_user_commission_amount": "1000.00",
     "binary_commission_activation_count": 3,
     "binary_pair_commission_amount": "2000.00",
     "binary_tds_threshold_pairs": 5,
     "binary_commission_tds_percentage": "20.00",
     "binary_extra_deduction_percentage": "20.00",
     "binary_daily_pair_limit": 10,
     "binary_tree_default_placement_side": "left",
     "updated_at": "2026-01-14T09:15:00Z",
     "updated_by": 1,
     "updated_by_username": "admin@example.com",
     "updated_by_email": "admin@example.com"
   }
   
   Error Response (400):
   {
     "booking_reservation_timeout_minutes": ["booking_reservation_timeout_minutes must be at least 1 minute or null (never expires)"],
     "direct_user_commission_amount": ["direct_user_commission_amount must be non-negative"],
     "binary_commission_activation_count": ["binary_commission_activation_count must be at least 1"],
     "binary_pair_commission_amount": ["binary_pair_commission_amount must be non-negative"],
     "binary_tds_threshold_pairs": ["binary_tds_threshold_pairs must be non-negative"],
     "binary_commission_tds_percentage": ["binary_commission_tds_percentage must be between 0 and 100"],
     "binary_extra_deduction_percentage": ["binary_extra_deduction_percentage must be between 0 and 100"],
     "binary_daily_pair_limit": ["binary_daily_pair_limit must be at least 1"]
   }
   
   Error Response (403):
   {
     "detail": "Only admin or superuser can update platform settings."
   }
   
   Notes:
   - Only admin or superuser can update settings
   - All fields are optional (partial update supported)
   - booking_reservation_timeout_minutes: Minimum value is 1 minute, or null for never expires
   - direct_user_commission_amount: Commission paid per direct user added before binary commission activation
   - binary_commission_activation_count: Number of direct children needed to activate binary commission (default: 3)
   - binary_pair_commission_amount: Commission paid per binary pair after activation (default: ₹2000)
   - binary_tds_threshold_pairs: Number of pairs after activation before extra deduction applies (default: 5)
   - binary_commission_tds_percentage: TDS percentage applied to ALL binary commissions - direct user and pairs (default: 20%, range: 0-100)
   - binary_extra_deduction_percentage: Extra deduction percentage for 6th+ pairs in addition to TDS (default: 20%, range: 0-100)
   - binary_daily_pair_limit: Maximum binary pairs per day after activation (default: 10 pairs = ₹20,000 before deductions)
   - binary_tree_default_placement_side: Default placement side for binary tree placement algorithm (default: "left", options: "left" or "right")
     * Controls which side chain is followed after first 2 users are placed
     * If "left": 1st user → LEFT, 2nd user → RIGHT, 3rd+ → follow LEFT chain
     * If "right": 1st user → RIGHT, 2nd user → LEFT, 3rd+ → follow RIGHT chain
     * See Binary Tree Placement notes in CREATE BOOKING endpoint for detailed placement rules
   - updated_by is automatically set to the current user making the update
   - Settings are stored as a singleton (only one instance exists)
   - Timeout is stored in minutes (converted from hours for backward compatibility)
   - Example: 1440 minutes = 24 hours, 60 minutes = 1 hour, null = never expires
   - Daily pair limit resets at midnight (00:00 server time)


================================================================================
                         AUTHENTICATION HEADERS
================================================================================

All authenticated endpoints require JWT Bearer token in Authorization header:

Authorization: Bearer <access_token>

Example:
curl -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..." \
     http://localhost:8000/api/users/profile/


================================================================================
                         ERROR RESPONSES
================================================================================

Standard Error Format:

400 Bad Request:
{
  "field_name": ["Error message"],
  "non_field_errors": ["General error message"]
}

401 Unauthorized:
{
  "detail": "Authentication credentials were not provided."
}

403 Forbidden:
{
  "detail": "You do not have permission to perform this action."
}

404 Not Found:
{
  "detail": "Not found."
}

429 Too Many Requests:
{
  "detail": "Request was throttled. Expected available in X seconds."
}

500 Internal Server Error:
{
  "detail": "A server error occurred."
}


================================================================================
                         RATE LIMITING
================================================================================

- OTP Endpoints (/api/auth/send-otp/, /api/auth/verify-otp/, /api/auth/send-admin-otp/, /api/auth/verify-admin-otp/, /api/auth/send-universal-otp/, /api/auth/verify-universal-otp/): 
  5 requests per minute per IP

- Booking Endpoints (/api/booking/): 
  10 requests per minute per IP

- All Other APIs: 
  100 requests per minute per IP


================================================================================
                         BUSINESS RULES
================================================================================

1. Pre-booking Minimum: ₹500
2. Active Buyer Threshold: ₹5000 total paid
3. Direct User Commission: ₹1000 per direct user added (configurable via settings)
   - Paid only for first 3 direct children (configurable threshold, default: 3)
   - Stops after binary commission activation
   - 20% TDS is deducted from direct user commission (configurable percentage)
   - Net amount (₹800 = ₹1000 - ₹200 TDS) is credited to wallet
   - TDS is deducted from referrer's oldest active booking remaining amount
   - Only distributors can receive commissions
4. Binary Commission Activation: Activates automatically when user has 3 direct children (configurable threshold)
   - Tree counting: All direct and indirect referrals (entire subtree) are counted for commission calculation
5. Binary Pair Commission: ₹2000 per pair after activation (configurable via settings)
   - Only pairs created after activation count towards commission
   - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
     * Pre-activation members (1st and 2nd members) are EXCLUDED from pairing
     * Member that triggered activation (3rd member) is INCLUDED in pairing
     * All members added after activation are INCLUDED in pairing
     * Example: User A has B (1st), C (2nd), D (3rd - triggers activation), E (4th):
       - B and C are excluded from pairing
       - D and E can be paired (not B and C)
   - Maximum 10 pairs per DAY per user (configurable daily limit, default: 10 pairs = ₹20,000)
   - Daily limit resets at midnight (00:00 server time)
   - 20% TDS is applied on ALL pair commissions (1st pair onwards, configurable percentage)
   - Pairs 1-5: ₹2000 - 20% TDS = ₹1600 credited
   - Pairs 6+: ₹2000 - 20% TDS - 20% extra = ₹1200 credited (extra deducted from booking balance)
6. Binary Commission TDS and Deductions:
   - TDS percentage: 20% on ALL binary commissions (configurable, range: 0-100%)
   - Extra deduction threshold: 5 pairs after activation (configurable)
   - Extra deduction percentage: 20% for 6th+ pairs (configurable, range: 0-100%)
   - TDS and extra deduction are deducted from user's oldest active booking remaining amount
   - If no active booking exists, deductions are still recorded but not deducted from any booking
7. Daily Pair Limit and Carry-Forward:
   - After 10 pairs in a day: Compare remaining unmatched members on each side
   - SHORT leg (fewer remaining members) is IGNORED for commission that day
   - LONG leg (more remaining members) has ALL remaining members CARRIED FORWARD to next day
   - Next day: New members on ignored side match with carried-forward members from long leg
   - Daily limit reset: Resets at midnight (00:00 server time)
7. Payout TDS: 5% with ₹10,000 ceiling (separate from binary commission TDS)
8. EMI Auto-fill: Optional feature in payout requests
9. Payment Status: Payments default to 'pending' and require admin/staff approval or payment gateway confirmation
10. Stock Reservation: Bookings automatically reserve vehicle stock; released if payment not confirmed within timeout
11. Reservation Timeout: Configurable via Platform Settings API (stored in minutes, null = never expires)
12. Distributor Requirement: Only approved distributors can earn from binary pairs, direct user commissions, and referral bonuses
13. Distributor Eligibility: User must have approved KYC to apply for distributor program (Active Buyer requirement removed)
14. Distributor Application: Each user can submit only one distributor application; application is automatically approved upon creation and user becomes distributor immediately (no admin/staff approval required). Admin/staff can still reject applications if needed via update-status endpoint.
15. Binary Tree Placement: Users are NOT automatically placed in binary tree during booking creation. Placement APIs can ONLY be called AFTER user has successful payment. Referrers must place users AFTER payment via /api/binary/nodes/auto_place_pending/ (automatic) or /api/binary/nodes/place_user/ (manual). Commission is paid when placement happens (regardless of when payment was completed). Auto-placement uses left-priority algorithm: 1st user → LEFT, 2nd user → RIGHT, 3rd+ → follow LEFT chain. Referral-based override: If using specific parent's code, place in that parent's tree. Default placement side is configurable via Platform Settings (binary_tree_default_placement_side). Parents can choose side for direct referrals and swap/move direct children via API endpoints.
16. Manual Tree Placement: Tree owners can manually place/move users in their tree via placement APIs; only users who used referrer's code can be placed
17. Commission Configuration: All binary commission amounts, thresholds, TDS settings, and daily limits are configurable via Platform Settings API
18. Referral Commission Timing: Commission is only granted for bookings created AFTER the referrer becomes a distributor (no retroactive commissions)
    - System stores referrer_was_distributor flag at booking creation time
    - Commission is granted only if referrer_was_distributor is True when payment is completed
19. Tree Counting: left_count and right_count now count ALL descendants recursively (entire subtree, not just direct children)
20. Distributor Eligibility: Active Buyer requirement removed - only KYC verification needed to apply for distributor program
21. Commission Restriction for Non-Active Buyer Distributors:
    - Can earn unlimited direct user commissions (₹1000 per direct user, before binary activation)
    - Can earn commission for first 5 binary pairs after binary activation (₹2000 per pair)
    - Binary pair commissions from 6th pair onwards are BLOCKED until they become Active Buyer
    - When distributor becomes Active Buyer (total paid ≥ ₹5000), future binary pairs (6th+) will be paid normally
    - No retroactive commissions for pairs that were blocked during restriction period


================================================================================
                         PERMISSION HIERARCHY
================================================================================

Profile Editing Permissions:

Admin/Superuser:
  - Can edit: Admin profiles ✓
  - Can edit: Staff profiles ✓
  - Can edit: Normal user profiles ✓
  - Can view: All users ✓

Staff:
  - Can edit: Own profile ✓
  - Can edit: Normal user profiles ✓
  - Cannot edit: Admin profiles ✗
  - Cannot edit: Other staff profiles ✗
  - Can view: All users ✓

Normal User:
  - Can edit: Own profile only ✓
  - Cannot edit: Any other profiles ✗
  - Can view: Own profile only ✓

User Listing Permissions:
  - Admin/Superuser: Can list all users
  - Staff: Can list all users (to manage normal users)
  - Normal Users: Can only see their own profile in listings

Error Messages:
  - Staff attempting to edit admin/staff: "Staff can only edit their own profile or normal users' profiles."
  - Normal user attempting to edit others: "You can only update your own profile."


================================================================================
                         STATUS CODES
================================================================================

200 OK: Successful GET, PUT, PATCH requests
201 Created: Successful POST requests (resource created)
204 No Content: Successful DELETE requests
400 Bad Request: Invalid request data
401 Unauthorized: Missing or invalid authentication
403 Forbidden: Insufficient permissions
404 Not Found: Resource not found
429 Too Many Requests: Rate limit exceeded
500 Internal Server Error: Server error


================================================================================
                         PAGINATION
================================================================================

All list endpoints support pagination:

Query Parameters:
- page: Page number (default: 1)
- page_size: Items per page (default: 20, max: 100)

Response Format:
{
  "count": 100,           // Total number of items
  "next": "http://...",   // URL for next page (null if last page)
  "previous": "http://...", // URL for previous page (null if first page)
  "results": [...]        // Array of items for current page
}


================================================================================
                         DATE/TIME FORMAT
================================================================================

All dates and times are in ISO 8601 format:
- Date: YYYY-MM-DD (e.g., "2026-01-06")
- DateTime: YYYY-MM-DDTHH:MM:SSZ (e.g., "2026-01-06T12:00:00Z")
- Timezone: UTC (converted from server timezone)


================================================================================
                         FILE UPLOADS
================================================================================

File upload endpoints accept multipart/form-data:
- Maximum file size: 20MB
- Supported formats: Images (JPG, PNG), PDFs
- Files are stored in /media/ directory


================================================================================
                         NOTES
================================================================================

1. All monetary values are in Indian Rupees (₹) and returned as strings with 2 decimal places
2. JWT access tokens expire in 60 minutes (configurable)
3. JWT refresh tokens expire in 24 hours (configurable)
4. OTP expires in 10 minutes
5. Admin endpoints require is_superuser=True or role='admin'
6. Profile editing follows hierarchical permissions: Admin > Staff > Normal User (see PERMISSION HIERARCHY section)
7. All timestamps are in UTC
8. Database uses SQLite in development, MySQL in production (switch via DB_ENGINE in .env)


================================================================================
                         END OF DOCUMENTATION
================================================================================

Last Updated: 2026-01-06
Version: 1.0.0

