================================================================================
                    EV DISTRIBUTION PLATFORM - API DOCUMENTATION
================================================================================

Base URL: http://localhost:8000/api
Authentication: JWT Bearer Token (except where noted)

================================================================================
                            AUTHENTICATION APIs
================================================================================
Super User: EVAdmin && EVAdmin@123
1. SEND OTP (Regular Users Only)
   Method: POST
   URL: /api/auth/send-otp/
   Authentication: Not Required
   Description: Send OTP to existing user's email or mobile number. Only works for registered users with role='user'. New users must use /api/auth/signup/ endpoint first. Admin/Staff users must use /api/auth/send-admin-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "user@example.com",  // Email or mobile number
     "otp_type": "email"                 // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "message": "OTP sent to user@example.com"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["User not found. Please use /api/auth/signup/ endpoint to register first."]
   }
   OR
   {
     "non_field_errors": ["Admin/Staff users must use /api/auth/send-admin-otp/ endpoint"]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Only works for existing registered users with role='user'
   - New users must register via /api/auth/signup/ endpoint first
   - Admin/Staff users must use /api/auth/send-admin-otp/ endpoint
   
   Rate Limit: 5 requests per minute per IP


2. VERIFY OTP & LOGIN (Regular Users Only)
   Method: POST
   URL: /api/auth/verify-otp/
   Authentication: Not Required
   Description: Verify OTP and login existing user. Returns JWT tokens. Only works for registered users with role='user'. New users must use /api/auth/signup/ and /api/auth/verify-signup-otp/ endpoints first. Admin/Staff users must use /api/auth/verify-admin-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "user@example.com",
     "otp_code": "123456",
     "otp_type": "email"  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "user": {
       "id": 1,
       "username": "user@example.com",
       "email": "user@example.com",
       "mobile": null,
       "role": "user",
       "is_active_buyer": false,
       "is_distributor": false
     },
     "tokens": {
       "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
       "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
     }
   }
   
   Error Response (400):
   {
     "non_field_errors": ["Invalid or expired OTP"]
   }
   OR
   {
     "non_field_errors": ["User not found. Please use /api/auth/signup/ endpoint to register first."]
   }
   OR
   {
     "non_field_errors": ["Admin/Staff users must use /api/auth/verify-admin-otp/ endpoint"]
   }
   
   Notes:
   - Only works for existing registered users with role='user'
   - New users must register via /api/auth/signup/ and /api/auth/verify-signup-otp/ endpoints first
   - Admin/Staff users must use /api/auth/verify-admin-otp/ endpoint
   - No auto-creation of user accounts - users must register first
   
   Rate Limit: 5 requests per minute per IP


2A. SEND ADMIN/STAFF OTP
   Method: POST
   URL: /api/auth/send-admin-otp/
   Authentication: Not Required
   Description: Send OTP to admin/staff user's email or mobile number. Only works for existing admin/staff users (role='admin' or 'staff'). Regular users must use /api/auth/send-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "admin@example.com",  // Email or mobile number
     "otp_type": "email"                  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "message": "OTP sent to admin@example.com"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["User not found or does not have admin/staff privileges"]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Only works for existing admin/staff users (role='admin' or 'staff')
   - Regular users must use /api/auth/send-otp/ endpoint
   - Admin/Staff accounts must be created via /api/auth/create-admin/ or /api/auth/create-staff/ endpoints
   
   Rate Limit: 5 requests per minute per IP


2B. VERIFY ADMIN/STAFF OTP & LOGIN
   Method: POST
   URL: /api/auth/verify-admin-otp/
   Authentication: Not Required
   Description: Verify OTP and login admin/staff user. Returns JWT tokens. Only works for existing admin/staff users (role='admin' or 'staff'). Regular users must use /api/auth/verify-otp/ endpoint.
   
   Request Body:
   {
     "identifier": "admin@example.com",
     "otp_code": "123456",
     "otp_type": "email"  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "user": {
       "id": 2,
       "username": "admin@example.com",
       "email": "admin@example.com",
       "mobile": "9876543211",
       "role": "admin",  // "admin" or "staff"
       "is_active_buyer": false,
       "is_distributor": false
     },
     "tokens": {
       "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
       "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
     }
   }
   
   Error Response (400):
   {
     "non_field_errors": ["Invalid or expired OTP"]
   }
   OR
   {
     "non_field_errors": ["User not found or does not have admin/staff privileges"]
   }
   
   Notes:
   - Only works for existing admin/staff users (role='admin' or 'staff')
   - Regular users must use /api/auth/verify-otp/ endpoint
   - Admin/Staff accounts must be created via /api/auth/create-admin/ or /api/auth/create-staff/ endpoints
   - No auto-creation of user accounts
   
   Rate Limit: 5 requests per minute per IP


2C. SEND UNIVERSAL OTP (All Users)
   Method: POST
   URL: /api/auth/send-universal-otp/
   Authentication: Not Required
   Description: Send OTP to any existing user's email or mobile number. Works for all existing users regardless of role (admin, staff, or user). Only works for existing registered users - new users must use /api/auth/signup/ endpoint first.
   
   Request Body:
   {
     "identifier": "user@example.com",  // Email or mobile number
     "otp_type": "email"                 // "email" or "mobile"
   }
   
   Response (200 OK) - When user has both email and mobile:
   {
     "message": "OTP sent to both email (user@example.com) and mobile (9876543210)",
     "sent_to": ["email", "mobile"]
   }
   
   Response (200 OK) - When user has only one channel:
   {
     "message": "OTP sent to user@example.com"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["User not found. Only existing users can request OTP."]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Works for all existing users (admin, staff, and regular users)
   - Only works for existing registered users - new users must register via /api/auth/signup/ endpoint first
   - If user has both email and mobile: Sends the same OTP code to both channels automatically
   - If user has only one channel: Sends OTP to that channel only
   - The same OTP code works for verification from either email or mobile (if user has both)
   - This endpoint is for OTP verification only - does not log in the user
   - To login after verification, use /api/auth/verify-otp/ or /api/auth/verify-admin-otp/ endpoints
   
   Rate Limit: 5 requests per minute per IP


2D. VERIFY UNIVERSAL OTP (All Users)
   Method: POST
   URL: /api/auth/verify-universal-otp/
   Authentication: Not Required
   Description: Verify OTP for any existing user. Works for all existing users regardless of role (admin, staff, or user). Only verifies the OTP and returns success/failure - does not issue JWT tokens or log in the user. For login functionality, use /api/auth/verify-otp/ or /api/auth/verify-admin-otp/ endpoints.
   
   Request Body:
   {
     "identifier": "user@example.com",
     "otp_code": "123456",
     "otp_type": "email"  // "email" or "mobile"
   }
   
   Response (200 OK):
   {
     "message": "OTP verified successfully"
   }
   
   Error Response (400):
   {
     "non_field_errors": ["Invalid or expired OTP"]
   }
   OR
   {
     "non_field_errors": ["User not found. Only existing users can verify OTP."]
   }
   OR
   {
     "identifier": ["Invalid email format"],
     "otp_type": ["Invalid choice"]
   }
   
   Notes:
   - Works for all existing users (admin, staff, and regular users)
   - Only works for existing registered users - new users must register via /api/auth/signup/ endpoint first
   - If user has both email and mobile: The same OTP code can be verified from either email or mobile channel
   - If user has only one channel: OTP must be verified from that specific channel
   - Only verifies the OTP - does NOT issue JWT tokens or log in the user
   - For login functionality, use /api/auth/verify-otp/ (regular users) or /api/auth/verify-admin-otp/ (admin/staff) endpoints
   - This endpoint is useful for OTP verification scenarios where login is not required (e.g., password reset, email verification, etc.)
   - No auto-creation of user accounts - users must register first
   
   Rate Limit: 5 requests per minute per IP


3. REFRESH TOKEN
   Method: POST
   URL: /api/auth/refresh/
   Authentication: Not Required (but needs refresh token)
   Description: Get new access token using refresh token
   
   Request Body:
   {
     "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }
   
   Response (200 OK):
   {
     "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }


4. LOGOUT
   Method: POST
   URL: /api/auth/logout/
   Authentication: Required
   Description: Logout user and blacklist refresh token
   
   Request Body:
   {
     "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
   }
   
   Response (200 OK):
   {
     "message": "Successfully logged out"
   }


5. USER SIGNUP
   Method: POST
   URL: /api/auth/signup/
   Authentication: Not Required
   Description: Submit signup form with user details. Sends OTP to both email and mobile.
   
   Request Body:
   {
     "first_name": "John",
     "last_name": "Doe",
     "email": "john@example.com",
     "mobile": "9876543210",
     "gender": "male",                    // "male", "female", "other"
     "date_of_birth": "1990-01-01",
     "address_line1": "123 Main Street",
     "address_line2": "Apt 4B",          // Optional
     "city": "Mumbai",
     "state": "Maharashtra",
     "pincode": "400001",
     "country": "India",                 // Optional, defaults to "India"
     "referral_code": "REF12345"         // Optional
   }
   
   Response (200 OK):
   {
     "message": "OTP sent to email and mobile",
     "signup_token": "ABC123XYZ789..."
   }
   
   Error Response (400):
   {
     "email": ["Email already registered"],
     "mobile": ["Mobile number already registered"],
     "mobile": ["Invalid mobile number format"]
   }
   
   Rate Limit: 5 requests per minute per IP


6. VERIFY SIGNUP OTP
   Method: POST
   URL: /api/auth/verify-signup-otp/
   Authentication: Not Required
   Description: Verify OTP and create user account. The same OTP code is sent to both email and mobile, so use the same code for verification. This will create the user account with all profile fields from the signup form.
   
   Request Body:
   {
     "signup_token": "ABC123XYZ789...",    // Token received from /auth/signup/ endpoint
     "otp_code": "123456"                  // OTP code received via email or mobile (same code for both)
   }
   
   Response (201 Created):
   {
     "user": {
       "id": 1,
       "username": "john@example.com",
       "email": "john@example.com",
       "mobile": "9876543210",
       "first_name": "John",
       "last_name": "Doe",
       "role": "user",
       "is_active_buyer": false,
       "is_distributor": false
     },
     "tokens": {
       "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
       "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
     }
   }
   
   Error Response (400):
   {
     "signup_token": ["Invalid or expired signup token"],
     "otp_code": ["Invalid or expired OTP"]
   }
   
   Notes:
   - The signup_token expires after 15 minutes
   - If user already exists (e.g., logged in via OTP login), the profile will be updated with signup data
   - The same OTP code works for both email and mobile verification
   
   Rate Limit: 5 requests per minute per IP


7. CREATE ADMIN (Superuser Only)
   Method: POST
   URL: /api/auth/create-admin/
   Authentication: Required (Superuser)
   Description: Create admin user. Only superusers can create admins.
   
   Request Body:
   {
     "first_name": "Admin",
     "last_name": "User",
     "email": "admin@example.com",
     "mobile": "9876543211",
     "gender": "male",
     "date_of_birth": "1985-01-01",
     "address_line1": "456 Admin Street",
     "address_line2": "",                // Optional
     "city": "Delhi",
     "state": "Delhi",
     "pincode": "110001",
     "country": "India"                  // Optional
   }
   
   Response (201 Created):
   {
     "user": {
       "id": 2,
       "username": "admin@example.com",
       "email": "admin@example.com",
       "mobile": "9876543211",
       "first_name": "Admin",
       "last_name": "User",
       "role": "admin"
     },
     "message": "Admin created successfully. OTP sent to email and mobile for initial login."
   }
   
   Error Response (400):
   {
     "email": ["Email already registered"],
     "mobile": ["Mobile number already registered"]
   }
   
   Error Response (403):
   {
     "detail": "You do not have permission to perform this action."
   }


8. CREATE STAFF (Admin or Superuser)
   Method: POST
   URL: /api/auth/create-staff/
   Authentication: Required (Admin or Superuser)
   Description: Create staff user. Both admins and superusers can create staff.
   
   Request Body:
   {
     "first_name": "Staff",
     "last_name": "User",
     "email": "staff@example.com",
     "mobile": "9876543212",
     "gender": "female",
     "date_of_birth": "1990-05-15",
     "address_line1": "789 Staff Avenue",
     "address_line2": "",                // Optional
     "city": "Bangalore",
     "state": "Karnataka",
     "pincode": "560001",
     "country": "India"                  // Optional
   }
   
   Response (201 Created):
   {
     "user": {
       "id": 3,
       "username": "staff@example.com",
       "email": "staff@example.com",
       "mobile": "9876543212",
       "first_name": "Staff",
       "last_name": "User",
       "role": "staff"
     },
     "message": "Staff created successfully. OTP sent to email and mobile for initial login."
   }
   
   Error Response (400):
   {
     "email": ["Email already registered"],
     "mobile": ["Mobile number already registered"]
   }
   
   Error Response (403):
   {
     "detail": "You do not have permission to perform this action."
   }


================================================================================
                              USER APIs
================================================================================

9. GET USER PROFILE
   Method: GET
   URL: /api/users/profile/
   Authentication: Required
   Description: Get current user's profile information
   
   Response (200 OK):
   {
     "id": 1,
     "username": "user@example.com",
     "email": "user@example.com",
     "mobile": "+919876543210",
     "first_name": "John",
     "last_name": "Doe",
     "gender": "male",
     "date_of_birth": "1990-01-01",
     "profile_picture": null,
     "profile_picture_url": null,
     "address_line1": "123 Main Street",
     "address_line2": "Apt 4B",
     "city": "Mumbai",
     "state": "Maharashtra",
     "pincode": "400001",
     "country": "India",
     "role": "user",
     "is_distributor": false,
     "is_active_buyer": true,
     "referral_code": "REF00001",
     "referred_by": null,  // Or nested object with id, fullname, email, profile_picture_url if referrer exists
     "kyc_status": "approved",
     "nominee_exists": true,
     "is_distributor_terms_and_conditions_accepted": true,
     "date_joined": "2026-01-06T12:00:00Z"
   }


10. UPDATE USER PROFILE
    Method: PUT / PATCH
    URL: /api/users/update_profile/  (for own profile)
         /api/users/{id}/            (for any profile - with permissions)
    Authentication: Required
    Description: Update user profile with hierarchical permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can edit any profile (admin, staff, and normal users)
    - Staff: Can edit their own profile and normal users' profiles (cannot edit admin/staff profiles)
    - Normal Users: Can only edit their own profile
    
    Request Body (PATCH - partial update):
    Content-Type: multipart/form-data (when uploading profile_picture)
    OR
    Content-Type: application/json (for other fields)
    
    {
      "first_name": "John",
      "last_name": "Doe",
      "mobile": "+919876543210",
      "gender": "male",
      "date_of_birth": "1990-01-01",
      "profile_picture": <file>,  // Optional: Image file (JPEG, PNG, GIF, WEBP, max 5MB)
      "address_line1": "123 Main Street",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001"
    }
    
    Profile Picture Validation:
    - Maximum file size: 5MB
    - Allowed formats: JPEG, PNG, GIF, WEBP
    - Field is optional
    
    Response (200 OK):
    {
      "id": 1,
      "username": "user@example.com",
      "email": "user@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "gender": "male",
      "date_of_birth": "1990-01-01",
      "profile_picture": "profile_pictures/user_1_profile.jpg",
      "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_1_profile.jpg",
      ...
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Staff can only edit their own profile or normal users' profiles."
    }
    OR
    {
      "detail": "You can only update your own profile."
    }
    
    Examples:
    - Admin editing admin profile: ✓ Allowed
    - Admin editing staff profile: ✓ Allowed
    - Admin editing normal user profile: ✓ Allowed
    - Staff editing own profile: ✓ Allowed
    - Staff editing normal user profile: ✓ Allowed
    - Staff editing admin profile: ✗ Forbidden (403)
    - Staff editing other staff profile: ✗ Forbidden (403)
    - Normal user editing own profile: ✓ Allowed
    - Normal user editing any other profile: ✗ Forbidden (403)


11. LIST USERS
   Method: GET
   URL: /api/users/
   Authentication: Required
   Description: List users based on role:
   - Admin/Superuser: Can see all users
   - Staff: Can see all users (to manage normal users)
   - Normal Users: Can only see their own profile
   
   Query Parameters:
   - page: Page number (default: 1)
   - page_size: Items per page (default: 20)
   
   Response (200 OK):
   {
     "count": 100,
     "next": "http://localhost:8000/api/users/?page=2",
     "previous": null,
     "results": [
       {
         "id": 1,
         "username": "user@example.com",
         "email": "user@example.com",
         "role": "user",
         "is_active_buyer": true,
         "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_1_profile.jpg",
         ...
       }
     ]
   }


12. GET USER BY ID
    Method: GET
    URL: /api/users/{id}/
    Authentication: Required
    Description: Get specific user details. Access based on role:
    - Admin/Superuser: Can view any user
    - Staff: Can view any user (to manage normal users)
    - Normal Users: Can only view their own profile
    
    Response (200 OK):
    {
      "id": 1,
      "username": "user@example.com",
      "email": "user@example.com",
      "mobile": "+919876543210",
      "first_name": "John",
      "last_name": "Doe",
      "gender": "male",
      "date_of_birth": "1990-01-01",
      "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_1_profile.jpg",
      "address_line1": "123 Main Street",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001",
      "country": "India",
      ...
    }


13. LIST ADMIN USERS
    Method: GET
    URL: /api/users/admins/
    Authentication: Required (Superuser only)
    Description: List all admin users. Only superuser can access this endpoint.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    
    Response (200 OK):
    {
      "count": 5,
      "next": null,
      "previous": null,
      "results": [
        {
          "id": 1,
          "username": "admin@example.com",
          "email": "admin@example.com",
          "mobile": "+919876543210",
          "role": "admin",
          "first_name": "Admin",
          "last_name": "User",
          "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_1_profile.jpg",
          ...
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Only superuser can list admin users."
    }


14. LIST STAFF USERS
    Method: GET
    URL: /api/users/staff/
    Authentication: Required (Superuser or Admin)
    Description: List all staff users. Superuser and admin can access this endpoint.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    
    Response (200 OK):
    {
      "count": 10,
      "next": null,
      "previous": null,
      "results": [
        {
          "id": 2,
          "username": "staff@example.com",
          "email": "staff@example.com",
          "mobile": "+919876543211",
          "role": "staff",
          "first_name": "Staff",
          "last_name": "User",
          "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_2_profile.jpg",
          ...
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Only superuser and admin can list staff users."
    }


15. LIST NORMAL USERS
    Method: GET
    URL: /api/users/normal/
    Authentication: Required (Superuser, Admin, or Staff)
    Description: List all normal users. Superuser, admin, and staff can access this endpoint.
    Supports filtering by is_distributor, date_joined, search (name), and ordering.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    - is_distributor: Filter by distributor status (true/false)
      - is_distributor=true: Return only distributors
      - is_distributor=false: Return only non-distributors
      - If not provided: Return all normal users
    - date_joined_from: Filter users joined on or after this date (format: YYYY-MM-DD)
      Example: date_joined_from=2024-01-01
    - date_joined_to: Filter users joined on or before this date (format: YYYY-MM-DD)
      Example: date_joined_to=2024-12-31
    - search: Search users by name (case-insensitive partial match)
      Searches across: first_name, last_name, username, and email fields
      Example: search=john (matches "John", "john@example.com", "john_doe", etc.)
    - ordering: Order results by field (default: id)
      Allowed values: id, -id, date_joined, -date_joined, username, -username, email, -email, first_name, -first_name, last_name, -last_name
      Example: ordering=-date_joined (newest first)
    
    Examples:
    - Get all distributors: /api/users/normal/?is_distributor=true
    - Get non-distributors: /api/users/normal/?is_distributor=false
    - Get users joined in 2024: /api/users/normal/?date_joined_from=2024-01-01&date_joined_to=2024-12-31
    - Get distributors joined after 2024-01-01: /api/users/normal/?is_distributor=true&date_joined_from=2024-01-01
    - Search for users by name: /api/users/normal/?search=john
    - Search distributors by name: /api/users/normal/?is_distributor=true&search=john
    - Get users ordered by join date (newest first): /api/users/normal/?ordering=-date_joined
    
    Response (200 OK):
    {
      "count": 100,
      "next": "http://localhost:8000/api/users/normal/?page=2",
      "previous": null,
      "results": [
        {
          "id": 3,
          "username": "user@example.com",
          "email": "user@example.com",
          "mobile": "+919876543212",
          "role": "user",
          "first_name": "John",
          "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_3_profile.jpg",
          "last_name": "Doe",
          "is_active_buyer": true,
          "is_distributor": false,
          "date_joined": "2024-01-15T10:30:00Z",
          ...
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "Only superuser, admin, and staff can list normal users."
    }


================================================================================
                              KYC APIs
================================================================================

16. CREATE/UPDATE KYC
   Method: POST
   URL: /api/users/kyc/
   Authentication: Required
   Description: Submit or resubmit KYC documents. If KYC already exists for the user, it will be updated.
   
   Important: KYC Resubmission Behavior
   - Users can resubmit their KYC documents at any time
   - If critical fields are changed during resubmission, the KYC status will automatically reset to 'pending' and require admin re-approval, regardless of previous status (approved/rejected)
   - Critical fields that trigger re-approval:
     * Document files: pan_document, aadhaar_front, aadhaar_back, bank_passbook
     * Identity numbers: pan_number, aadhaar_number
   - When resubmitting with critical field changes:
     * Status is reset to 'pending'
     * submitted_at timestamp is updated to current time
     * Review fields are cleared (reviewed_by, reviewed_at, rejection_reason)
   - Updating only non-critical fields (address, bank details without documents) will NOT reset the status
   
   Request Body (multipart/form-data):
   {
     "pan_number": "ABCDE1234F",
     "aadhaar_number": "123456789012",
     "address_line1": "123 Main Street",
     
     "address_line2": "Apt 4B",
     "city": "Mumbai",
     "state": "Maharashtra",
     "pincode": "400001",
     "country": "India",
     "pan_document": <file>,
     "aadhaar_front": <file>,
     "aadhaar_back": <file>,
     "bank_name": "State Bank of India",
     "account_number": "1234567890",
     "ifsc_code": "SBIN0001234",
     "account_holder_name": "John Doe",
     "bank_passbook": <file>  // Bank account passbook document
   }
   
   Response (201 Created - First Submission):
   {
     "id": 1,
     "user": 1,
     "status": "pending",
     "pan_number": "ABCDE1234F",
     "submitted_at": "2026-01-06T12:00:00Z",
     ...
   }
   
   Response (200 OK - Resubmission):
   {
     "id": 1,
     "user": 1,
     "status": "pending",  // Reset to pending if critical fields changed
     "pan_number": "ABCDE1234F",
     "submitted_at": "2026-01-06T14:30:00Z",  // Updated timestamp
     "reviewed_at": null,  // Cleared on resubmission
     "reviewed_by": null,  // Cleared on resubmission (or nested object with id, fullname, email, profile_picture_url if reviewer exists)
     "rejection_reason": "",  // Cleared on resubmission
     ...
   }
   
   Note: If resubmitting with only non-critical field changes (e.g., address update), the status will remain unchanged.


17. GET KYC STATUS
    Method: GET
    URL: /api/users/kyc/
    Authentication: Required
    Description: Get KYC status with hierarchical permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can view all KYC records (admin, staff, and normal users)
    - Staff: Can view their own KYC and normal users' KYC (cannot view admin/staff KYC)
    - Normal Users: Can only view their own KYC record
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "status": "approved",  // "pending", "approved", "rejected"
      "pan_number": "ABCDE1234F",
      "submitted_at": "2026-01-06T12:00:00Z",
      "reviewed_at": "2026-01-06T13:00:00Z",
      ...
    }
    
    Examples:
    - Admin viewing admin KYC: ✓ Allowed
    - Admin viewing staff KYC: ✓ Allowed
    - Admin viewing normal user KYC: ✓ Allowed
    - Staff viewing own KYC: ✓ Allowed
    - Staff viewing normal user KYC: ✓ Allowed
    - Staff viewing admin KYC: ✗ Not returned in queryset
    - Staff viewing other staff KYC: ✗ Not returned in queryset
    - Normal user viewing own KYC: ✓ Allowed
    - Normal user viewing any other KYC: ✗ Not returned in queryset


18. GET KYC BY ID
    Method: GET
    URL: /api/users/kyc/{id}/
    Authentication: Required
    Description: Get specific KYC record by ID. Access based on hierarchical permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can view any KYC record by ID (admin, staff, and normal users)
    - Staff: Can view their own KYC by ID and normal users' KYC by ID (cannot view admin/staff KYC by ID)
    - Normal Users: Can only view their own KYC record by ID
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "status": "approved",  // "pending", "approved", "rejected"
      "pan_number": "ABCDE1234F",
      "aadhaar_number": "123456789012",
      "address_line1": "123 Main Street",
      "address_line2": "Apt 4B",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001",
      "country": "India",
      "pan_document": "http://localhost:8000/media/kyc/pan/pan_123.jpg",
      "aadhaar_front": "http://localhost:8000/media/kyc/aadhaar/aadhaar_front_123.jpg",
      "aadhaar_back": "http://localhost:8000/media/kyc/aadhaar/aadhaar_back_123.jpg",
      "bank_name": "State Bank of India",
      "account_number": "1234567890",
      "ifsc_code": "SBIN0001234",
      "account_holder_name": "John Doe",
      "bank_passbook": "http://localhost:8000/media/kyc/bank_passbook/passbook_123.jpg",
      "submitted_at": "2026-01-06T12:00:00Z",
      "reviewed_at": "2026-01-06T13:00:00Z",
      "reviewed_by": {      // Reviewer user details, null if not reviewed
        "id": 2,
        "fullname": "Admin User",
        "email": "admin@example.com",
        "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_2_profile.jpg"
      },
      "rejection_reason": ""
    }
    
    Error Response (404 Not Found):
    {
      "detail": "Not found."
    }
    
    Note: Returns 404 if the KYC record doesn't exist or if the user doesn't have permission to view it based on hierarchical permissions.
    
    Examples:
    - Admin accessing admin KYC by ID: ✓ Allowed
    - Admin accessing staff KYC by ID: ✓ Allowed (e.g., GET /api/users/kyc/5/)
    - Admin accessing normal user KYC by ID: ✓ Allowed
    - Staff accessing own KYC by ID: ✓ Allowed
    - Staff accessing normal user KYC by ID: ✓ Allowed
    - Staff accessing admin KYC by ID: ✗ 404 Not Found
    - Staff accessing other staff KYC by ID: ✗ 404 Not Found
    - Normal user accessing own KYC by ID: ✓ Allowed
    - Normal user accessing any other KYC by ID: ✗ 404 Not Found


19. UPDATE KYC STATUS (Admin Only)
    Method: POST
    URL: /api/users/kyc/{id}/update-status/
    Authentication: Required (Admin)
    Description: Update KYC status - approve or reject KYC submission
    
    Request Body:
    {
      "status": "approved"  // or "rejected"
      "reason": "PAN document is not clear"  // Optional, only required/used when status is "rejected"
    }
    
    Response (200 OK):
    {
      "status": "approved"  // or "rejected"
    }
    
    Error Response (400):
    {
      "error": "Invalid status. Must be 'approved' or 'rejected'"
    }
    or
    {
      "error": "KYC is already approved"  // or "KYC is already rejected"
    }


21. LIST ALL KYC DOCUMENTS (Admin Only)
    Method: GET
    URL: /api/users/kyc/list_all/
    Authentication: Required (Admin)
    Description: List all KYC documents with filtering and pagination. Admin/Superuser only.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20, max: 100)
    - status: Filter by KYC status (pending, approved, rejected)
    - submitted_date_from: Filter by submission date start (YYYY-MM-DD)
    - submitted_date_to: Filter by submission date end (YYYY-MM-DD)
    - reviewed_date_from: Filter by review date start (YYYY-MM-DD)
    - reviewed_date_to: Filter by review date end (YYYY-MM-DD)
    - user_id: Filter by specific user ID
    - user_role: Filter by user role (admin, staff, user)
    - ordering: Sort results (default: -submitted_at)
      Options: submitted_at, -submitted_at, reviewed_at, -reviewed_at, status, -status
    
    Example Requests:
    GET /api/users/kyc/list_all/
    GET /api/users/kyc/list_all/?status=pending
    GET /api/users/kyc/list_all/?submitted_date_from=2026-01-01&submitted_date_to=2026-01-31
    GET /api/users/kyc/list_all/?user_role=user&status=approved
    GET /api/users/kyc/list_all/?user_id=5&ordering=-submitted_at
    GET /api/users/kyc/list_all/?reviewed_date_from=2026-01-01&reviewed_date_to=2026-01-31&status=approved
    
    Response (200 OK):
    {
      "count": 150,
      "next": "http://localhost:8000/api/users/kyc/list_all/?page=2",
      "previous": null,
      "results": [
        {
          "id": 1,
          "user": 1,
          "status": "approved",
          "pan_number": "ABCDE1234F",
          "aadhaar_number": "123456789012",
          "address_line1": "123 Main Street",
          "address_line2": "Apt 4B",
          "city": "Mumbai",
          "state": "Maharashtra",
          "pincode": "400001",
          "country": "India",
          "pan_document": "http://localhost:8000/media/kyc/pan/pan_123.jpg",
          "aadhaar_front": "http://localhost:8000/media/kyc/aadhaar/aadhaar_front_123.jpg",
          "aadhaar_back": "http://localhost:8000/media/kyc/aadhaar/aadhaar_back_123.jpg",
          "bank_name": "State Bank of India",
          "account_number": "1234567890",
          "ifsc_code": "SBIN0001234",
          "account_holder_name": "John Doe",
          "bank_passbook": "http://localhost:8000/media/kyc/bank_passbook/passbook_123.jpg",
          "submitted_at": "2026-01-06T12:00:00Z",
          "reviewed_at": "2026-01-06T13:00:00Z",
          "reviewed_by": {      // Reviewer user details, null if not reviewed
            "id": 2,
            "fullname": "Admin User",
            "email": "admin@example.com",
            "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_2_profile.jpg"
          },
          "rejection_reason": ""
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Only Admin/Superuser can access this endpoint
    - All filters can be combined
    - Date filters use inclusive ranges (>= for from, <= for to)
    - Default ordering is by submission date (newest first)
    - Invalid filter values are ignored (e.g., invalid user_id)


================================================================================
                    DISTRIBUTOR APPLICATION APIs
================================================================================

74. CREATE DISTRIBUTOR APPLICATION
    Method: POST
    URL: /api/users/distributor-application/
    Authentication: Required
    Description: Submit distributor application form. Approval behavior depends on distributor_application_auto_approve setting in Platform Settings.
    
    Eligibility Requirements:
    - User can only submit one application
    - Note: KYC approval is not required for distributor application. However, KYC approval is required for payout requests.
    
    Approval Behavior (controlled by distributor_application_auto_approve setting):
    - If distributor_application_auto_approve = True (default):
      * Application is automatically approved upon successful creation (status = 'approved')
      * User.is_distributor is automatically set to True
      * No admin/staff approval required
      * User can immediately start earning from binary pairs and referrals
    - If distributor_application_auto_approve = False:
      * Application is created with status = 'pending'
      * User.is_distributor remains False until admin/staff approval
      * Admin/staff must approve via /api/users/distributor-application/{id}/update-status/ endpoint
      * User can only start earning after manual approval
    
    Request Body (multipart/form-data):
    {
      "company_name": "ABC Distributors Pvt Ltd",  // Optional
      "business_registration_number": "REG123456",  // Optional
      "tax_id": "TAX789012",                        // Optional
      "years_in_business": 5,                       // Optional
      "previous_distribution_experience": "5 years of experience in EV distribution",  // Optional
      "product_interest": "Electric vehicles and accessories",  // Optional
      "reference_name": "John Smith",                // Optional
      "reference_contact": "+919876543210",          // Optional
      "reference_relationship": "Business Partner",  // Optional
      "is_distributor_terms_and_conditions_accepted": true,  // Required - Must be true
      "business_license": <file>,                     // Optional - Business license document
      "tax_documents": <file>                         // Optional - Tax documents
    }
    
    Response (201 Created) - When auto-approval is enabled (default):
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "approved",  // Automatically approved if distributor_application_auto_approve = true
      "company_name": "ABC Distributors Pvt Ltd",
      "business_registration_number": "REG123456",
      "tax_id": "TAX789012",
      "years_in_business": 5,
      "previous_distribution_experience": "5 years of experience in EV distribution",
      "product_interest": "Electric vehicles and accessories",
      "reference_name": "John Smith",
      "reference_contact": "+919876543210",
      "reference_relationship": "Business Partner",
      "is_distributor_terms_and_conditions_accepted": true,
      "business_license": "http://localhost:8000/media/distributor/business_license/license_1.pdf",
      "tax_documents": "http://localhost:8000/media/distributor/tax_documents/tax_1.pdf",
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": "2026-01-14T10:00:00Z",  // Set automatically when auto-approved
      "reviewed_by": null,  // No reviewer since auto-approved (or nested object with id, fullname, email, profile_picture_url if reviewer exists)
      "rejection_reason": ""
    }
    
    Response (201 Created) - When auto-approval is disabled:
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "pending",  // Remains pending if distributor_application_auto_approve = false
      "company_name": "ABC Distributors Pvt Ltd",
      "business_registration_number": "REG123456",
      "tax_id": "TAX789012",
      "years_in_business": 5,
      "previous_distribution_experience": "5 years of experience in EV distribution",
      "product_interest": "Electric vehicles and accessories",
      "reference_name": "John Smith",
      "reference_contact": "+919876543210",
      "reference_relationship": "Business Partner",
      "is_distributor_terms_and_conditions_accepted": true,
      "business_license": "http://localhost:8000/media/distributor/business_license/license_1.pdf",
      "tax_documents": "http://localhost:8000/media/distributor/tax_documents/tax_1.pdf",
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": null,  // Not set until admin/staff approval
      "reviewed_by": null,  // Not set until admin/staff approval (or nested object with id, fullname, email, profile_picture_url if reviewer exists)
      "rejection_reason": ""
    }
    
    Notes:
    - Approval behavior is controlled by distributor_application_auto_approve setting in Platform Settings
    - If auto-approval is enabled (default): Application is automatically approved, user becomes distributor immediately
    - If auto-approval is disabled: Application remains pending until admin/staff approval via update-status endpoint
    - User can only start earning from binary pairs and referrals when is_distributor = True
    
    Error Response (400 Bad Request):
    {
      "non_field_errors": [
        "Application already exists. You can only submit one distributor application."
      ]
    }
    OR
    {
      "is_distributor_terms_and_conditions_accepted": [
        "You cannot Proceed without Accepting Terms and Conditions"
      ]
    }


75. GET DISTRIBUTOR APPLICATION STATUS
    Method: GET
    URL: /api/users/distributor-application/
    Authentication: Required
    Description: Get current user's distributor application status
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "approved",  // "pending" (if auto-approval disabled), "approved" (auto-approved or manually approved), or "rejected" (if admin rejected)
      "company_name": "ABC Distributors Pvt Ltd",
      "is_distributor_terms_and_conditions_accepted": true,
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": "2026-01-14T10:00:00Z",  // Set automatically when auto-approved, or when manually approved/rejected
      "reviewed_by": null,  // null for auto-approved applications, nested object with id, fullname, email, profile_picture_url for manually reviewed applications
      "rejection_reason": ""
    }
    
    Response (404 Not Found) - If no application exists:
    {
      "detail": "Not found."
    }


76. GET DISTRIBUTOR APPLICATION BY ID
    Method: GET
    URL: /api/users/distributor-application/{id}/
    Authentication: Required
    Description: Get specific distributor application by ID. Access based on permissions:
    
    Permission Hierarchy:
    - Admin/Superuser: Can view any application
    - Staff: Can view any application
    - Normal Users: Can only view their own application
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "status": "approved",
      "company_name": "ABC Distributors Pvt Ltd",
      "business_registration_number": "REG123456",
      "tax_id": "TAX789012",
      "years_in_business": 5,
      "previous_distribution_experience": "5 years of experience in EV distribution",
      "product_interest": "Electric vehicles and accessories",
      "reference_name": "John Smith",
      "reference_contact": "+919876543210",
      "reference_relationship": "Business Partner",
      "is_distributor_terms_and_conditions_accepted": true,
      "business_license": "http://localhost:8000/media/distributor/business_license/license_1.pdf",
      "tax_documents": "http://localhost:8000/media/distributor/tax_documents/tax_1.pdf",
      "submitted_at": "2026-01-14T10:00:00Z",
      "reviewed_at": "2026-01-14T11:00:00Z",
      "reviewed_by": {      // Reviewer user details, null if not reviewed
        "id": 2,
        "fullname": "Admin User",
        "email": "admin@example.com",
        "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_2_profile.jpg"
      },
      "rejection_reason": ""
    }
    
    Error Response (404 Not Found):
    {
      "detail": "Not found."
    }


77. UPDATE DISTRIBUTOR APPLICATION STATUS (Admin/Staff Only)
    Method: POST
    URL: /api/users/distributor-application/{id}/update-status/
    Authentication: Required (Admin, Staff, or Superuser)
    Description: Approve, reject, or re-approve distributor application. If distributor_application_auto_approve setting is False, this endpoint is required to approve pending applications. If setting is True, applications are auto-approved but can still be rejected here. Setting status to 'approved' sets user.is_distributor = True. Setting status to 'rejected' sets user.is_distributor = False.
    
    Permission Requirements:
    - Superuser (is_superuser=True)
    - Admin users (role='admin' with is_staff=True)
    - Staff users (role='staff' with is_staff=True)
    
    Request Body:
    {
      "status": "approved"  // Required: "approved" or "rejected"
      "reason": "Insufficient business experience"  // Optional, only used when status is "rejected"
    }
    
    Example Request (Approve):
    POST /api/users/distributor-application/1/update-status/
    {
      "status": "approved"
    }
    Note: If distributor_application_auto_approve is False, this endpoint is required to approve pending applications. If setting is True, applications are auto-approved but this endpoint can be used to re-approve previously rejected applications.
    
    Example Request (Reject):
    POST /api/users/distributor-application/1/update-status/
    {
      "status": "rejected",
      "reason": "Insufficient business experience"
    }
    Note: Rejecting an application will set user.is_distributor = False, removing distributor privileges.
    
    Response (200 OK) - When Approved:
    {
      "status": "approved",
      "message": "Application approved. User user@example.com is now a distributor."
    }
    
    Response (200 OK) - When Rejected:
    {
      "status": "rejected",
      "message": "Application rejected."
    }
    
    Error Response (400 Bad Request):
    {
      "error": "Application is already approved"  // or "Application is already rejected"
    }
    
    Error Response (400 Bad Request):
    {
      "error": "Invalid status. Must be 'approved' or 'rejected'"
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Approval behavior depends on distributor_application_auto_approve setting in Platform Settings
    - If auto-approval is enabled: Applications are automatically approved upon creation (via CREATE endpoint)
    - If auto-approval is disabled: Applications remain pending and require approval via this endpoint
    - This endpoint can be used to approve pending applications, reject applications, or re-approve previously rejected ones
    - Upon approval (or re-approval), user.is_distributor is automatically set to True
    - Upon rejection, user.is_distributor is automatically set to False
    - User can earn from binary pairs and referrals only when is_distributor = True
    - Only one application per user is allowed
    - Normal users cannot update application status
    - Reason field is optional and only used when status is "rejected"


78. LIST ALL DISTRIBUTOR APPLICATIONS (Admin/Staff Only)
    Method: GET
    URL: /api/users/distributor-application/list_all/
    Authentication: Required (Admin, Staff, or Superuser)
    Description: List all distributor applications with filtering and pagination. Admin/Staff/Superuser only.
    
    Permission Requirements:
    - Superuser (is_superuser=True)
    - Admin users (role='admin' with is_staff=True)
    - Staff users (role='staff' with is_staff=True)
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20, max: 100)
    - status: Filter by status (pending, approved, rejected)
    - submitted_date_from: Filter by submission date start (YYYY-MM-DD)
    - submitted_date_to: Filter by submission date end (YYYY-MM-DD)
    - reviewed_date_from: Filter by review date start (YYYY-MM-DD)
    - reviewed_date_to: Filter by review date end (YYYY-MM-DD)
    - user_id: Filter by specific user ID
    - ordering: Sort results (default: -submitted_at)
      Options: submitted_at, -submitted_at, reviewed_at, -reviewed_at, status, -status
    
    Example Requests:
    GET /api/users/distributor-application/list_all/
    GET /api/users/distributor-application/list_all/?status=pending
    GET /api/users/distributor-application/list_all/?submitted_date_from=2026-01-01&submitted_date_to=2026-01-31
    GET /api/users/distributor-application/list_all/?user_id=5&ordering=-submitted_at
    GET /api/users/distributor-application/list_all/?reviewed_date_from=2026-01-01&reviewed_date_to=2026-01-31&status=approved
    
    Response (200 OK):
    {
      "count": 50,
      "next": "http://localhost:8000/api/users/distributor-application/list_all/?page=2",
      "previous": null,
      "results": [
        {
          "id": 1,
          "user": 1,
          "user_email": "user@example.com",
          "user_username": "user@example.com",
          "user_full_name": "John Doe",
          "status": "pending",
          "company_name": "ABC Distributors Pvt Ltd",
          "business_registration_number": "REG123456",
          "tax_id": "TAX789012",
          "years_in_business": 5,
          "submitted_at": "2026-01-14T10:00:00Z",
          "reviewed_at": null,
          "reviewed_by": null,
          "rejection_reason": ""
        }
      ]
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Only Admin/Staff/Superuser can access this endpoint
    - Normal users cannot access this endpoint
    - All filters can be combined
    - Date filters use inclusive ranges (>= for from, <= for to)
    - Default ordering is by submission date (newest first)
    - Invalid filter values are ignored (e.g., invalid user_id)


================================================================================
                            NOMINEE APIs
================================================================================

22. CREATE/UPDATE NOMINEE
    Method: POST / PUT / PATCH
    URL: /api/users/nominee/
    Authentication: Required
    Description: Create or update nominee information
    
    Request Body:
    {
      "full_name": "Jane Doe",
      "relationship": "spouse",  // "spouse", "son", "daughter", "father", "mother", "brother", "sister", "other"
      "date_of_birth": "1990-01-01",
      "mobile": "+919876543211",
      "email": "jane@example.com",
      "address_line1": "123 Main Street",
      "city": "Mumbai",
      "state": "Maharashtra",
      "pincode": "400001",
      "id_proof_type": "Aadhaar",
      "id_proof_number": "987654321098",
      "id_proof_document": <file>,
      "kyc_status": "pending"  // Read-only: pending/verified/rejected (set to pending when id proof submitted)
    }
    
    Response (201 Created / 200 OK):
    {
      "id": 1,
      "user": 1,
      "full_name": "Jane Doe",
      "relationship": "spouse",
      "id_proof_type": "Aadhaar",
      "id_proof_number": "987654321098",
      "id_proof_document": "http://localhost:8000/media/nominee/id_proof/id_1.jpg",
      "kyc_status": "pending",
      "kyc_submitted_at": "2026-01-07T12:00:00Z",
      ...
    }


23. GET NOMINEE
    Method: GET
    URL: /api/users/nominee/
    Authentication: Required
    Description: Get user's nominee information
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "full_name": "Jane Doe",
      "relationship": "spouse",
      "kyc_status": "pending",
      "kyc_submitted_at": "2026-01-07T12:00:00Z",
      "kyc_verified_at": null,
      "kyc_verified_by": null,
      "kyc_rejection_reason": "",
      ...
    }


24. UPDATE NOMINEE KYC STATUS (Admin Only)
    Method: POST
    URL: /api/users/nominee/{id}/update-kyc-status/
    Authentication: Required (Admin)
    Description: Update nominee KYC status - verify or reject nominee KYC submissions. This endpoint is restricted to admin/superuser.
    
    Request Body:
    {
      "status": "verified"  // or "rejected"
      "reason": "ID document is blurred"  // Optional, only required/used when status is "rejected"
    }
    
    Response (200 OK):
    {
      "status": "verified"  // or "rejected"
    }
    
    Error Response (400):
    {
      "error": "Invalid status. Must be 'verified' or 'rejected'"
    }
    or
    {
      "error": "Nominee KYC is already verified"  // or "Nominee KYC is already rejected"
    }

    Notes:
    - Business logic in booking/payouts should only consider nominees with `kyc_status == 'verified'` as verified nominees.
    - Admin actions set `kyc_verified_by` and timestamps.


================================================================================
                            BOOKING APIs
================================================================================

24. CREATE BOOKING
    Method: POST
    URL: /api/booking/bookings/
    Authentication: Required
    Description: Create a new EV booking (minimum ₹500)
    
    Request Body:
    {
      "vehicle_model_code": "EV-RED-40K-A9F3X2",  // Vehicle model code (string) - Required - Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_color": "Red",            // Required - must match the color in the vehicle's model_code
      "battery_variant": "40kWh",         // Required - must match the battery variant in the vehicle's model_code
      "booking_amount": 500,              // Minimum ₹500
      "total_amount": 50000,              // Required - must match vehicle price
      "payment_option": "full_payment",   // "full_payment" or "emi_options"
      "delivery_city": "Mumbai",          // Required
      "delivery_state": "Maharashtra",    // Required
      "delivery_pin": "400001",           // Required
      "terms_accepted": true,             // Required
      "referral_code": "ABC12345",        // Optional - Referral code of referring user
      "manual_placement": false,           // Optional - If true, skip automatic binary tree placement (default: false)
      "join_distributor_program": false,  // Optional
      "payment_gateway_ref": "TXN123",    // Optional
      "emi_amount": 5000,                 // Optional
      "emi_duration_months": 10,          // Optional
      "emi_start_date": "2026-02-01"      // Optional
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "booking_number": "EVABC1234",
      "vehicle_model": 1,
      "model_code": "EV-RED-40K-A9F3X2",          // Vehicle model code (read-only) - Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_details": {
        "id": 1,
        "name": "EV Model X",
        "model_code": "EV-RED-40K-A9F3X2",
        "vehicle_color": ["red"],  // Single color per vehicle
        "battery_variant": ["40kWh"],  // Single battery variant per vehicle
        "price": "50000.00"
      },
      "vehicle_color": "Red",
      "battery_variant": "40kWh",
      "booking_amount": "500.00",
      "total_amount": "50000.00",
      "total_paid": "0.00",
      "remaining_amount": "50000.00",
      "status": "pending",  // "pending", "active", "completed", "delivered", "cancelled", "expired"
      "referred_by": {      // Referrer user details (if referral_code was used), null otherwise
        "id": 5,
        "fullname": "Jane Smith",
        "email": "jane@example.com",
        "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_5_profile.jpg"
      },
      "delivery_city": "Mumbai",
      "delivery_state": "Maharashtra",
      "delivery_pin": "400001",
      "terms_accepted": true,
      "expires_at": "2026-02-05T12:00:00Z",
      "reservation_status": "reserved",  // "reserved", "released", "completed" - Stock reservation status
      "reservation_expires_at": "2026-01-07T12:00:00Z",  // When reservation expires (null = never expires)
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Note on Stock Reservation:
    - When booking is created, a stock reservation is automatically created
    - Vehicle stock (available_quantity) is reduced by 1
    - Reservation expires based on BOOKING_RESERVATION_TIMEOUT_HOURS setting (null = never expires)
    - If reservation expires and payment is not completed, stock is automatically released
    - Reservation is completed when first payment is confirmed (status='completed')
    
    Note on Referral Code:
    - If referral_code is provided, the system validates it and sets referred_by automatically
    - User cannot use their own referral code (self-referral prevention)
    - If user.referred_by is not set, it will be set from the referral_code
    - The system stores whether the referrer was a distributor when the booking was created (referrer_was_distributor field)
    - Commission is granted to the referrer after successful payment capture ONLY if referrer_was_distributor is True
      * Commission = payment_amount × REFERRAL_COMMISSION_PERCENTAGE / 100
      * Commission is granted on every successful payment for the booking
      * No retroactive commissions: Only bookings created AFTER the referrer becomes a distributor get commission
    
    Note on Binary Tree Placement:
    - Users are NOT automatically placed in the binary tree when booking is created
    - IMPORTANT: Placement APIs can ONLY be called AFTER user has at least one successful payment
    - Referrer must place users AFTER payment completion, either:
      1. Automatically via /api/binary/nodes/auto_place_pending/ (uses left-priority algorithm)
      2. Manually via /api/binary/nodes/place_user/ (choose specific position)
    - Placement Rules (when using auto_place_pending):
      1. First 2 direct referrals: 1st user → LEFT, 2nd user → RIGHT
      2. From 3rd referral onward: Follow LEFT-side chain (traverse left children to find left-most available position)
      3. Referral-based override: If user joins using a specific parent's referral code (e.g., User B's code):
         - Place in that parent's tree (not root)
         - Check parent's LEFT first, then RIGHT if left is occupied
      4. Default placement side is configurable via Platform Settings (binary_tree_default_placement_side)
         - If set to RIGHT: Same logic applies in mirror form (right-chain pattern)
    - Referrer can view pending users via /api/binary/nodes/pending_users/
    - Parents can choose left/right for their direct referrals via /api/binary/nodes/choose_side_for_direct_referral/
    - Parents can swap or move their direct children via /api/binary/nodes/swap_direct_children/ and /api/binary/nodes/move_user/
    
    Note on Direct User Commission:
    - Commission is paid when user is placed in binary tree (via placement APIs)
    - Commission is ONLY paid if user has at least one successful payment AND payment meets activation_amount threshold
    - Activation Amount Check: User's booking must have total_paid >= activation_amount (configurable in Platform Settings)
    - If payment < activation_amount: No commission is paid, but user is still counted in descendants calculation
    - Commission timing: Paid when placement happens, regardless of when payment was completed
    - When User A is added as a direct child of User B, User B receives direct user commission (configurable, default: ₹1000)
    - Direct user commission is paid to ALL eligible ancestors (not just direct parent) if they have < 3 total descendants
    - After 3 total descendants are added, binary commission activates automatically
    - 20% TDS is deducted from direct user commission (configurable percentage)
    - Net amount (₹800 = ₹1000 - ₹200 TDS) is credited to referrer's wallet immediately upon placement
    - TDS is deducted from referrer's oldest active booking remaining amount
    - Only distributors can receive commissions
    - Note: Direct user commissions are NOT restricted for non-Active Buyer distributors (can earn unlimited before binary activation)
    
    Error Response (400):
    {
      "vehicle_model_code": ["Vehicle with model_code 'EV-INVALID' not found"],
      "booking_amount": ["Minimum booking amount is ₹500"],
      "total_amount": ["Total amount must match vehicle price (₹50000.00)"],
      "delivery_city": ["Delivery city is required"],
      "vehicle_model": ["Insufficient stock. Available: 0, Required: 1"]
    }
    
    Note on Stock Availability:
    - System checks vehicle stock availability before creating booking
    - If insufficient stock, booking creation fails with error message
    - Stock is automatically reserved when booking is created successfully
    
    Rate Limit: 10 requests per minute per IP


25. LIST BOOKINGS
    Method: GET
    URL: /api/booking/bookings/
    Authentication: Required
    Description: List user's bookings (admin sees all). Supports pagination, filtering, and search.
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20, max: 100)
    - status: Filter by status (pending, active, completed, delivered, cancelled, expired)
    - search: Search bookings (case-insensitive partial match)
      Searches across: booking_number, user name/email/username, vehicle name/model_code, delivery city/state/pincode
      Example: search=EVABC1234 (matches booking number)
      Example: search=john (matches user name or email)
      Example: search=mumbai (matches delivery city)
      Example: search=EV Model X (matches vehicle name)
    
    Examples:
    - Get all bookings: /api/booking/bookings/
    - Get pending bookings: /api/booking/bookings/?status=pending
    - Search by booking number: /api/booking/bookings/?search=EVABC1234
    - Search by user name: /api/booking/bookings/?search=john
    - Search with status filter: /api/booking/bookings/?status=active&search=mumbai
    - Paginated search: /api/booking/bookings/?page=1&page_size=10&search=EV Model X
    
    Response (200 OK):
    {
      "count": 10,
      "results": [
        {
          "id": 1,
          "booking_number": "EVABC1234",
          "vehicle_model": 1,
          "vehicle_details": {
            "id": 1,
            "name": "EV Model X",
            "model_code": "EV-RED-40K-A9F3X2",
            "vehicle_color": ["red"],
            "battery_variant": ["40kWh"],
            "price": "50000.00"
          },
          "total_amount": "50000.00",
          "status": "pending",
          ...
        }
      ]
    }


26. GET BOOKING DETAILS
    Method: GET
    URL: /api/booking/bookings/{id}/
    Authentication: Required
    Description: Get specific booking details
    
    Response (200 OK):
    {
      "id": 1,
      "booking_number": "EVABC1234",
      "user": 1,
          "vehicle_model": 1,
          "vehicle_details": {
            "id": 1,
            "name": "EV Model X",
            "model_code": "EV-RED-40K-A9F3X2",
            "vehicle_color": ["red"],
            "battery_variant": ["40kWh"],
        "price": "50000.00"
      },
      "vehicle_color": "Red",
      "battery_variant": "40kWh",
      "total_amount": "50000.00",
      "total_paid": "5000.00",
      "remaining_amount": "45000.00",
      "status": "active",
      "delivery_city": "Mumbai",
      "delivery_state": "Maharashtra",
      "delivery_pin": "400001",
      "terms_accepted": true,
      "referred_by": {      // Referrer user details (if referral_code was used), null otherwise
        "id": 5,
        "fullname": "Jane Smith",
        "email": "jane@example.com",
        "profile_picture_url": "http://localhost:8000/media/profile_pictures/user_5_profile.jpg"
      },
      "join_distributor_program": false,
      "expires_at": "2026-02-05T12:00:00Z",
      "reservation_status": "reserved",  // "reserved", "released", "completed" - Stock reservation status
      "reservation_expires_at": "2026-01-07T12:00:00Z",  // When reservation expires (null = never expires)
      "emi_amount": "5000.00",
      "emi_paid_count": 1,
      "emi_total_count": 10,
      ...
    }


27. MAKE PAYMENT FOR BOOKING
    Method: POST
    URL: /api/booking/bookings/{id}/make_payment/
    Authentication: Required
    Description: Make a payment for booking
    
    Request Body:
    {
      "amount": 5000,
      "payment_method": "online"  // "online", "bank_transfer", "cash", "wallet"
    }
    
    Response (201 Created):
    {
      "id": 1,
      "booking": 1,
      "user": 1,
      "amount": "5000.00",
      "payment_method": "online",
      "status": "pending",  // Payment status: "pending", "completed", "failed", "refunded"
      "transaction_id": null,
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": null
    }
    
    Error Response (400):
    {
      "error": "Amount exceeds remaining amount"
    }
    
    Note: 
    - Payment is created with status='pending' (NOT automatically completed)
    - Payment status must be changed to 'completed' by:
      * Admin/Staff via /api/booking/payments/{id}/update_status/ endpoint
      * Payment gateway webhook (when integrated)
    - Only when payment status becomes 'completed':
      * Booking payment is processed (total_paid updated)
      * If total_paid ≥ ₹5000: booking status changes to 'active' (Active Buyer)
      * If remaining_amount ≤ 0: booking status changes to 'completed'
      * Stock reservation is marked as 'completed'
      * Referral commission is granted (if applicable)
    - Active Buyer status is updated when total paid reaches ₹5000
    - If booking was created with a referral_code, commission is automatically granted to the referrer when payment is confirmed
      * Commission = payment_amount × REFERRAL_COMMISSION_PERCENTAGE / 100
      * Commission is granted on every confirmed payment for the booking
      * Commission is only granted if referrer_was_distributor is True (referrer was distributor when booking was created)
      * No retroactive commissions: Only bookings created AFTER referrer becomes distributor get commission


28. ACCEPT PAYMENT (Admin/Staff Only)
    Method: POST
    URL: /api/booking/bookings/{id}/accept_payment/
    Authentication: Required (Admin or Staff)
    Description: Accept payment on behalf of a user (for manual payment processing)
    
    Request Body:
    {
      "amount": 5000,
      "payment_method": "cash",  // "online", "bank_transfer", "cash", "wallet"
      "transaction_id": "TXN123456",  // Optional - transaction reference
      "notes": "Payment received at counter"  // Optional - additional notes
    }
    
    Response (201 Created):
    {
      "id": 1,
      "booking": 1,
      "booking_number": "EVABC1234",
      "user": 1,
      "amount": "5000.00",
      "payment_method": "cash",
      "status": "completed",
      "transaction_id": "TXN123456",
      "notes": "Payment received at counter",
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "Amount exceeds remaining amount"
    }
    
    Error Response (403):
    {
      "error": "Permission denied. Only admin or staff can accept payments."
    }
    
    Note:
    - Only admin or staff can use this endpoint
    - Payment is automatically marked as 'completed' (admin/staff approval)
    - When payment status becomes 'completed':
      * Booking payment is processed (total_paid updated)
      * Stock reservation is marked as 'completed'
      * Booking status and referral commission are processed automatically


29. LIST PAYMENTS
    Method: GET
    URL: /api/booking/payments/
    Authentication: Required
    Description: List payment history (users see their own, admin/staff see all)
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "booking_number": "EVABC1234",
          "amount": "5000.00",
          "payment_method": "online",
          "status": "completed",
          "payment_date": "2026-01-06T12:00:00Z"
        }
      ]
    }


30. CREATE PAYMENT (Admin/Staff Only)
    Method: POST
    URL: /api/booking/payments/
    Authentication: Required (Admin or Staff)
    Description: Create a payment record (admin/staff only)
    
    Request Body:
    {
      "booking": 1,  // Booking ID - Required
      "amount": 5000,
      "payment_method": "cash",  // "online", "bank_transfer", "cash", "wallet"
      "status": "completed",  // "pending", "completed", "failed", "refunded"
      "transaction_id": "TXN123456",  // Optional
      "notes": "Payment received"  // Optional
    }
    
    Response (201 Created):
    {
      "id": 1,
      "booking": 1,
      "booking_number": "EVABC1234",
      "user": 1,
      "amount": "5000.00",
      "payment_method": "cash",
      "status": "completed",
      "transaction_id": "TXN123456",
      "notes": "Payment received",
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (403):
    {
      "detail": "Only admin or staff can create payments"
    }
    
    Note:
    - User is automatically set from booking.user
    - If status is 'completed', booking payment is processed automatically
    - Stock reservation is marked as 'completed' when payment status becomes 'completed'


31. UPDATE PAYMENT STATUS (Admin/Staff Only)
    Method: PATCH
    URL: /api/booking/payments/{id}/update_status/
    Authentication: Required (Admin or Staff)
    Description: Update payment status (admin/staff only)
    
    Request Body:
    {
      "status": "completed",  // "pending", "completed", "failed", "refunded"
      "transaction_id": "TXN123456",  // Optional - update transaction ID
      "notes": "Payment verified"  // Optional - update notes
    }
    
    Response (200 OK):
    {
      "id": 1,
      "booking": 1,
      "booking_number": "EVABC1234",
      "user": 1,
      "amount": "5000.00",
      "payment_method": "cash",
      "status": "completed",
      "transaction_id": "TXN123456",
      "notes": "Payment verified",
      "payment_date": "2026-01-06T12:00:00Z",
      "completed_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "Invalid status. Valid choices: ['pending', 'completed', 'failed', 'refunded']"
    }
    
    Error Response (403):
    {
      "error": "Permission denied. Only admin or staff can update payment status."
    }
    
    Note:
    - Valid status transitions:
      * pending -> completed, failed
      * completed -> refunded, failed
      * failed -> pending, completed
      * refunded -> (no transitions allowed)
    - If status changes to 'completed':
      * Booking payment is processed automatically (total_paid updated)
      * Stock reservation is marked as 'completed' (if exists)
      * Booking status updated (active/completed based on payment amount)
      * Referral commission is granted (if applicable)


================================================================================
                         RAZORPAY PAYMENT GATEWAY APIs
================================================================================

32. CREATE RAZORPAY ORDER
    Method: POST
    URL: /api/payments/create-order/
    Authentication: Required
    Description: Create a Razorpay order for payment. Supports partial payments for bookings. Amount can be specified or calculated automatically from database entity (booking, payout, etc.) to prevent frontend manipulation.
    
    Request Body:
    {
      "entity_type": "booking",  // "booking" or "payout"
      "entity_id": 123,           // ID of the booking or payout
      "amount": 5000              // Optional: Amount in rupees for partial payment. If not provided, uses full remaining amount for bookings or full amount for payouts
    }
    
    Example 1 - Partial Payment (Booking):
    {
      "entity_type": "booking",
      "entity_id": 123,
      "amount": 5000  // User wants to pay ₹5000 more (partial payment)
    }
    
    Example 2 - Full Remaining Amount (Booking):
    {
      "entity_type": "booking",
      "entity_id": 123
      // No amount specified - will use full remaining_amount
    }
    
    Response (201 Created):
    {
      "order_id": "order_ABC123XYZ",
      "key_id": "rzp_test_1234567890",
      "amount": 500000  // Amount in paise (₹5000.00 = 500000 paise)
    }
    
    Error Response (400):
    {
      "entity_id": ["Booking with id 123 not found"]
    }
    OR
    {
      "error": "Amount must be greater than 0"
    }
    OR
    {
      "amount": ["Amount cannot exceed remaining amount (₹45000.00)"]
    }
    
    Error Response (500):
    {
      "error": "Failed to create payment order. Please try again."
    }
    
    Notes:
    - Amount validation is done server-side (not trusted from frontend)
    - For "booking": 
      * If amount is provided: Validates that amount ≤ remaining_amount (or booking_amount if first payment)
      * If amount is NOT provided (backward compatible):
        - If total_paid == 0 (first payment): Uses Booking.booking_amount (initial booking fee)
        - If total_paid > 0 (subsequent payments): Uses Booking.remaining_amount (outstanding balance)
    - For "payout": 
      * If amount is provided: Validates that amount ≤ net_amount
      * If amount is NOT provided: Uses Payout.net_amount
    - Supports partial payments: Users can pay any amount up to the remaining balance
    - Payment record is created with status='CREATED'
    - Returns Razorpay order_id and key_id for frontend integration
    - Frontend should use these values to initialize Razorpay Checkout
    - Amount in request is in rupees, but response amount is in paise (multiply by 100 to convert from rupees)


33. VERIFY RAZORPAY PAYMENT
    Method: POST
    URL: /api/payments/verify/
    Authentication: Required
    Description: Verify Razorpay payment signature and update payment status. This endpoint should be called after successful payment on frontend.
    
    Request Body:
    {
      "razorpay_order_id": "order_ABC123XYZ",
      "razorpay_payment_id": "pay_DEF456UVW",
      "razorpay_signature": "abc123def456..."
    }
    
    Response (200 OK):
    {
      "order_id": "order_ABC123XYZ",
      "payment_id": "pay_DEF456UVW",
      "status": "SUCCESS",
      "amount": 500000,
      "message": "Payment verified successfully"
    }
    
    Error Response (400):
    {
      "razorpay_order_id": ["This field is required."]
    }
    
    Error Response (404):
    {
      "error": "Payment order not found"
    }
    
    Error Response (500):
    {
      "error": "Failed to verify payment. Please try again."
    }
    
    Notes:
    - Verifies payment signature using HMAC SHA256
    - Updates Payment status to 'SUCCESS' if signature is valid
    - Updates Payment status to 'FAILED' if signature is invalid
    - Idempotent: If payment already processed, returns current status
    - Uses atomic transactions to prevent double processing
    - Should be called immediately after frontend payment success


34. RAZORPAY WEBHOOK
    Method: POST
    URL: /api/payments/webhook/
    Authentication: Not Required (CSRF Exempt)
    Description: Webhook endpoint for Razorpay to send payment events. Handles payment status updates automatically.
    
    Headers:
    X-Razorpay-Signature: <webhook_signature>
    
    Request Body (JSON):
    {
      "event": "payment.captured",
      "payload": {
        "payment": {
          "id": "pay_DEF456UVW",
          "order_id": "order_ABC123XYZ",
          "status": "captured",
          "amount": 500000,
          ...
        }
      }
    }
    
    Response (200 OK):
    {
      "status": "success"
    }
    
    Notes:
    - CSRF exempt endpoint (required for webhooks)
    - Verifies webhook signature using RAZORPAY_WEBHOOK_SECRET
    - Handles multiple event types:
      * payment.captured: Updates Payment status to 'SUCCESS'
      * payment.failed: Updates Payment status to 'FAILED'
      * order.paid: Updates Payment status to 'SUCCESS'
      * refund.processed: Updates Payment status to 'REFUNDED'
      * payout.processed: Logs payout completion
    - Stores raw webhook payload in Payment.raw_payload for audit
    - Idempotent: Prevents duplicate processing
    - Always returns 200 OK to prevent Razorpay retries
    - Unknown events are logged for debugging
    - Configure webhook URL in Razorpay Dashboard:
      https://yourdomain.com/api/payments/webhook/


35. CREATE RAZORPAY PAYOUT (Admin/Staff Only)
    Method: POST
    URL: /api/payments/create-payout/
    Authentication: Required (Admin or Staff)
    Description: Create Razorpay payout/transfer for an existing Payout model. Initiates bank transfer using Razorpay API.
    
    Request Body:
    {
      "payout_id": 123  // ID of the Payout model instance
    }
    
    Response (201 Created):
    {
      "payout_id": 123,
      "transaction_id": "pout_XYZ789ABC",
      "status": "processing",
      "message": "Payout created successfully"
    }
    
    Error Response (400):
    {
      "error": "Payout status must be \"processing\" to create Razorpay transfer. Current status: pending"
    }
    
    Error Response (403):
    {
      "detail": "Only admin or staff can create payouts"
    }
    
    Error Response (404):
    {
      "error": "Payout with id 123 not found"
    }
    
    Error Response (500):
    {
      "error": "Failed to create payout. Please try again."
    }
    
    Notes:
    - Only admin or staff can use this endpoint
    - Payout must have status='processing' (set by /api/payout/{id}/process/)
    - Extracts bank details from Payout model:
      * account_number, ifsc_code, account_holder_name, bank_name
    - Creates Razorpay fund account and initiates payout
    - Updates Payout.transaction_id with Razorpay payout ID
    - Amount is converted from rupees to paise automatically
    - Payout status will be updated by webhook or manual verification
    - Use this endpoint after calling /api/payout/{id}/process/ to initiate actual bank transfer


36. CREATE RAZORPAY REFUND (Admin/Staff Only)
    Method: POST
    URL: /api/payments/refund/
    Authentication: Required (Admin or Staff)
    Description: Create Razorpay refund (full or partial) for a successful payment. Only successful payments can be refunded.
    
    Request Body:
    {
      "payment_id": "pay_DEF456UVW",  // Razorpay payment_id from Payment model
      "amount": 5000                   // Optional: Amount in rupees for partial refund (null/omitted = full refund)
    }
    
    Response (201 Created):
    {
      "refund_id": "rfnd_GHI789JKL",
      "payment_id": "pay_DEF456UVW",
      "amount": 500000,  // Refund amount in paise
      "status": "REFUNDED",
      "message": "Refund created successfully"
    }
    
    Error Response (400):
    {
      "error": "Can only refund successful payments. Current status: CREATED"
    }
    OR
    {
      "error": "Payment already refunded"
    }
    OR
    {
      "amount": ["Refund amount must be greater than 0 and not exceed payment amount"]
    }
    
    Error Response (403):
    {
      "detail": "Only admin or staff can create refunds"
    }
    
    Error Response (404):
    {
      "error": "Payment with payment_id pay_DEF456UVW not found"
    }
    
    Error Response (500):
    {
      "error": "Failed to create refund. Please try again."
    }
    
    Notes:
    - Only admin or staff can use this endpoint
    - Can only refund payments with status='SUCCESS'
    - If amount is provided: Creates partial refund
    - If amount is omitted/null: Creates full refund
    - Amount in request is in rupees, converted to paise automatically
    - Updates Payment status to 'REFUNDED'
    - Stores refund details in Payment.raw_payload
    - Idempotent: Prevents duplicate refunds
    - Refund status will be confirmed via webhook (refund.processed event)


37. CANCEL BOOKING
    Method: POST
    URL: /api/booking/bookings/{id}/cancel/
    Authentication: Required
    Description: Cancel a booking and release stock reservation. Implements partial refund logic where only (total_paid - activation_amount) is refunded. The activation_amount is withheld and stored for future point redemption (after 1 year).
    
    Response (200 OK):
    {
      "id": 1,
      "booking_number": "EVABC1234",
      "status": "cancelled",
      "reservation_status": "released",
      "vehicle_color": "Red",
      "battery_variant": "40kWh",
      "total_amount": "50000.00",
      "total_paid": "0.00",
      "remaining_amount": "50000.00",
      ...
    }
    
    Error Response (400):
    {
      "error": "Cannot cancel booking with status: completed"
    }
    
    Error Response (403):
    {
      "error": "Permission denied"
    }
    
    Note:
    - User can cancel their own booking, admin/staff can cancel any booking
    - When booking is cancelled:
      * Booking status is set to 'cancelled'
      * Stock reservation is released (if exists)
      * Vehicle stock (available_quantity) is restored
    - Cannot cancel bookings with status 'cancelled' or 'delivered'
    - Refund Logic:
      * Only (total_paid - activation_amount) is refunded to user's wallet
      * activation_amount is withheld and stored in ActivationPoints model for future redemption
      * activation_amount becomes redeemable after 1 year from cancellation date
      * If total_paid <= activation_amount, no refund is processed, but activation_amount is still stored
      * Refund is credited to user's wallet as a REFUND transaction
    - Response includes:
      * refund_amount: Amount refunded to wallet (total_paid - activation_amount, or 0 if total_paid <= activation_amount)
      * activation_amount_withheld: Amount withheld for future redemption (min(activation_amount, total_paid))


33. UPDATE BOOKING STATUS (Admin/Staff Only)
    Method: PATCH or POST
    URL: /api/booking/bookings/{id}/update_status/
    Authentication: Required (Admin/Staff only)
    Description: Update booking status. Only admin/staff can update booking status. Automatically sets delivered_at timestamp when status changes to 'delivered'.
    
    Request Body:
    {
      "status": "delivered"  // Required: pending, active, completed, delivered, cancelled, expired
    }
    
    Response (200 OK):
    {
      "id": 1,
      "booking_number": "EVABC1234",
      "status": "delivered",
      "delivered_at": "2026-01-16T10:30:00Z",
      "completed_at": "2026-01-15T14:20:00Z",
      "vehicle_model": 1,
      "vehicle_details": {
        "id": 1,
        "name": "EV Model X",
        "model_code": "EV-RED-40-ABC123",
        "price": "50000.00"
      },
      "total_amount": "50000.00",
      "total_paid": "50000.00",
      "remaining_amount": "0.00",
      ...
    }
    
    Error Response (400):
    {
      "error": "status field is required"
    }
    OR
    {
      "error": "Invalid status. Valid choices: ['pending', 'active', 'completed', 'delivered', 'cancelled', 'expired']"
    }
    OR
    {
      "error": "Cannot change status from completed to pending. Valid transitions from completed: ['delivered', 'cancelled']"
    }
    
    Error Response (403):
    {
      "error": "Permission denied. Only admin or staff can update booking status."
    }
    
    Valid Status Transitions:
    - pending → active, cancelled, expired
    - active → completed, cancelled
    - completed → delivered, cancelled
    - delivered → (cannot be changed)
    - cancelled → (cannot be changed)
    - expired → (cannot be changed)
    
    Notes:
    - Only admin/staff can update booking status
    - When status changes to 'delivered', delivered_at timestamp is automatically set
    - Status transitions are validated - invalid transitions will be rejected
    - 'delivered' status can only be set when current status is 'completed'
    - Once a booking is 'delivered', 'cancelled', or 'expired', it cannot be changed to another status


================================================================================
                        VEHICLE INVENTORY APIs
================================================================================

33. UPLOAD IMAGES
    Method: POST
    URL: /api/inventory/images/upload/
    Authentication: Required (Admin/Superuser only)
    Description: Upload images independently (without vehicle association). Returns image IDs and URLs that can be used in vehicle creation.
    
    Content-Type: multipart/form-data
    
    Request Body (form-data):
    - images[]: @image1.jpg (required, at least one file)
    - images[]: @image2.jpg (optional, multiple files)
    
    Alternative formats also supported:
    - images_data[]: @image1.jpg
    - images[0]: @image1.jpg, images[1]: @image2.jpg
    
    Response (201 Created):
    [
      {
        "id": 1,
        "image_url": "http://localhost:8000/media/vehicles/images/image1.jpg",
        "created_at": "2026-01-08T12:00:00Z"
      },
      {
        "id": 2,
        "image_url": "http://localhost:8000/media/vehicles/images/image2.jpg",
        "created_at": "2026-01-08T12:00:01Z"
      }
    ]
    
    Error Response (400):
    {
      "error": "No images provided. Please upload at least one image file."
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can upload images."
    }
    
    Usage Flow:
    1. Upload images using this endpoint
    2. Get image IDs from response (e.g., [1, 2])
    3. Use these IDs in vehicle creation: {"image_ids": [1, 2], ...}


34. LIST VEHICLES
    Method: GET
    URL: /api/inventory/vehicles/
    Authentication: Required (All authenticated users)
    Description: List all available vehicles grouped by name. Each vehicle name contains all its variants (color-battery combinations). Supports pagination, filtering, and search.
    
    Query Parameters:
    - page: (optional) Page number (default: 1)
    - page_size: (optional) Number of vehicle groups per page (default: 10, max: 100)
    - name: (optional) Filter by vehicle name (case-insensitive, partial match)
    - model_code: (optional) Filter by model code (case-insensitive, partial match)
    - status: (optional) Filter by status (available, out_of_stock, discontinued)
    - color: (optional) Filter by vehicle color (e.g., "white", "red", "blue")
    - battery: (optional) Filter by battery variant (e.g., "40kWh", "60kWh")
    - min_price: (optional) Filter by minimum price (numeric)
    - max_price: (optional) Filter by maximum price (numeric)
    - search: (optional) Search across name, model_code, description, and features (case-insensitive)
    
    Examples:
    - /api/inventory/vehicles/?page=1&page_size=20
    - /api/inventory/vehicles/?name=EV Model X
    - /api/inventory/vehicles/?model_code=EV-WHT
    - /api/inventory/vehicles/?status=available
    - /api/inventory/vehicles/?color=white&battery=40kWh
    - /api/inventory/vehicles/?min_price=40000&max_price=60000
    - /api/inventory/vehicles/?search=premium
    - /api/inventory/vehicles/?page=2&page_size=10&status=available&search=EV
    
    Response (200 OK):
    {
      "count": 1,  // Number of unique vehicle names (groups) matching filters
      "next": "http://127.0.0.1:8000/api/inventory/vehicles/?page=2",  // URL for next page (null if last page)
      "previous": null,  // URL for previous page (null if first page)
      "page_size": 10,  // Number of vehicle groups per page
      "current_page": 1,  // Current page number
      "total_pages": 1,  // Total number of pages
      "results": [
        {
          "name": "EV Model X2",
          "variants": [
            {
              "id": 19,
              "model_code": "EV-BLU-60K-TMMR0A",
              "vehicle_color": ["blue"],
              "battery_variant": ["60kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.403303+05:30"
            },
            {
              "id": 18,
              "model_code": "EV-BLU-40K-SCDA4J",
              "vehicle_color": ["blue"],
              "battery_variant": ["40kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.402882+05:30"
            },
            {
              "id": 17,
              "model_code": "EV-RED-60K-KE16X4",
              "vehicle_color": ["red"],
              "battery_variant": ["60kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.402442+05:30"
            },
            {
              "id": 16,
              "model_code": "EV-RED-40K-RZ2O33",
              "vehicle_color": ["red"],
              "battery_variant": ["40kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.402047+05:30"
            },
            {
              "id": 15,
              "model_code": "EV-WHT-60K-2EZP7T",
              "vehicle_color": ["white"],
              "battery_variant": ["60kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": null,
              "image_count": 0,
              "stock_total_quantity": 10,
              "stock_available_quantity": 7,
              "stock_reserved_quantity": 3,
              "created_at": "2026-01-09T09:49:41.401623+05:30"
            },
            {
              "id": 14,
              "model_code": "EV-WHT-40K-QKUK9J",
              "vehicle_color": ["white"],
              "battery_variant": ["40kWh"],
              "price": "50000.00",
              "status": "available",
              "primary_image_url": "http://127.0.0.1:8000/media/vehicles/images/Screenshot_2025-12-29_095141_yNKhXBN.png",
              "image_count": 2,
              "created_at": "2026-01-09T09:49:41.396665+05:30"
            }
          ]
        }
      ]
    }
    
    Notes:
    - Vehicles are grouped by name, with all color-battery variants under each name
    - Pagination is based on vehicle groups (names), not individual vehicles
    - count refers to the number of unique vehicle names matching the filters
    - All filters can be combined (e.g., ?name=EV&status=available&color=white&min_price=40000)
    - Search parameter searches across multiple fields: name, model_code, description, and features
    - Color and battery filters use array containment (vehicle must have that color/battery in its array)
    - Price filters accept numeric values (decimals supported)
    - Results are ordered by creation date (newest first)
    - Default page size is 10, maximum is 100
    - Use page parameter for pagination (e.g., ?page=2)
    - Use page_size parameter to change items per page (e.g., ?page_size=20)
    - Each group contains all variants (color-battery combinations) for that vehicle name
    - count represents the number of unique vehicle names, not individual vehicles
    - Each variant includes: id, model_code, vehicle_color, battery_variant, price, status, primary_image_url, image_count, created_at
    - model_code format: EV-{COLOR_CODE}-{BATTERY_CODE}-{RANDOM} (e.g., EV-WHT-40K-A9F3X2)
      - COLOR_CODE uses the first color from vehicle_color array
      - BATTERY_CODE extracted from battery variant (40kWh → 40K)
    - vehicle_color: Array of available colors (e.g., ["white", "red", "blue"])
    - battery_variant: Array with single battery variant (e.g., ["40kWh"])
    - Filtering by status or search works on individual variants, but results are still grouped by name
    
    Error Response (401):
    {
      "detail": "Authentication credentials were not provided."
    }


35. GET VEHICLE DETAILS
    Method: GET
    URL: /api/inventory/vehicles/{id}/
    Authentication: Required (All authenticated users)
    Description: Get detailed information about a specific vehicle including all images, features, and specifications
    
    Notes:
    - Each vehicle has multiple colors and a single battery variant
    - model_code format: EV-{COLOR_CODE}-{BATTERY_CODE}-{RANDOM} (e.g., EV-WHT-40K-A9F3X2)
      - COLOR_CODE uses the first color from vehicle_color array
      - BATTERY_CODE extracted from battery variant (40kWh → 40K)
    - vehicle_color: Array of available colors (e.g., ["white", "red", "blue"])
    - battery_variant: Array with single battery variant (e.g., ["40kWh"])
    - features: Optional field, returns empty array [] if not set
    - specifications: Optional field, returns empty object {} if not set
    - No limit on number of features or specifications
    - You can add any custom specification keys and values
    
    Response (200 OK):
    {
      "id": 1,
      "name": "EV Model X",
      "model_code": "EV-WHT-40K-A9F3X2",  // Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_color": ["white", "red", "blue"],  // Array of available colors
      "battery_variant": ["40kWh"],  // Single battery variant per vehicle (array with one element)
      "price": "50000.00",
      "status": "available",
      "description": "Premium electric vehicle with advanced features",
      "features": [
        "USB Charging Port",
        "Parking Mode",
        "Reverse Gear"
      ],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Charging Duration": "4-5h",
        "Max Speed": "25 km/h",
        "Mileage": "125+ km",
        "Battery Type": "Lithium-ion Battery",
        "Motor Type": "Brushless DC",
        "Frame Type": "Steel",
        "Tyre Type": "Tubeless",
        "Dimension": "1850×710×1120 MM",
        "Net Weight": "80KG",
        "Head Light": "LED Projector Light",
        "Riding Mode": "Eco-Power-Sport",
        "Brake": "Front Disc - Rear Drum",
        "Tyre Size": "90/100-10 53J",
        "Wheel Base": "1630mm",
        "Meter Type": "Digital"
      },
      "images": [
        {
          "id": 1,
          "image": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
          "image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
          "is_primary": true,
          "alt_text": "EV Model X - Front View",
          "order": 0,
          "created_at": "2026-01-06T12:00:00Z"
        },
        {
          "id": 2,
          "image": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
          "image_url": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
          "is_primary": false,
          "alt_text": "EV Model X - Side View",
          "order": 1,
          "created_at": "2026-01-06T12:01:00Z"
        }
      ],
      "primary_image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T15:00:00Z"
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


36. CREATE VEHICLE
    Method: POST
    URL: /api/inventory/vehicles/
    Authentication: Required (Admin/Superuser only)
    Description: Create vehicles. If color_images provided, creates one vehicle per color-battery combination. Otherwise, creates one vehicle per battery variant. Images must be uploaded first using /api/inventory/images/upload/ and linked via color_images or image_ids.
    
    Content-Type: application/json
    
    Request Body (JSON):
    {
      "name": "EV Model X",
      "vehicle_color": ["white", "red", "blue"],  // Array of colors
      "battery_variant": ["40kWh", "60kWh"],  // Array of battery variants
      "price": 50000,  // Base price - used for all variants if battery_pricing not provided
      "battery_pricing": {  // Optional: Dictionary mapping battery variant names to prices
        "40kWh": 50000,
        "60kWh": 60000
      },
      "status": "available",
      "description": "Premium electric vehicle",
      "features": ["USB Charging Port", "Parking Mode", "Reverse Gear"],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Max Speed": "25 km/h"
      },
      "color_images": {  // Optional: Map colors to image IDs for per-color images
        "white": [1, 2, 3],
        "red": [4, 5],
        "blue": [6, 7, 8]
      },
      "image_ids": [1, 2, 3],  // Optional: Fallback - links to first vehicle if color_images not provided
      "initial_quantity": 10  // Optional: Initial stock quantity for each vehicle variant. Defaults to 0 if not provided.
    }
    
    Field Descriptions:
    - name: (required) Vehicle name
    - model_code: (auto-generated, read-only) Automatically generated model code in format EV-{COLOR}-{BATTERY}-{RANDOM} (e.g., EV-WHT-40K-A9F3X2). Do not include in request.
    - vehicle_color: (required) Array of vehicle colors (e.g., ["white", "red", "blue"])
    - battery_variant: (required) Array of battery variants (e.g., ["40kWh", "60kWh"])
    - price: (required) Base vehicle price - used for all variants if battery_pricing not provided, or as fallback for battery variants not in battery_pricing
    - battery_pricing: (optional) Dictionary mapping battery variant names to prices (e.g., {"40kWh": 50000, "60kWh": 60000})
      - If provided, each battery variant uses its specified price
      - If a battery variant is not in battery_pricing, it uses the base price field
      - All keys in battery_pricing must exist in battery_variant array
      - All prices must be non-negative numbers
      - If not provided, all variants use the base price field value
    - status: (optional, default: "available") Status: "available", "out_of_stock", "discontinued"
    - description: (optional) Vehicle description (applies to all created vehicles)
    - features: (optional) Array of feature strings - unlimited items (applies to all created vehicles)
    - specifications: (optional) Object with key-value pairs - unlimited custom fields (applies to all created vehicles)
    - color_images: (optional) Dictionary mapping color names to arrays of image IDs (e.g., {"white": [1,2,3], "red": [4,5]})
      - If provided, creates one vehicle per color-battery combination with images linked per color
      - Keys must match colors in vehicle_color array
      - All image IDs must reference unlinked images from /api/inventory/images/upload/
    - image_ids: (optional) Array of image IDs from /api/inventory/images/upload/ endpoint
      - Only used if color_images is not provided (backward compatibility)
      - Images are linked to the first created vehicle
    - initial_quantity: (optional, default: 0) Initial stock quantity for the vehicle
      - Applies to each variant created (each color-battery combination gets this quantity)
      - Must be a non-negative integer (0 or greater)
      - Creates VehicleStock record automatically for each vehicle with the specified quantity
      - If not provided, VehicleStock is still created with quantity 0
    
    Notes:
    - Pricing Behavior:
      - If battery_pricing is provided: Each battery variant uses its specified price from battery_pricing
      - If battery_pricing is not provided: All variants use the base price field value
      - If battery_pricing is provided but missing some battery variants: Missing variants fall back to base price
      - Example: battery_variant=["40kWh", "60kWh"], battery_pricing={"40kWh": 50000} → 40kWh uses ₹50000, 60kWh uses base price
      - All keys in battery_pricing must match battery variant names in battery_variant array
      - Prices in battery_pricing must be non-negative numbers (zero allowed for promotional pricing)
    - If color_images provided: Creates one vehicle per color-battery combination (e.g., 3 colors × 2 batteries = 6 vehicles)
      - Each vehicle has a single color and single battery variant
      - Images are linked to vehicles based on color mapping in color_images
      - Example: color_images={"white": [1,2], "red": [3,4]} links images 1,2 to white vehicles and 3,4 to red vehicles
    - If color_images NOT provided: Creates one vehicle per battery variant (backward compatibility)
      - Each vehicle contains all colors in vehicle_color array
      - Example: 3 colors + 2 batteries = 2 vehicles created (each with all 3 colors)
      - Images from image_ids are linked to the first created vehicle only
    - model_code format: EV-{COLOR_CODE}-{BATTERY_CODE}-{RANDOM}
      - COLOR_CODE: 3-letter code from color (WHT, RED, BLU, BLK, GRY, etc.)
      - BATTERY_CODE: Extracted from battery variant (40kWh → 40K, 60kWh → 60K)
      - RANDOM: 6 random alphanumeric characters
      Example: EV-WHT-40K-A9F3X2 (Color: white, Battery: 40kWh)
    - color_images: Optional dictionary mapping color names to arrays of image IDs
      - Keys must match colors in vehicle_color array
      - All image IDs must reference images uploaded via /api/inventory/images/upload/
      - Images must be unlinked (not already associated with another vehicle)
    - image_ids: Optional array of image IDs (fallback if color_images not provided)
      - Only used if color_images is not provided
      - Images are linked to the first created vehicle only
    - Features and specifications are completely optional - can be omitted or left empty
    - No limit on number of features or specifications
    - First image for each vehicle will be set as primary if no primary exists
    - initial_quantity: Optional field to set initial stock quantity when creating vehicles
      - Each vehicle variant (color-battery combination) gets its own VehicleStock with the specified quantity
      - If not provided, defaults to 0 (VehicleStock still created)
      - Use /api/inventory/stock/ endpoints to view or update stock quantities after creation
    
    Response (201 Created) - Array of created vehicles:
    [
      {
        "id": 1,
        "name": "EV Model X",
        "model_code": "EV-WHT-40K-A9F3X2",  // Color: white, Battery: 40kWh (when color_images provided)
        "vehicle_color": ["white"],  // Single color per vehicle when color_images provided
        "battery_variant": ["40kWh"],  // Single battery per vehicle
        "price": "50000.00",  // Price from battery_pricing or base price
        "status": "available",
        "description": "Premium electric vehicle",
        "features": [
          "USB Charging Port",
          "Parking Mode",
          "Reverse Gear"
        ],
        "specifications": {
          "Battery": "60V × 50AH",
          "Motor Power": "48V/60V/72V 1000W",
          "Charging Duration": "4-5h",
          "Max Speed": "25 km/h",
          "Mileage": "125+ km",
          "Battery Type": "Lithium-ion Battery",
          "Motor Type": "Brushless DC"
        },
        "images": [
          {
            "id": 1,
            "image": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
            "image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
            "is_primary": true,
            "alt_text": "",
            "order": 0
          },
          {
            "id": 2,
            "image": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
            "image_url": "http://localhost:8000/media/vehicles/images/evx-red-2.jpg",
            "is_primary": false,
            "alt_text": "",
            "order": 1
          }
        ],
        "primary_image_url": "http://localhost:8000/media/vehicles/images/evx-red-1.jpg",
        "stock_total_quantity": 10,
        "stock_available_quantity": 10,
        "stock_reserved_quantity": 0,
        "created_at": "2026-01-08T12:00:00Z",
        "updated_at": "2026-01-08T12:00:00Z"
      },
      {
        "id": 2,
        "name": "EV Model X",
        "model_code": "EV-WHT-60K-B7C4Y1",  // Color: white, Battery: 60kWh (when color_images provided)
        "vehicle_color": ["white"],  // Single color per vehicle when color_images provided
        "battery_variant": ["60kWh"],  // Single battery per vehicle
        "price": "60000.00",  // Price from battery_pricing or base price
        "status": "available",
        "description": "Premium electric vehicle",
        "features": [
          "USB Charging Port",
          "Parking Mode",
          "Reverse Gear"
        ],
        "specifications": {
          "Battery": "60V × 50AH",
          "Motor Power": "48V/60V/72V 1000W",
          "Charging Duration": "4-5h",
          "Max Speed": "25 km/h",
          "Mileage": "125+ km",
          "Battery Type": "Lithium-ion Battery",
          "Motor Type": "Brushless DC"
        },
        "images": [],
        "primary_image_url": null,
        "stock_total_quantity": 10,
        "stock_available_quantity": 10,
        "stock_reserved_quantity": 0,
        "created_at": "2026-01-08T12:00:00Z",
        "updated_at": "2026-01-08T12:00:00Z"
      },
      {
        "id": 3,
        "name": "EV Model X",
        "model_code": "EV-RED-40K-C8D5Z2",  // Red, 40kWh
        "vehicle_color": ["red"],
        "battery_variant": ["40kWh"],
        "price": "50000.00",  // Price from battery_pricing or base price
        "status": "available",
        "description": "Premium electric vehicle",
        "features": [
          "USB Charging Port",
          "Parking Mode",
          "Reverse Gear"
        ],
        "specifications": {
          "Battery": "60V × 50AH",
          "Motor Power": "48V/60V/72V 1000W",
          "Charging Duration": "4-5h",
          "Max Speed": "25 km/h",
          "Mileage": "125+ km",
          "Battery Type": "Lithium-ion Battery",
          "Motor Type": "Brushless DC"
        },
        "images": [],
        "primary_image_url": null,
        "created_at": "2026-01-08T12:00:00Z",
        "updated_at": "2026-01-08T12:00:00Z"
      }
      // ... more vehicles for each color-battery combination
    ]
    
    Error Response (400):
    {
      "name": ["This field is required."],
      "image_ids": ["Image IDs [5, 6] do not exist or are already linked to a vehicle. Please upload images first using /api/inventory/images/upload/"],
      "battery_pricing": ["Battery variants ['80kWh'] in battery_pricing are not in battery_variant array."],
      "price": ["Price is required when battery_pricing is not provided."]
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Example Workflow:
    1. Upload images: POST /api/inventory/images/upload/ → Get [1, 2, 3]
    2. Create vehicle: POST /api/inventory/vehicles/ with {"image_ids": [1, 2, 3], ...}


37. UPDATE VEHICLE
    Method: PATCH / PUT
    URL: /api/inventory/vehicles/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Update vehicle information. To add images, upload them first and include image_ids.
    
    Content-Type: application/json
    
    Request Body (JSON example):
    {
      "name": "EV Model X Updated",
      "vehicle_color": ["white", "red"],  // Array of available colors
      "battery_variant": ["40kWh"],  // Array with single battery variant
      "price": 55000,  // Base price - used if battery_pricing not provided
      "battery_pricing": {  // Optional: Dictionary mapping battery variant names to prices
        "40kWh": 55000,
        "60kWh": 65000
      },
      "status": "out_of_stock",
      "description": "Updated description",
      "features": ["USB Charging Port", "Parking Mode", "Reverse Gear", "LED Lights"],
      "specifications": {
        "Battery": "60V × 50AH",
        "Max Speed": "30 km/h"
      },
      "color_images": {
        "white": [1, 2, 3],
        "red": [4, 5]
      },
      "image_ids": [4, 5],  // Fallback if color_images not provided
      "initial_quantity": 25  // Or use stock_quantity (both supported)
    }
    
    Notes:
    - All fields are optional (partial update)
    - model_code is read-only and cannot be updated (it is auto-generated when the vehicle is created)
    - vehicle_color: Array of available colors (e.g., ["white", "red", "blue"]). Can be updated to change available colors.
    - battery_variant: Array with single battery variant (e.g., ["40kWh"]). Can be updated to change battery variant.
    - price: (optional) Base vehicle price - used for all variants if battery_pricing not provided, or as fallback for battery variants not in battery_pricing
    - battery_pricing: (optional) Dictionary mapping battery variant names to prices (e.g., {"40kWh": 55000, "60kWh": 65000})
      - If provided, all keys in battery_pricing must exist in battery_variant array
      - If a battery variant is not in battery_pricing, it uses the base price field
      - Prices in battery_pricing must be non-negative numbers
      - Note: Since UPDATE operates on a single vehicle, battery_pricing is typically used when updating battery_variant to include multiple variants
    - Features and specifications are optional - can be omitted, updated, or left empty
    - No limit on number of features or specifications
    - color_images: (optional) Dictionary mapping color names to arrays of image IDs (e.g., {"white": [1, 2, 3], "red": [4, 5]})
      - Takes precedence over image_ids if both are provided
      - Colors in color_images are automatically added to vehicle_color if not already present
      - All image IDs must reference unlinked images from /api/inventory/images/upload/
      - Images are linked to the vehicle based on color mapping
      - **REPLACE behavior**: If color_images is provided, ALL existing images are removed and replaced with the new images from color_images
    - image_ids: (optional) Array of image IDs from /api/inventory/images/upload/ to link to vehicle
      - Only used if color_images is not provided (fallback, backward compatibility)
      - **MERGE behavior**: Adds new images, removes images not in the array, keeps existing images that are in the array
      - Images are reordered to match the order in image_ids array
      - Only unlinked images can be added (images already linked to other vehicles will be rejected)
    - image_ids: (optional) Array of image IDs from /api/inventory/images/upload/ to link to vehicle
      - Only used if color_images is not provided (fallback, backward compatibility)
      - Only unlinked images can be added (images already linked to other vehicles will be rejected)
      - Existing images are updated/reordered based on image_ids array
    - initial_quantity: (optional) Update stock quantity for this vehicle (same as CREATE endpoint)
      - Must be a non-negative integer (0 or greater)
      - Creates VehicleStock record if it doesn't exist
      - Updates total_quantity and adjusts available_quantity accordingly
      - If new quantity is less than current reserved quantity, available_quantity is set to 0
      - If new quantity is greater than or equal to reserved quantity, available_quantity = new_quantity - reserved_quantity
      - stock_quantity is also supported as an alias for backward compatibility
    
    Response (200 OK):
    {
      "id": 1,
      "name": "EV Model X Updated",
      "model_code": "EV-WHT-40K-A9F3X2",  // Format: EV-{COLOR}-{BATTERY}-{RANDOM}
      "vehicle_color": ["white", "red", "blue"],  // Array of available colors
      "battery_variant": ["40kWh"],  // Single battery variant per vehicle
      "price": "55000.00",
      "status": "out_of_stock",
      "description": "Updated description",
      "features": [
        "USB Charging Port",
        "Parking Mode",
        "Reverse Gear",
        "LED Lights"
      ],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Max Speed": "30 km/h"
      },
      "images": [...],
      "primary_image_url": "...",
      "stock_total_quantity": 10,
      "stock_available_quantity": 7,
      "stock_reserved_quantity": 3,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


38. DELETE VEHICLE
    Method: DELETE
    URL: /api/inventory/vehicles/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Delete a vehicle and all associated images
    
    Response (204 No Content):
    (Empty response body)
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }


39. ADD IMAGES TO VEHICLE
    Method: POST
    URL: /api/inventory/vehicles/{id}/add-images/
    Authentication: Required (Admin/Superuser only)
    Description: Add additional images to an existing vehicle
    
    Content-Type: multipart/form-data
    
    Request Body (form-data):
    - images_data[]: @image1.jpg (required, at least one file)
    - images_data[]: @image2.jpg (optional)
    
    Response (201 Created):
    [
      {
        "id": 4,
        "image": "http://localhost:8000/media/vehicles/images/evx-red-4.jpg",
        "image_url": "http://localhost:8000/media/vehicles/images/evx-red-4.jpg",
        "is_primary": false,
        "alt_text": "",
        "order": 3,
        "created_at": "2026-01-06T17:00:00Z"
      },
      {
        "id": 5,
        "image": "http://localhost:8000/media/vehicles/images/evx-red-5.jpg",
        "image_url": "http://localhost:8000/media/vehicles/images/evx-red-5.jpg",
        "is_primary": false,
        "alt_text": "",
        "order": 4,
        "created_at": "2026-01-06T17:00:01Z"
      }
    ]
    
    Error Response (400):
    {
      "error": "No images provided"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }


40. REMOVE IMAGE FROM VEHICLE
    Method: DELETE
    URL: /api/inventory/vehicles/{id}/remove-image/{image_id}/
    Authentication: Required (Admin/Superuser only)
    Description: Remove a specific image from a vehicle
    
    Response (204 No Content):
    {
      "message": "Image deleted successfully"
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "error": "Image not found"
    }


41. SET PRIMARY IMAGE
    Method: PATCH
    URL: /api/inventory/vehicles/{id}/set-primary-image/{image_id}/
    Authentication: Required (Admin/Superuser only)
    Description: Set a specific image as the primary/featured image for a vehicle
    
    Response (200 OK):
    {
      "id": 3,
      "image": "http://localhost:8000/media/vehicles/images/evx-red-3.jpg",
      "image_url": "http://localhost:8000/media/vehicles/images/evx-red-3.jpg",
      "is_primary": true,
      "alt_text": "EV Model X - Interior",
      "order": 2,
      "created_at": "2026-01-06T12:02:00Z"
    }
    
    Note: Setting a new primary image automatically unchecks the previous primary image
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Error Response (404):
    {
      "error": "Image not found"
    }


42. LIST VEHICLE STOCK
    Method: GET
    URL: /api/inventory/stock/
    Authentication: Not required (Public access)
    Description: List all vehicle stock records with filtering options. Includes dashboard summary data with total stock, inventory value, low stock alerts, and stock trend.
    - For non-admin users: Only returns vehicles with available stock (available_quantity > 0)
    - For admin users: Returns all vehicles regardless of stock availability
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Items per page (default: 20)
    - vehicle_id: Filter by vehicle ID
    - model_code: Filter by vehicle model code (partial match)
    - vehicle_name: Filter by vehicle name (partial match)
    - min_available: Filter by minimum available quantity
    - max_available: Filter by maximum available quantity
    
    Response (200 OK):
    {
      "count": 50,
      "next": "http://localhost:8000/api/inventory/stock/?page=2",
      "previous": null,
      "results": [
        {
          "id": 1,
          "vehicle": 1,
          "vehicle_name": "EV Model X",
          "vehicle_model_code": "EV-RED-40K-A9F3X2",
          "total_quantity": 10,
          "available_quantity": 7,
          "reserved_quantity": 3,
          "created_at": "2026-01-06T12:00:00Z",
          "updated_at": "2026-01-06T15:00:00Z"
        }
      ],
      "summary": {
        "total_stock": 92,
        "inventory_value": 7820000.0,
        "low_stock_threshold_percent": 20,
        "low_stock_alerts_count": 2,
        "out_of_stock_count": 1,
        "low_stock_items": [
          {
            "vehicle_id": 15,
            "vehicle_name": "EVOLVE",
            "vehicle_model_code": "EV-BLU-60K-TMMR0A",
            "available_quantity": 15,
            "total_quantity": 20,
            "reorder_level": 4,
            "status": "low_stock"
          },
          {
            "vehicle_id": 18,
            "vehicle_name": "EVOQUE",
            "vehicle_model_code": "EV-RED-40K-SCDA4J",
            "available_quantity": 0,
            "total_quantity": 10,
            "reorder_level": 2,
            "status": "out_of_stock"
          }
        ],
        "stock_trend": [
          {
            "label": "EV Model X1",
            "total_stock": 200
          },
          {
            "label": "EV Model X5",
            "total_stock": 224
          },
          {
            "label": "EV Model X6",
            "total_stock": 280
          }
        ]
      }
    }
    
    Summary Fields:
    - total_stock: Sum of all total_quantity values across filtered stock records
    - inventory_value: Total inventory value calculated as sum of (vehicle.price * total_quantity) for all stock records
    - low_stock_threshold_percent: Percentage threshold used to determine low stock (configurable via LOW_STOCK_THRESHOLD_PERCENT setting, default: 20)
    - low_stock_alerts_count: Number of vehicles with available_quantity > 0 but <= reorder_level (calculated as total_quantity * threshold_percent / 100)
    - out_of_stock_count: Number of vehicles with available_quantity == 0
    - low_stock_items: Array of vehicles that need attention, sorted by available_quantity (lowest first). Each item contains:
      - vehicle_id: Vehicle ID
      - vehicle_name: Vehicle name
      - vehicle_model_code: Vehicle model code
      - available_quantity: Current available stock
      - total_quantity: Total stock quantity
      - reorder_level: Calculated threshold (total_quantity * threshold_percent / 100)
      - status: "low_stock" if available_quantity > 0 but <= reorder_level, "out_of_stock" if available_quantity == 0
    - stock_trend: Array of stock trend data broken down by model name (vehicle name). Each entry contains:
      - label: The vehicle name (model name)
      - total_stock: Sum of total_quantity for all variants of that model
      - Entries are sorted by vehicle name for consistency
      - This allows the frontend to display a chart with separate data points for each model showing their current stock levels
    
    Notes:
    - Summary data is calculated from the filtered queryset (respects all query parameters)
    - Low stock threshold is percentage-based: a vehicle is considered low stock if available_quantity <= (total_quantity * threshold_percent / 100)
    - The threshold percentage can be configured via LOW_STOCK_THRESHOLD_PERCENT setting in Django settings (default: 20%)
    - Low stock items are sorted by available_quantity (lowest first) to prioritize critical alerts
    - Stock trend shows current stock levels broken down by model name, with each model having its own trend point
    - Stock quantities are aggregated by vehicle name (all color-battery variants of the same model are summed together)
    - Non-admin users will only see vehicles with available_quantity > 0 in the results
    - Summary data (low_stock_items, out_of_stock_count) is only visible to admin users (non-admin users won't see out-of-stock items in results)


43. GET VEHICLE STOCK BY ID
    Method: GET
    URL: /api/inventory/stock/{id}/
    Authentication: Not required (Public access)
    Description: Get specific vehicle stock record with full details including other variants.
    - For non-admin users: Only returns vehicles with available stock (available_quantity > 0)
    - For admin users: Returns all vehicles regardless of stock availability
    - The {id} parameter can be either a VehicleStock ID or a Vehicle ID (variantId)
    
    Response (200 OK):
    {
      "id": 1,
      "vehicle": 1,
      "vehicle_name": "EV Model X",
      "vehicle_model_code": "EV-RED-40K-A9F3X2",
      "vehicle_colors": ["red"],
      "battery_variants": ["40kWh"],
      "features": ["USB Charging Port", "Parking Mode", "Reverse Gear"],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W",
        "Max Speed": "25 km/h"
      },
      "description": "Electric vehicle description...",
      "price": "65000.00",
      "status": "available",
      "primary_image_url": "http://example.com/media/vehicles/images/image1.jpg",
      "images": [
        {
          "id": 1,
          "image_url": "http://example.com/media/vehicles/images/image1.jpg",
          "is_primary": true,
          "alt_text": "EV Model X front view",
          "order": 0
        },
        {
          "id": 2,
          "image_url": "http://example.com/media/vehicles/images/image2.jpg",
          "is_primary": false,
          "alt_text": "EV Model X side view",
          "order": 1
        }
      ],
      "other_variants": [
        {
          "id": 2,
          "model_code": "EV-BLU-40K-XYZ789",
          "vehicle_color": ["blue"],
          "battery_variant": ["40kWh"],
          "price": "65000.00",
          "status": "available",
          "primary_image_url": "http://example.com/media/vehicles/images/image3.jpg",
          "image_count": 3,
          "images": [...],
          "stock_total_quantity": 5,
          "stock_available_quantity": 3,
          "stock_reserved_quantity": 2,
          "created_at": "2026-01-06T12:00:00Z"
        }
      ],
      "total_quantity": 10,
      "available_quantity": 7,
      "reserved_quantity": 3,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T15:00:00Z"
    }
    
    Error Response (404):
    {
      "detail": "Vehicle stock not found or not available."
    }
    
    Notes:
    - This endpoint fetches stock details for a clicked variant (via useGetStockQuery hook)
    - Returns current variant details (price, images, stock quantities)
    - Returns other_variants array (all other variants for the same vehicle model/name)
    - Returns specifications, features, description, etc.
    - Non-admin users will receive 404 if the vehicle has no available stock
    - The {id} parameter accepts either:
      * VehicleStock ID (e.g., /api/inventory/stock/1/)
      * Vehicle ID / Variant ID (e.g., /api/inventory/stock/5/) - will automatically get or create stock for that vehicle
    - If using Vehicle ID and stock doesn't exist, it will be created with 0 quantity (admin users can see it, non-admin users will get 404)
    - Response includes full vehicle details and all other variants of the same model for easy comparison


44. UPDATE VEHICLE STOCK
    Method: PATCH / PUT
    URL: /api/inventory/stock/{id}/
    Authentication: Required (Admin/Superuser only)
    Description: Update vehicle stock quantity
    
    Request Body:
    {
      "total_quantity": 15
    }
    
    Response (200 OK):
    {
      "id": 1,
      "vehicle": 1,
      "vehicle_name": "EV Model X",
      "vehicle_model_code": "EV-RED-40K-A9F3X2",
      "total_quantity": 15,
      "available_quantity": 12,  // Automatically increased by 5 (15-10)
      "reserved_quantity": 3,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    Error Response (400):
    {
      "total_quantity": ["Total quantity cannot be less than reserved quantity (3)"]
    }
    
    Error Response (403):
    {
      "detail": "Only admin users can perform this action."
    }
    
    Note:
    - total_quantity: Can be updated (admin sets this)
    - available_quantity: Read-only (automatically calculated)
    - reserved_quantity: Read-only (calculated: total_quantity - available_quantity)
    - When total_quantity is increased: available_quantity is automatically increased by the difference
    - When total_quantity is decreased: available_quantity is decreased, but cannot go below reserved quantity
    - Cannot set total_quantity less than current reserved quantity


45. GET/UPDATE STOCK BY VEHICLE ID
    Method: GET / POST
    URL: /api/inventory/stock/by-vehicle/{vehicle_id}/
    Authentication: 
    - GET: Not required (Public access)
    - POST: Required (Admin/Superuser only)
    Description: Get or update stock for a specific vehicle by vehicle ID
    
    GET Request:
    - For non-admin users: Only returns vehicles with available stock (available_quantity > 0)
    - For admin users: Returns all vehicles regardless of stock availability
    - Returns the same full response structure as GET VEHICLE STOCK BY ID (including other_variants, images, etc.)
    
    GET Response (200 OK):
    {
      "id": 1,
      "vehicle": 5,
      "vehicle_name": "EV Model Y",
      "vehicle_model_code": "EV-BLU-60K-XYZ789",
      "vehicle_colors": ["blue"],
      "battery_variants": ["60kWh"],
      "features": ["USB Charging Port", "Parking Mode"],
      "specifications": {
        "Battery": "60V × 50AH",
        "Motor Power": "48V/60V/72V 1000W"
      },
      "description": "Electric vehicle description...",
      "price": "75000.00",
      "status": "available",
      "primary_image_url": "http://example.com/media/vehicles/images/image1.jpg",
      "images": [...],
      "other_variants": [...],
      "total_quantity": 20,
      "available_quantity": 20,
      "reserved_quantity": 0,
      "created_at": "2026-01-06T16:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    GET Error Response (404):
    {
      "error": "Vehicle not found"
    }
    OR
    {
      "error": "Vehicle stock not found or not available"
    }
    
    POST Request Body:
    {
      "total_quantity": 20
    }
    
    POST Response (200 OK):
    {
      "id": 1,
      "vehicle": 5,
      "vehicle_name": "EV Model Y",
      "vehicle_model_code": "EV-BLU-60K-XYZ789",
      "total_quantity": 20,
      "available_quantity": 20,  // If stock was just created, available = total
      "reserved_quantity": 0,
      "created_at": "2026-01-06T16:00:00Z",
      "updated_at": "2026-01-06T16:00:00Z"
    }
    
    POST Error Response (404):
    {
      "error": "Vehicle not found"
    }
    
    POST Error Response (403):
    {
      "detail": "Only admin users can update stock."
    }
    
    Notes:
    - GET: If stock doesn't exist for the vehicle, it will be created automatically (with 0 quantity)
    - POST: If stock doesn't exist for the vehicle, it will be created automatically
    - POST: If stock exists, it will be updated
    - POST: Same validation rules apply as UPDATE VEHICLE STOCK endpoint
    - GET: Non-admin users will receive 404 if the vehicle has no available stock


================================================================================
                            WALLET APIs
================================================================================

46. GET MY WALLET
    Method: GET
    URL: /api/wallet/my_wallet/
    Authentication: Required
    Description: Get current user's wallet balance and details
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "balance": "15000.00",
      "total_earned": "20000.00",
      "total_withdrawn": "5000.00",
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T15:00:00Z"
    }


47. LIST WALLET TRANSACTIONS
    Method: GET
    URL: /api/wallet/transactions/
    Authentication: Required
    Description: Get wallet transaction history with pagination and filtering support
    
    Query Parameters:
    - page: Page number (default: 1)
    - page_size: Number of results per page (default: 20, max: 100)
    - user_id: Filter by user ID (Admin only - returns 404 if user doesn't exist)
    - transaction_type: Filter by transaction type (REFERRAL_BONUS, BINARY_PAIR, EMI_DEDUCTION, PAYOUT, etc.)
    - start_date: Filter from date (YYYY-MM-DD format)
    - end_date: Filter to date (YYYY-MM-DD format, includes entire day up to 23:59:59)
    
    Notes:
    - Regular users can only see their own transactions
    - Admin users can see all transactions or filter by user_id
    - Transactions are ordered by created_at (newest first)
    - All date filters use created_at timestamp
    - Invalid date formats return 400 Bad Request with error message
    
    Response (200 OK):
    {
      "count": 150,
      "next": "http://api/wallet/transactions/?page=2&page_size=20",
      "previous": null,
      "results": [
        {
          "id": 1,
          "user": 1,
          "user_email": "user@example.com",
          "wallet": 1,
          "transaction_type": "BINARY_PAIR_COMMISSION",
          "amount": "500.00",
          "balance_before": "10000.00",
          "balance_after": "10500.00",
          "description": "Binary pair commission (Pair #1)",
          "reference_id": 1,
          "reference_type": "binary_pair",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }
    
    Error Responses:
    - 400 Bad Request: Invalid date format or user_id format
      {
        "detail": "Invalid start_date format: '2026-01'. Use YYYY-MM-DD format."
      }
    - 404 Not Found: User with specified user_id doesn't exist (Admin only)
      {
        "detail": "User with ID 161 does not exist."
      }
    
    Transaction Types:
    - REFERRAL_BONUS: Referral earnings
    - BINARY_PAIR: Binary pair matching earnings (legacy)
    - BINARY_PAIR_COMMISSION: Binary pair commission after activation (new commission structure)
    - DIRECT_USER_COMMISSION: Commission for direct user addition before activation (net amount after TDS)
    - BINARY_INITIAL_BONUS: Initial bonus credited when binary commission is activated (3 persons). Net amount after TDS is credited to wallet. TDS is NOT deducted from booking balance.
    - TDS_DEDUCTION: TDS deducted from all binary commissions (direct user and pairs, deducted from booking remaining amount)
    - EXTRA_DEDUCTION: Extra deduction for 6th+ binary pairs (additional 20%, deducted from booking remaining amount)
    - EMI_DEDUCTION: Automatic EMI deductions
    - RESERVE_DEDUCTION: Reserve fund deductions
    - PAYOUT: Withdrawal transactions
    - DEPOSIT: Manual deposits
    - REFUND: Refund transactions
    
    Example Requests:
    - Get first page with default page size:
      GET /api/wallet/transactions/?page=1
    - Get second page with 50 items per page:
      GET /api/wallet/transactions/?page=2&page_size=50
    - Filter by transaction type:
      GET /api/wallet/transactions/?transaction_type=BINARY_PAIR_COMMISSION&page=1
    - Filter by date range:
      GET /api/wallet/transactions/?start_date=2026-01-01&end_date=2026-01-31&page=1
    - Admin: Get transactions for specific user:
      GET /api/wallet/transactions/?user_id=161&page=1&page_size=20
    - Combined filters:
      GET /api/wallet/transactions/?user_id=161&transaction_type=PAYOUT&start_date=2026-01-01&page=1&page_size=10


================================================================================
                            BINARY APIs
================================================================================

48. GET MY BINARY TREE
    Method: GET
    URL: /api/binary/nodes/my_tree/
    Authentication: Required
    Description: Get current user's binary tree information
    
    Response (200 OK):
    {
      "id": 1,
      "user": 1,
      "parent": null,
      "side": null,
      "level": 0,
      "left_count": 5,
      "right_count": 3,
      "binary_commission_activated": true,  // Whether binary commission is activated
      "activation_timestamp": "2026-01-06T12:00:00Z",  // Timestamp when binary commission was activated
      "direct_children_count": 3,  // Count of direct children (left + right)
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (404):
    {
      "message": "No binary node found"
    }
    
    Notes:
    - binary_commission_activated: True if user has reached the activation threshold (default: 3 total descendants)
    - activation_timestamp: Timestamp when binary commission was activated (used to determine pairing eligibility)
    - direct_children_count: Number of direct children (nodes where parent = this node)
    - Binary commission activates when total descendants >= activation_count (configurable via settings)
    - Pair Matching Eligibility: Only members created at or after activation_timestamp are eligible for pairing


49. LIST BINARY NODES
    Method: GET
    URL: /api/binary/nodes/
    Authentication: Required
    Description: List binary nodes (admin sees all)
    
    Response (200 OK):
    {
      "count": 100,
      "results": [
        {
          "id": 1,
          "user": 1,
          "parent": null,
          "side": null,
          "left_count": 5,
          "right_count": 3,
          ...
        }
      ]
    }


50. CHECK FOR BINARY PAIRS
    Method: POST
    URL: /api/binary/pairs/check_pairs/
    Authentication: Required
    Description: Manually trigger pair checking. Only works if binary commission is activated (user has 3+ direct children).
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "left_user": 2,
      "right_user": 3,
      "pair_amount": "2000.00",  // Commission amount (configurable, default: ₹2000)
      "earning_amount": "2000.00",  // Net amount after TDS (if applicable)
      "status": "matched",
      "pair_month": 1,
      "pair_year": 2026,
      "pair_number_after_activation": 1,  // Pair number after activation (null if before activation)
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Response (200 OK) - No pairs:
    {
      "message": "No pairs available"
    }
    
    Notes:
    - Maximum 10 pairs per DAY per user (configurable daily limit)
    - Binary commission must be activated (user must have 3+ total descendants)
    - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
      * Pre-activation members (1st and 2nd members) are EXCLUDED from pairing
      * Member that triggered activation (3rd member) is INCLUDED in pairing
      * All members added after activation are INCLUDED in pairing
      * Example: If User A has B (1st), C (2nd), D (3rd - triggers activation), E (4th):
        - B and C are excluded from pairing
        - D and E can be paired (not B and C)
    - Commission amount is configurable via Platform Settings (default: ₹2000)
    - 20% TDS is applied on ALL pair commissions (1st pair onwards, configurable percentage)
    - Extra 20% deduction applies from 6th pair onwards (configurable threshold and percentage)
    - Pairs 1-5: ₹2000 - 20% TDS = ₹1600 credited
    - Pairs 6+: ₹2000 - 20% TDS - 20% extra = ₹1200 credited (extra deducted from booking balance)
    - TDS and extra deduction are deducted from user's oldest active booking remaining amount
    - earning_amount shows net amount after TDS and extra deduction (if applicable)
    - Daily limit reset: Resets at midnight (00:00 server time)
    - After 10 pairs in a day: SHORT leg (fewer remaining members) is ignored, LONG leg (more remaining) is carried forward


51. LIST BINARY PAIRS
    Method: GET
    URL: /api/binary/pairs/
    Authentication: Required
    Description: List binary pairs for user
    
    Query Parameters:
    - pair_month: Filter by month (1-12)
    - pair_year: Filter by year
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "user": 1,
          "left_user": 2,
          "right_user": 3,
          "pair_amount": "2000.00",  // Commission amount (configurable)
          "earning_amount": "2000.00",  // Net amount after TDS (if applicable)
          "status": "processed",
          "pair_month": 1,
          "pair_year": 2026,
          "pair_number_after_activation": 1,  // Pair number after activation (null if before activation)
          "matched_at": "2026-01-06T12:00:00Z"
        }
      ]
    }
    
    Notes:
    - pair_amount: Gross commission amount (configurable via settings, default: ₹2000)
    - earning_amount: Net amount credited to wallet (after TDS and extra deduction if applicable)
    - pair_number_after_activation: Tracks which pair this is after binary commission activation
    - pair_date: Date when pair was created (for daily limit tracking)
    - is_carry_forward_pair: Whether this pair used carried-forward members from previous day
    - extra_deduction_applied: Amount of extra deduction applied (for 6th+ pairs)
    - 20% TDS is applied on ALL pair commissions (1st pair onwards)
    - Extra 20% deduction applies from 6th pair onwards (configurable threshold)
    - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
      * Pre-activation members (1st and 2nd) are excluded, 3rd member (activation trigger) and all subsequent members are included


52. LIST BINARY EARNINGS
    Method: GET
    URL: /api/binary/earnings/
    Authentication: Required
    Description: List binary earnings history
    
    Response (200 OK):
    {
      "count": 10,
      "results": [
        {
          "id": 1,
          "user": 1,
          "binary_pair": 1,
          "amount": "2000.00",  // Gross commission amount
          "pair_number": 1,
          "emi_deducted": "0.00",
          "net_amount": "2000.00",  // Net amount after TDS (if applicable)
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }
    
    Business Rules:
    - Binary commission only activates after user has 3 total descendants (configurable threshold)
    - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
      * Pre-activation members (1st and 2nd members) are EXCLUDED from pairing
      * Member that triggered activation (3rd member) is INCLUDED in pairing
      * All members added after activation are INCLUDED in pairing
    - Commission amount is configurable via Platform Settings (default: ₹2000 per pair)
    - 20% TDS is applied on ALL binary pair commissions (1st pair onwards, configurable percentage)
    - Extra 20% deduction applies from 6th pair onwards (configurable threshold, default: 5 pairs)
    - Daily pair limit: Maximum 10 pairs per day (configurable, default: 10 pairs = ₹20,000 before deductions)
    - Pairs 1-5: ₹2000 - 20% TDS = ₹1600 credited
    - Pairs 6+: ₹2000 - 20% TDS - 20% extra = ₹1200 credited (extra deducted from booking balance)
    - TDS and extra deduction are deducted from user's oldest active booking remaining amount
    - If no active booking exists, TDS is still recorded but not deducted from any booking
    - After 10 pairs in a day: SHORT leg (fewer remaining members) is ignored, LONG leg (more remaining) is carried forward to next day
    - Carry-forward: Next day, new members on ignored side match with carried-forward members from long leg


53. GET FULL TREE STRUCTURE
    Method: GET
    URL: /api/binary/nodes/tree_structure/
    Authentication: Required
    Description: Get full binary tree structure with all children (recursive tree view). Supports pagination and filtering by side.
    
    Query Parameters:
    - side: Filter by side ("left", "right", "both") - default: "both"
      * "left": Returns only left side members and left_child (excludes right_side_members and right_child)
      * "right": Returns only right side members and right_child (excludes left_side_members and left_child)
      * "both": Returns both sides (default behavior)
    - page: Page number for side members pagination (default: 1, optional)
      * If not provided, returns all members (backward compatibility)
      * Only applies to left_side_members and right_side_members arrays
    - page_size: Items per page for side members (default: 20, max: 100, optional)
      * If not provided, returns all members (backward compatibility)
      * Only applies to left_side_members and right_side_members arrays
    - min_depth: Minimum depth to include (default: 0, optional)
      * Filters members based on their depth level in the tree
    - max_depth: Maximum depth to traverse (default: 5, optional)
      * Limits how deep the tree is traversed (prevents excessive recursion)
    
    Example Requests:
    GET /api/binary/nodes/tree_structure/
    GET /api/binary/nodes/tree_structure/?side=left
    GET /api/binary/nodes/tree_structure/?side=right
    GET /api/binary/nodes/tree_structure/?page=1&page_size=20
    GET /api/binary/nodes/tree_structure/?side=left&page=1&page_size=10
    GET /api/binary/nodes/tree_structure/?min_depth=1&max_depth=3
    GET /api/binary/nodes/tree_structure/?side=left&page=2&page_size=20&max_depth=5
    
    Response (200 OK):
    {
      "id": 1,
      "user_id": 1,
      "user_email": "user@example.com",
      "user_username": "user@example.com",
      "user_full_name": "John Doe",
      "user_mobile": "+919876543210",
      "user_first_name": "John",
      "user_last_name": "Doe",
      "user_city": "Mumbai",
      "user_state": "Maharashtra",
      "user_profile_picture_url": "http://localhost:8000/media/profile_pictures/user_1_profile.jpg",
      "is_distributor": true,
      "is_active_buyer": true,
      "referral_code": "REF00001",
      "date_joined": "2026-01-06T12:00:00Z",
      "wallet_balance": "15000.00",
      "total_bookings": 5,
      "total_binary_pairs": 10,
      "total_earnings": "20000.00",
      "parent": null,
      "side": null,
      "level": 0,
      "left_count": 5,
      "right_count": 3,
      "binary_commission_activated": true,
      "activation_timestamp": "2026-01-06T12:00:00Z",
      "left_side_members": {
        "count": 50,
        "page": 1,
        "page_size": 20,
        "total_pages": 3,
        "next": "http://localhost:8000/api/binary/nodes/tree_structure/?side=both&page=2&page_size=20",
        "previous": null,
        "results": [
          {
            "node_id": 4,
            "user_id": 4,
            "user_email": "user4@example.com",
            "user_username": "user4@example.com",
            "user_full_name": "Alice Brown",
            "user_mobile": "+919876543212",
            "user_first_name": "Alice",
            "user_last_name": "Brown",
            "user_city": "Bangalore",
            "user_state": "Karnataka",
            "is_distributor": false,
            "is_active_buyer": false,
            "referral_code": "REF00004",
            "date_joined": "2026-01-08T14:00:00Z",
            "wallet_balance": "0.00",
            "total_bookings": 0,
            "total_binary_pairs": 0,
            "total_earnings": "0.00",
            "parent": 2,
            "side": "left",
            "level": 2,
            "left_count": 0,
            "right_count": 0,
            "created_at": "2026-01-08T14:00:00Z",
            "updated_at": "2026-01-08T14:00:00Z"
          }
          // ... more members (up to page_size)
        ]
      },
      // Note: If side="left", right_side_members will be null
      // Note: If pagination not requested, left_side_members and right_side_members return as arrays (backward compatibility)
      "right_side_members": {
        "count": 30,
        "page": 1,
        "page_size": 20,
        "total_pages": 2,
        "next": "http://localhost:8000/api/binary/nodes/tree_structure/?side=both&page=2&page_size=20",
        "previous": null,
        "results": [
          {
            "node_id": 6,
            "user_id": 6,
            "user_email": "user6@example.com",
            "user_username": "user6@example.com",
            "user_full_name": "David Lee",
            "user_mobile": "+919876543215",
            "user_first_name": "David",
            "user_last_name": "Lee",
            "user_city": "Hyderabad",
            "user_state": "Telangana",
            "is_distributor": false,
            "is_active_buyer": false,
            "referral_code": "REF00006",
            "date_joined": "2026-01-10T11:00:00Z",
            "wallet_balance": "0.00",
            "total_bookings": 0,
            "total_binary_pairs": 0,
            "total_earnings": "0.00",
            "parent": 3,
            "side": "left",
            "level": 2,
            "left_count": 0,
            "right_count": 0,
            "created_at": "2026-01-10T11:00:00Z",
            "updated_at": "2026-01-10T11:00:00Z"
          }
          // ... more members (up to page_size)
        ]
      },
      "left_child": {
        "id": 2,
        "user_id": 2,
        "user_email": "user2@example.com",
        "user_username": "user2@example.com",
        "user_full_name": "Jane Smith",
        "user_mobile": "+919876543211",
        "user_first_name": "Jane",
        "user_last_name": "Smith",
        "user_city": "Delhi",
        "user_state": "Delhi",
        "is_distributor": false,
        "is_active_buyer": true,
        "referral_code": "REF00002",
        "date_joined": "2026-01-07T10:00:00Z",
        "wallet_balance": "5000.00",
        "total_bookings": 2,
        "total_binary_pairs": 3,
        "total_earnings": "8000.00",
        "parent": 1,
        "side": "left",
        "level": 1,
        "left_count": 2,
        "right_count": 1,
        "left_child": {
          "id": 4,
          "user_id": 4,
          "user_email": "user4@example.com",
          "user_username": "user4@example.com",
          "user_full_name": "Alice Brown",
          "user_mobile": "+919876543212",
          "user_first_name": "Alice",
          "user_last_name": "Brown",
          "user_city": "Bangalore",
          "user_state": "Karnataka",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00004",
          "date_joined": "2026-01-08T14:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 2,
          "side": "left",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-08T14:00:00Z",
          "updated_at": "2026-01-08T14:00:00Z"
        },
        "right_child": {
          "id": 5,
          "user_id": 5,
          "user_email": "user5@example.com",
          "user_username": "user5@example.com",
          "user_full_name": "Charlie Wilson",
          "user_mobile": "+919876543213",
          "user_first_name": "Charlie",
          "user_last_name": "Wilson",
          "user_city": "Chennai",
          "user_state": "Tamil Nadu",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00005",
          "date_joined": "2026-01-09T09:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 2,
          "side": "right",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-09T09:00:00Z",
          "updated_at": "2026-01-09T09:00:00Z"
        },
        "created_at": "2026-01-07T10:00:00Z",
        "updated_at": "2026-01-07T10:00:00Z"
      },
      "right_child": {
        "id": 3,
        "user_id": 3,
        "user_email": "user3@example.com",
        "user_username": "user3@example.com",
        "user_full_name": "Bob Johnson",
        "user_mobile": "+919876543214",
        "user_first_name": "Bob",
        "user_last_name": "Johnson",
        "user_city": "Pune",
        "user_state": "Maharashtra",
        "is_distributor": false,
        "is_active_buyer": true,
        "referral_code": "REF00003",
        "date_joined": "2026-01-07T15:00:00Z",
        "wallet_balance": "3000.00",
        "total_bookings": 1,
        "total_binary_pairs": 2,
        "total_earnings": "5000.00",
        "parent": 1,
        "side": "right",
        "level": 1,
        "left_count": 1,
        "right_count": 2,
        "left_child": {
          "id": 6,
          "user_id": 6,
          "user_email": "user6@example.com",
          "user_username": "user6@example.com",
          "user_full_name": "David Lee",
          "user_mobile": "+919876543215",
          "user_first_name": "David",
          "user_last_name": "Lee",
          "user_city": "Hyderabad",
          "user_state": "Telangana",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00006",
          "date_joined": "2026-01-10T11:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 3,
          "side": "left",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-10T11:00:00Z",
          "updated_at": "2026-01-10T11:00:00Z"
        },
        "right_child": {
          "id": 7,
          "user_id": 7,
          "user_email": "user7@example.com",
          "user_username": "user7@example.com",
          "user_full_name": "Emma Davis",
          "user_mobile": "+919876543216",
          "user_first_name": "Emma",
          "user_last_name": "Davis",
          "user_city": "Kolkata",
          "user_state": "West Bengal",
          "is_distributor": false,
          "is_active_buyer": false,
          "referral_code": "REF00007",
          "date_joined": "2026-01-11T08:00:00Z",
          "wallet_balance": "0.00",
          "total_bookings": 0,
          "total_binary_pairs": 0,
          "total_earnings": "0.00",
          "parent": 3,
          "side": "right",
          "level": 2,
          "left_count": 0,
          "right_count": 0,
          "left_child": null,
          "right_child": null,
          "created_at": "2026-01-11T08:00:00Z",
          "updated_at": "2026-01-11T08:00:00Z"
        },
        "created_at": "2026-01-07T15:00:00Z",
        "updated_at": "2026-01-07T15:00:00Z"
      },
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (404):
    {
      "message": "No binary node found"
    }
    
    Error Response (400):
    {
      "error": "Invalid max_depth parameter"
    }
    
    Response when filtering by left side only (side=left):
    {
      // ... root node fields ...
      "left_child": { ... },  // Included
      "right_child": null,     // Excluded when side="left"
      "left_side_members": { ... },  // Paginated structure
      "right_side_members": null,    // Excluded when side="left"
      "pending_users": [ ... ]
    }
    
    Response when filtering by right side only (side=right):
    {
      // ... root node fields ...
      "left_child": null,      // Excluded when side="right"
      "right_child": { ... },  // Included
      "left_side_members": null,     // Excluded when side="right"
      "right_side_members": { ... }, // Paginated structure
      "pending_users": [ ... ]
    }
    
    Response without pagination (backward compatibility):
    {
      // ... root node fields ...
      "left_side_members": [ ... ],  // Array (not paginated)
      "right_side_members": [ ... ], // Array (not paginated)
      "pending_users": [ ... ]
    }
    
    Notes:
    - Returns recursive tree structure with all child nodes
    - Root node is always included regardless of filters
    - Direct children (left_child, right_child) are conditionally included based on side filter
    - Side filtering: When side="left", right_side_members and right_child are excluded (set to null)
    - Side filtering: When side="right", left_side_members and left_child are excluded (set to null)
    - Pagination: Only applies to left_side_members and right_side_members arrays
    - Pagination: If page and page_size are not provided, returns all members as arrays (backward compatibility)
    - Pagination: When pagination is requested, side_members return as objects with count, page, page_size, total_pages, next, previous, and results
    - Depth filtering: min_depth and max_depth filter members based on their level in the tree
    - max_depth parameter limits how deep the tree is traversed (prevents excessive recursion)
    - Only tree owner can view their own tree structure
    - Each node includes comprehensive member details:
      * Basic Info: user_id, user_email, user_username, user_full_name, user_mobile, user_profile_picture_url
      * Personal Details: user_first_name, user_last_name, user_city, user_state
      * Status: is_distributor, is_active_buyer, referral_code, date_joined
      * Financial: wallet_balance, total_earnings
      * Activity: total_bookings, total_binary_pairs
      * Tree Position: parent, side, level, left_count, right_count
      * Binary Commission: binary_commission_activated, activation_timestamp (timestamp when activation occurred)
      * Children: left_child, right_child (recursive structure)
      * Side Members: left_side_members, right_side_members (paginated or flat lists of all members on each side)
    - Pair Matching Eligibility: Only members created at or after activation_timestamp are eligible for pairing
      * Pre-activation members (1st and 2nd) are excluded, 3rd member (activation trigger) and all subsequent members are included
    - left_side_members: Paginated object or array containing all members on the left side with full details (all levels)
    - right_side_members: Paginated object or array containing all members on the right side with full details (all levels)
    - left_child/right_child: Recursive tree structure showing parent-child relationships (conditionally included based on side filter)
    - left_side_members/right_side_members: Paginated objects or flat lists showing all members on each side for easy access
    - All member details are included for each node in the tree (both left and right sides, unless filtered)
    - Wallet balance and earnings are returned as strings with 2 decimal places
    - If user doesn't have a wallet, balance and earnings default to "0.00"
    - Backward Compatibility: Existing API calls without new parameters work exactly as before (returns all members as arrays)


54. MANUALLY PLACE USER IN TREE
    Method: POST
    URL: /api/binary/nodes/place_user/
    Authentication: Required
    Description: Manually place a user in a specific position in the binary tree. Only the tree owner (referrer) can place users who used their referral code.
    
    Request Body:
    {
      "target_user_id": 8,
      "parent_node_id": 5,
      "side": "left",  // "left" or "right"
      "allow_replacement": false  // Optional, default: false
    }
    
    Response (201 Created):
    {
      "id": 10,
      "user": 8,
      "user_email": "user8@example.com",
      "parent": 5,
      "parent_username": "user5@example.com",
      "side": "left",
      "level": 2,
      "left_count": 0,
      "right_count": 0,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "target_user_id, parent_node_id, and side are required"
    }
    OR
    {
      "error": "side must be 'left' or 'right'"
    }
    OR
    {
      "error": "Position left under parent node 5 is already occupied"
    }
    
    Error Response (403):
    {
      "error": "You can only place users in your own binary tree"
    }
    OR
    {
      "error": "This user did not use your referral code and cannot be placed in your tree"
    }
    
    Error Response (404):
    {
      "error": "Target user not found"
    }
    OR
    {
      "error": "Parent node not found"
    }
    
    Notes:
    - IMPORTANT: User must have at least one successful payment before placement
    - If user has no successful payment, placement fails with error message
    - Only the tree owner (referrer) can place users in their tree
    - Target user must have used referrer's referral code (checked via user.referred_by or booking.referred_by)
    - If user already has a node, it will be moved to the new position
    - If position is occupied and allow_replacement=false, returns error
    - Parent node must belong to referrer's tree
    - Automatically updates parent counts after placement
    - Commission is automatically paid when placement succeeds (if user has successful payment)
    - Response includes 'commission_paid' field indicating if commission was paid


55. MOVE DIRECT CHILD IN TREE
    Method: POST
    URL: /api/binary/nodes/move_user/
    Authentication: Required
    Description: Move a direct child to a different side (left or right) under the same parent. Only allows moving direct children (not descendants). Only the tree owner can move their direct children.
    
    Request Body:
    {
      "node_id": 10,
      "new_side": "right"  // "left" or "right"
    }
    
    Response (200 OK):
    {
      "id": 10,
      "user": 8,
      "user_email": "user8@example.com",
      "parent": 5,
      "parent_username": "user5@example.com",
      "side": "right",
      "level": 2,
      "left_count": 0,
      "right_count": 0,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "node_id and new_side are required"
    }
    OR
    {
      "error": "new_side must be 'left' or 'right'"
    }
    OR
    {
      "error": "You can only move your direct children. This user is not a direct child."
    }
    OR
    {
      "error": "User is already on the right side"
    }
    OR
    {
      "error": "Right side is already occupied"
    }
    
    Error Response (403):
    {
      "error": "You can only move users in your own binary tree"
    }
    
    Error Response (404):
    {
      "error": "Node not found"
    }
    OR
    {
      "error": "No binary node found for current user"
    }
    
    Notes:
    - Only the tree owner can move users in their tree
    - Only allows moving DIRECT CHILDREN (users directly under current user's node)
    - Cannot move descendants (only immediate children)
    - New side must be available (not already occupied)
    - Cannot move to the same side (must be different)
    - Automatically updates parent's left_count and right_count


56. LIST AVAILABLE POSITIONS
    Method: GET
    URL: /api/binary/nodes/available_positions/
    Authentication: Required
    Description: List available positions in the current user's binary tree (nodes with open left or right slots)
    
    Response (200 OK):
    {
      "count": 5,
      "available_positions": [
        {
          "node_id": 1,
          "user_id": 1,
          "user_email": "user@example.com",
          "user_username": "user@example.com",
          "user_full_name": "John Doe",
          "referral_code": "REF00001",
          "referral_code_used": null,
          "level": 0,
          "left_available": true,
          "right_available": false,
          "left_count": 0,
          "right_count": 3
        },
        {
          "node_id": 5,
          "user_id": 5,
          "user_email": "user5@example.com",
          "user_username": "user5@example.com",
          "user_full_name": "Jane Smith",
          "referral_code": "REF00005",
          "referral_code_used": "REF00001",
          "level": 1,
          "left_available": false,
          "right_available": true,
          "left_count": 2,
          "right_count": 0
        }
      ]
    }
    
    Error Response (404):
    {
      "message": "No binary node found"
    }
    
    Notes:
    - Returns all nodes in the tree that have at least one available slot (left or right)
    - Each position includes basic user information: full name, email, and referral code
    - Helps UI show where users can be placed with complete parent node information
    - Only tree owner can view available positions in their tree
    - Fields included:
      * node_id: Binary tree node ID (use this for parent_node_id when placing users)
      * user_id: User ID of the node owner
      * user_email: Email address of the node owner
      * user_username: Username of the node owner
      * user_full_name: Full name of the node owner (first_name + last_name)
      * referral_code: Referral code of the node owner
      * referral_code_used: Referral code that was used by this user when joining (null if none used)
      * level: Depth level in the tree (0 = root)
      * left_available: Boolean indicating if left child slot is available
      * right_available: Boolean indicating if right child slot is available
      * left_count: Total descendants on the left side
      * right_count: Total descendants on the right side


57. LIST PENDING USERS
    Method: GET
    URL: /api/binary/nodes/pending_users/
    Authentication: Required
    Description: List users who used referrer's code but are not yet placed in the tree or are placed but not in referrer's tree
    
    Response (200 OK):
    {
      "count": 3,
      "pending_users": [
        {
          "user_id": 8,
          "user_email": "user8@example.com",
          "user_username": "user8@example.com",
          "user_full_name": "John Doe",
          "has_node": false,
          "node_id": null,
          "in_tree": false
        },
        {
          "user_id": 9,
          "user_email": "user9@example.com",
          "user_username": "user9@example.com",
          "user_full_name": "Jane Smith",
          "has_node": true,
          "node_id": 15,
          "in_tree": false
        }
      ]
    }
    
    Notes:
    - Returns users who:
      * Have referred_by = current user, OR
      * Have bookings with referred_by = current user
    - Includes users who don't have a binary node yet
    - Includes users who have a node but are not in referrer's tree
    - Excludes users who are already placed in referrer's tree
    - Helps referrer identify which users need to be placed manually


57. AUTO PLACE PENDING USERS
    Method: POST
    URL: /api/binary/nodes/auto_place_pending/
    Authentication: Required
    Description: Automatically place pending users in the binary tree using the left-priority placement algorithm. Can place all pending users or a specific user. This is the recommended way to place users automatically after they create bookings with your referral code.
    
    Request Body (all optional):
    {
      "target_user_id": 8,  // Optional: Place specific user only. If omitted, places all pending users
      "referring_user_id": 5  // Optional: Override referring user (uses actual referrer from booking/user by default)
    }
    
    Response (200 OK):
    {
      "placed_count": 3,
      "failed_count": 0,
      "placed_users": [
        {
          "user_id": 8,
          "user_email": "user8@example.com",
          "user_full_name": "John Doe",
          "node_id": 10,
          "parent_node_id": 5,
          "parent_email": "referrer@example.com",
          "side": "left",
          "level": 2
        },
        {
          "user_id": 9,
          "user_email": "user9@example.com",
          "user_full_name": "Jane Smith",
          "node_id": 11,
          "parent_node_id": 5,
          "parent_email": "referrer@example.com",
          "side": "right",
          "level": 2
        }
      ],
      "failed_users": []
    }
    
    Response when no pending users (200 OK):
    {
      "placed_count": 0,
      "failed_count": 0,
      "placed_users": [],
      "failed_users": [],
      "message": "No pending users found"
    }
    
    Error Response (400):
    {
      "error": "Invalid target_user_id"
    }
    
    Error Response (404):
    {
      "error": "User 8 not found or did not use your referral code"
    }
    
    Notes:
    - IMPORTANT: User must have at least one successful payment before placement
    - If user has no successful payment, placement fails with error message
    - Automatically places pending users using the left-priority placement algorithm
    - Placement Rules:
      1. First 2 direct referrals: 1st user → LEFT, 2nd user → RIGHT
      2. From 3rd referral onward: Follow LEFT-side chain (traverse left children to find left-most available position)
      3. Referral-based override: If user used a specific parent's code, place in that parent's tree
      4. Default placement side is configurable via Platform Settings (binary_tree_default_placement_side)
    - If no parameters provided: Places ALL pending users who used referrer's code (and have successful payment)
    - If target_user_id provided: Places only that specific user (must have used referrer's code and have successful payment)
    - Users already in referrer's tree are skipped (not placed again)
    - Commission is automatically paid when placement succeeds (if user has successful payment)
    - Recommended workflow:
      1. User creates booking with referral code → No automatic placement
      2. User makes payment → Payment must be completed (status='completed')
      3. Referrer calls this API → Users are placed automatically using left-priority algorithm
      4. Commission is paid immediately upon successful placement
    - Returns both successfully placed users and failed placements (with error messages)
    - Only tree owner can place users in their tree
    - Response includes 'commission_paid' field indicating if commission was paid


58. SWAP DIRECT CHILDREN
    Method: POST
    URL: /api/binary/nodes/swap_direct_children/
    Authentication: Required
    Description: Swap left and right direct children of current user's node. Only tree owner can swap their direct children. Preserves all descendant nodes (they move with their parent).
    
    Request Body: None (uses current user's node)
    
    Response (200 OK):
    {
      "id": 5,
      "user": 1,
      "user_email": "user1@example.com",
      "parent": null,
      "parent_username": null,
      "side": null,
      "level": 0,
      "left_count": 8,
      "right_count": 5,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:15:00Z"
    }
    
    Error Response (400):
    {
      "error": "Both left and right children must exist to swap"
    }
    
    Error Response (404):
    {
      "error": "No binary node found for current user"
    }
    
    Notes:
    - Swaps the side assignment of left and right direct children
    - Both children must exist to perform swap
    - All descendant nodes move with their parent (entire subtree swaps)
    - Automatically updates parent's left_count and right_count (swapped)
    - Only tree owner can swap their direct children


58. CHOOSE SIDE FOR DIRECT REFERRAL
    Method: POST
    URL: /api/binary/nodes/choose_side_for_direct_referral/
    Authentication: Required
    Description: Pre-select side (left or right) for an upcoming direct referral. Parent can choose left/right for their direct referrals. Only works for users who haven't been placed yet or are not in referrer's tree.
    
    Request Body:
    {
      "target_user_id": 8,
      "side": "left"  // "left" or "right"
    }
    
    Response (201 Created):
    {
      "id": 10,
      "user": 8,
      "user_email": "user8@example.com",
      "parent": 5,
      "parent_username": "user5@example.com",
      "side": "left",
      "level": 2,
      "left_count": 0,
      "right_count": 0,
      "created_at": "2026-01-06T12:00:00Z",
      "updated_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "error": "target_user_id and side are required"
    }
    OR
    {
      "error": "side must be 'left' or 'right'"
    }
    OR
    {
      "error": "User is already placed in your tree"
    }
    OR
    {
      "error": "Left side is already occupied"
    }
    
    Error Response (403):
    {
      "error": "This user did not use your referral code"
    }
    
    Error Response (404):
    {
      "error": "Target user not found"
    }
    OR
    {
      "error": "No binary node found for current user"
    }
    
    Notes:
    - Parent can pre-select side for their direct referrals
    - Target user must have used referrer's referral code
    - Requested side must be available (not already occupied)
    - Works for users who haven't been placed yet or are placed in another tree
    - If user already has a node but is in another tree, will be moved to referrer's tree
    - Automatically places user on the chosen side
    - Automatically updates parent's left_count or right_count


================================================================================
                            PAYOUT APIs
================================================================================

58. CREATE PAYOUT REQUEST
    Method: POST
    URL: /api/payout/
    Authentication: Required
    Description: Request payout from wallet. Processing behavior depends on payout_approval_needed setting. User must have approved KYC to request payout.
    
    Eligibility Requirements:
    - User must have approved KYC (kyc.status = 'approved')
    - User must have sufficient wallet balance
    
    Request Body:
    {
      "requested_amount": 10000,
      "bank_name": "State Bank of India",
      "account_number": "1234567890",
      "ifsc_code": "SBIN0001234",
      "account_holder_name": "John Doe",
      "emi_auto_filled": true,  // Optional: Auto-fill EMI from payout
      "reason": "Need funds for emergency expenses"  // Optional: User's reason for payout request
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "requested_amount": "10000.00",
      "tds_amount": "500.00",  // 5% TDS (max ₹10,000)
      "net_amount": "9500.00",
      "bank_name": "State Bank of India",
      "status": "pending",  // or "processing" if payout_approval_needed is false
      "emi_auto_filled": true,
      "emi_amount": "2000.00",  // If EMI auto-fill was used
      "reason": "Need funds for emergency expenses",
      "created_at": "2026-01-06T12:00:00Z"
    }
    
    Error Response (400):
    {
      "non_field_errors": ["User must have approved KYC to request payout."]
    }
    OR
    {
      "requested_amount": ["Insufficient wallet balance"]
    }
    
    Processing Behavior:
    - If payout_approval_needed (in /api/settings/) is false:
      * Payout is automatically processed upon creation
      * Wallet balance is deducted immediately
      * Status is set to "processing"
    - If payout_approval_needed is true (default):
      * Payout status is set to "pending"
      * Admin must approve via POST /api/payout/{id}/process/
      * Wallet balance is deducted only after admin approval
    
    TDS Calculation:
    - TDS percentage is read from Platform Settings (payout_tds_percentage field in /api/settings/)
    - If payout_tds_percentage is 0 (default): No TDS is applied (tds_amount = 0, net_amount = requested_amount)
    - If payout_tds_percentage is non-zero: TDS = requested_amount × (payout_tds_percentage / 100)
    - Maximum ₹10,000 ceiling applies when TDS is calculated
    - Example: If payout_tds_percentage = 5% and requested_amount = ₹10,000, then tds_amount = ₹500, net_amount = ₹9,500


59. LIST PAYOUTS
    Method: GET
    URL: /api/payout/
    Authentication: Required
    Description: List payout requests with comprehensive wallet summary, withdrawal history, and paginated payout list (user sees own, admin sees all)
    
    Query Parameters:
    - status: Filter by status (pending, processing, completed, rejected, cancelled)
    - date_from: Start date for filtering (YYYY-MM-DD format)
    - date_to: End date for filtering (YYYY-MM-DD format)
    - period: Preset period filter (last_7_days, last_30_days, last_90_days, last_year, all_time)
      Note: Preset period takes precedence over date_from/date_to if both are provided
    - page: Page number for pagination (default: 1)
    - page_size: Number of items per page (default: 20, max: 100)
    
    Response (200 OK):
    {
      "wallet_summary": {
        "current_balance": "50000.00",
        "total_earned": "150000.00",
        "total_withdrawn": "100000.00"
      },
      "bank_details": [
        {
          "bank_name": "State Bank of India",
          "account_number": "1234567890",
          "ifsc_code": "SBIN0001234",
          "account_holder_name": "John Doe"
        }
      ],
      "withdrawal_history": [
        {
          "id": 1,
          "requested_amount": "10000.00",
          "tds_amount": "500.00",
          "net_amount": "9500.00",
          "status": "completed",
          "bank_name": "HDFC Bank",
          "account_number": "1234567890",
          "ifsc_code": "HDFC0001234",
          "account_holder_name": "John Doe",
          "created_at": "2026-01-06T12:00:00Z",
          "completed_at": "2026-01-07T10:00:00Z",
          "transaction_id": "TXN123456"
        }
      ],
      "payouts": {
        "count": 15,
        "page": 1,
        "page_size": 20,
        "total_pages": 1,
        "next": null,
        "previous": null,
        "results": [
          {
            "id": 1,
            "requested_amount": "10000.00",
            "tds_amount": "500.00",
            "net_amount": "9500.00",
            "status": "pending",
            "bank_name": "HDFC Bank",
            "account_number": "1234567890",
            "ifsc_code": "HDFC0001234",
            "account_holder_name": "John Doe",
            "emi_auto_filled": false,
            "emi_amount": "0.00",
            "created_at": "2026-01-06T12:00:00Z",
            "processed_at": null,
            "completed_at": null,
            "transaction_id": null,
            "rejection_reason": "",
            "notes": "",
            "user_email": "user@example.com",
            "wallet_balance": "50000.00",
            "bank_details": [
              {
                "bank_name": "State Bank of India",
                "account_number": "1234567890",
                "ifsc_code": "SBIN0001234",
                "account_holder_name": "John Doe"
              }
            ]
          }
        ]
      }
    }
    
    Filter Examples:
    - GET /api/payout/?status=completed
    - GET /api/payout/?date_from=2026-01-01&date_to=2026-01-31
    - GET /api/payout/?period=last_30_days
    - GET /api/payout/?status=pending&period=last_7_days
    - GET /api/payout/?page=2&page_size=50
    
    Notes:
    - wallet_summary: Always shows current wallet state (not filtered by date)
    - bank_details: Array of bank account details fetched from user's KYC document. If user has no KYC or KYC doesn't have bank details, returns empty array. Currently supports one bank account per user (from KYC), but returned as array for future extensibility.
    - withdrawal_history: Shows only completed payouts (limited to last 50 if no date filter applied)
    - payouts: Paginated list of all payout requests matching the filters. Each payout object also includes bank_details field with user's bank accounts from KYC.
    - Date range and preset period are mutually exclusive (preset period takes precedence)


60. PROCESS PAYOUT (Admin Only)
    Method: POST
    URL: /api/payout/{id}/process/
    Authentication: Required (Admin)
    Description: Process payout request - deducts amount from wallet and sets status to 'processing'
    
    This endpoint:
    1. Validates payout is in 'pending' status
    2. Calculates TDS and net amount (if not already calculated)
    3. Handles EMI auto-fill if enabled
    4. Deducts requested_amount from user's wallet
    5. Sets status to 'processing' and records processed_at timestamp
    
    NOTE: Payment gateway integration will be added here in the future.
    After wallet deduction, the payment gateway API will be called to initiate transfer.
    
    Request Body (optional):
    {
      "notes": "Additional notes for processing"
    }
    
    Response (200 OK):
    {
      "message": "Payout processed successfully. Amount deducted from wallet.",
      "payout": {
        "id": 1,
        "status": "processing",
        "requested_amount": "10000.00",
        "tds_amount": "500.00",
        "net_amount": "9500.00",
        "processed_at": "2026-01-06T13:00:00Z",
        "created_at": "2026-01-06T12:00:00Z",
        ...
      }
    }
    
    Error Responses:
    - 400 Bad Request: Payout cannot be processed (wrong status, insufficient balance, etc.)
    {
      "error": "Payout cannot be processed. Current status: processing. Expected: pending"
    }
    
    - 403 Forbidden: User is not admin
    {
      "error": "Permission denied"
    }
    
    Status Flow:
    pending → processing (via this endpoint)


61. COMPLETE PAYOUT (Admin Only)
    Method: POST
    URL: /api/payout/{id}/complete/
    Authentication: Required (Admin)
    Description: Mark payout as completed after payment gateway confirms successful transfer
    
    This endpoint should be called:
    - Manually by admin after verifying bank transfer was successful
    - Automatically by payment gateway webhook when transfer succeeds (future implementation)
    - After synchronous payment gateway API returns success (future implementation)
    
    Request Body:
    {
      "transaction_id": "TXN123456789",  // Optional: Transaction ID from payment gateway
      "notes": "Payment confirmed via bank statement"  // Optional: Additional notes
    }
    
    Response (200 OK):
    {
      "message": "Payout marked as completed successfully.",
      "payout": {
        "id": 1,
        "status": "completed",
        "requested_amount": "10000.00",
        "tds_amount": "500.00",
        "net_amount": "9500.00",
        "transaction_id": "TXN123456789",
        "processed_at": "2026-01-06T13:00:00Z",
        "completed_at": "2026-01-06T14:00:00Z",
        "notes": "Payment confirmed via bank statement",
        ...
      }
    }
    
    Error Responses:
    - 400 Bad Request: Payout cannot be completed (wrong status)
    {
      "error": "Payout cannot be completed. Current status: pending. Expected: processing"
    }
    
    - 403 Forbidden: User is not admin
    {
      "error": "Permission denied"
    }
    
    Status Flow:
    processing → completed (via this endpoint)
    
    NOTE: For future payment gateway integration, a webhook endpoint will be created
    that calls this endpoint automatically when the gateway confirms payment success.


62. PAYMENT GATEWAY WEBHOOK (Future Implementation)
    Method: POST
    URL: /api/payout/webhook/
    Authentication: Webhook signature verification (no user auth required)
    Description: Webhook endpoint for payment gateway to notify payout status changes
    
    NOTE: This endpoint is planned for future payment gateway integration.
    It will be implemented when a payment gateway is integrated.
    
    Expected Request Body (example - actual format depends on payment gateway):
    {
      "event": "payout.success" | "payout.failed" | "payout.pending",
      "payout_id": "internal_payout_id_or_reference",
      "gateway_transaction_id": "TXN123456789",
      "amount": "9500.00",
      "status": "success" | "failed" | "pending",
      "timestamp": "2026-01-06T14:00:00Z",
      "signature": "webhook_signature_for_verification"
    }
    
    Implementation Plan:
    1. Verify webhook signature for security
    2. Find payout by payout_id or gateway_transaction_id
    3. If event == "payout.success":
       - Call complete_payout(payout, transaction_id=gateway_transaction_id)
    4. If event == "payout.failed":
       - Set payout.status = 'rejected'
       - Refund amount to user's wallet
       - Store failure reason in payout.rejection_reason
    5. Return 200 OK to acknowledge webhook receipt
    
    Response (200 OK):
    {
      "status": "received",
      "message": "Webhook processed successfully"
    }


63. LIST PAYOUT TRANSACTIONS
    Method: GET
    URL: /api/payout/transactions/
    Authentication: Required
    Description: List payout transaction records
    
    Response (200 OK):
    {
      "count": 10,
      "results": [
        {
          "id": 1,
          "payout_id": 1,
          "user": 1,
          "amount": "10000.00",
          "transaction_type": "payout",
          "description": "Payout request #1",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


================================================================================
                         NOTIFICATION APIs
================================================================================

63. LIST NOTIFICATIONS
    Method: GET
    URL: /api/notifications/
    Authentication: Required
    Description: List user's notifications
    
    Query Parameters:
    - is_read: Filter by read status (true/false)
    - notification_type: Filter by type (booking, payment, wallet, binary, payout, kyc, system)
    
    Response (200 OK):
    {
      "count": 20,
      "results": [
        {
          "id": 1,
          "user": 1,
          "notification_type": "booking",
          "title": "Booking Confirmed",
          "message": "Your booking EVABC1234 has been confirmed",
          "is_read": false,
          "reference_id": 1,
          "reference_type": "booking",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


64. MARK NOTIFICATION AS READ
    Method: POST
    URL: /api/notifications/{id}/mark_read/
    Authentication: Required
    Description: Mark a specific notification as read
    
    Response (200 OK):
    {
      "id": 1,
      "is_read": true,
      "read_at": "2026-01-06T13:00:00Z",
      ...
    }


65. MARK ALL NOTIFICATIONS AS READ
    Method: POST
    URL: /api/notifications/mark_all_read/
    Authentication: Required
    Description: Mark all user's notifications as read
    
    Response (200 OK):
    {
      "message": "All notifications marked as read"
    }


66. GET UNREAD COUNT
    Method: GET
    URL: /api/notifications/unread_count/
    Authentication: Required
    Description: Get count of unread notifications
    
    Response (200 OK):
    {
      "unread_count": 5
    }


================================================================================
                         COMPLIANCE APIs
================================================================================

67. UPLOAD COMPLIANCE DOCUMENT
    Method: POST
    URL: /api/compliance/documents/
    Authentication: Required
    Description: Upload compliance document
    
    Request Body (multipart/form-data):
    {
      "document_type": "tds_certificate",  // "tds_certificate", "pan_card", "aadhaar", "bank_statement", "other"
      "title": "TDS Certificate 2025-26",
      "description": "Annual TDS certificate",
      "file": <file>
    }
    
    Response (201 Created):
    {
      "id": 1,
      "user": 1,
      "document_type": "tds_certificate",
      "title": "TDS Certificate 2025-26",
      "is_verified": false,
      "uploaded_at": "2026-01-06T12:00:00Z"
    }


68. LIST COMPLIANCE DOCUMENTS
    Method: GET
    URL: /api/compliance/documents/
    Authentication: Required
    Description: List user's compliance documents
    
    Response (200 OK):
    {
      "count": 5,
      "results": [
        {
          "id": 1,
          "document_type": "tds_certificate",
          "title": "TDS Certificate 2025-26",
          "is_verified": true,
          "uploaded_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


79. LIST TDS RECORDS
    Method: GET
    URL: /api/compliance/tds/
    Authentication: Required
    Description: List TDS records for user
    
    Response (200 OK):
    {
      "count": 2,
      "results": [
        {
          "id": 1,
          "user": 1,
          "financial_year": "2025-26",
          "total_payout": "100000.00",
          "tds_deducted": "5000.00",
          "certificate_number": "TDS202526001",
          "created_at": "2026-01-06T12:00:00Z"
        }
      ]
    }


================================================================================
                            REPORTS APIs
================================================================================

80. DASHBOARD STATISTICS
    Method: GET
    URL: /api/reports/dashboard/
    Authentication: Required
    Description: Get dashboard statistics (different for admin vs user)
    
    Response for User (200 OK):
    {
      "wallet_balance": "15000.00",
      "total_earnings": "20000.00",
      "total_withdrawn": "5000.00",
      "active_bookings": 2,
      "total_bookings": 5,
      "binary_pairs": 10,
      "pending_payouts": 1
    }
    
    Response for Admin (200 OK):
    {
      "total_users": 1000,
      "active_buyers": 500,
      "total_bookings": 2000,
      "total_revenue": "100000000.00",
      "total_wallet_balance": "5000000.00",
      "pending_payouts": 50
    }


81. SALES REPORT (Admin Only)
    Method: GET
    URL: /api/reports/sales/
    Authentication: Required (Admin)
    Description: Get sales report
    
    Query Parameters:
    - start_date: Start date (YYYY-MM-DD)
    - end_date: End date (YYYY-MM-DD)
    
    Response (200 OK):
    {
      "total_sales": "5000000.00",
      "total_transactions": 500,
      "bookings": 200
    }


82. USER REPORT
    Method: GET
    URL: /api/reports/user/
    Authentication: Required
    Description: Get user activity report
    
    Query Parameters (Admin only):
    - user_id: User ID to get report for
    
    Response (200 OK):
    {
      "user": {
        "id": 1,
        "username": "user@example.com",
        "email": "user@example.com",
        "is_active_buyer": true
      },
      "bookings": 5,
      "total_paid": "50000.00",
      "wallet_balance": "15000.00",
      "binary_pairs": 10,
      "payouts": 3
    }


83. WALLET REPORT
    Method: GET
    URL: /api/reports/wallet/
    Authentication: Required
    Description: Get wallet transaction report
    
    Query Parameters:
    - user_id: User ID (admin only)
    - start_date: Start date (YYYY-MM-DD)
    - end_date: End date (YYYY-MM-DD)
    
    Response (200 OK):
    {
      "total_transactions": 50,
      "total_credit": "25000.00",
      "total_debit": "10000.00",
      "by_type": [
        {
          "transaction_type": "BINARY_PAIR",
          "count": 10,
          "total": "5000.00"
        },
        {
          "transaction_type": "REFERRAL_BONUS",
          "count": 5,
          "total": "2500.00"
        }
      ]
    }


84. DISTRIBUTOR DASHBOARD (Distributors Only)
    Method: GET
    URL: /api/reports/distributor-dashboard/
    Authentication: Required (Distributors only)
    Description: Get comprehensive distributor dashboard with team performance, growth trends, sales activity, and commission data. Only accessible to users with is_distributor=True.
    
    Response (200 OK):
    {
      "top_performers": [
        {
          "name": "Amalnath C K",
          "referrals": 3,
          "team": "RSA"
        },
        {
          "name": "Nizamol V K",
          "referrals": 3,
          "team": "RSB"
        },
        {
          "name": "Anupriya Raj",
          "referrals": 2,
          "team": "RSA"
        },
        {
          "name": "Rubina mol k",
          "referrals": 1,
          "team": "RSA"
        },
        {
          "name": "Anamika Soman",
          "referrals": 0,
          "team": "RSA"
        }
      ],
      "team_growth_trend": {
        "months": ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        "counts": [0, 0, 2, 4, 6, 8]
      },
      "team_distribution": {
        "rsa_percentage": 63,
        "rsb_percentage": 38,
        "rsa_count": 5,
        "rsb_count": 3
      },
      "recent_sales_activity": [
        {
          "date": "21 Jan 2026",
          "left_pv": "5000.00",
          "right_pv": "5000.00",
          "matched_pv": "5000.00",
          "commission": "2000.00",
          "net_amount": "1800.00",
          "status": "matched"
        },
        {
          "date": "20 Jan 2026",
          "left_pv": "5000.00",
          "right_pv": "5000.00",
          "matched_pv": "5000.00",
          "commission": "2000.00",
          "net_amount": "1800.00",
          "status": "matched"
        },
        {
          "date": "19 Jan 2026",
          "left_pv": "5000.00",
          "right_pv": "5000.00",
          "matched_pv": "5000.00",
          "commission": "2000.00",
          "net_amount": "1800.00",
          "status": "matched"
        }
      ],
      "commission_trend": {
        "months": ["Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        "amounts": [9000.0, 9000.0, 9000.0, 9000.0, 9000.0, 9000.0]
      }
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "This endpoint is only available for distributors."
    }
    
    Error Response (404 Not Found):
    {
      "error": "Binary node not found. Please ensure you have a binary tree structure."
    }
    
    Notes:
    - Only users with is_distributor=True can access this endpoint
    - Returns comprehensive analytics for distributors including:
      * Top Performers: Top 5 team members with highest referrals (sorted by referral count)
      * Team Growth Trend: Monthly team member growth for last 6 calendar months
      * Team Distribution: RSA (left) vs RSB (right) distribution as percentages and counts
      * Recent Sales Activity: Last 20 binary pairs with Left PV, Right PV, Matched PV, Commission, Net Amount, and Status
      * Commission Trend: Monthly commission earnings (net_amount) for last 6 calendar months
    - Top Performers:
      * Includes all team members in distributor's binary tree (all descendants)
      * Counts total referrals for each member (direct referrals + booking referrals)
      * Team assignment: RSA for left side, RSB for right side
      * Returns top 5 performers sorted by referral count (descending)
    - Team Growth Trend:
      * Groups team members by month of creation (using BinaryNode created_at)
      * Returns data for last 6 calendar months
      * Handles year rollover correctly
    - Team Distribution:
      * Calculates RSA (left) vs RSB (right) percentages from BinaryNode counts
      * Updates counts before calculation for accuracy
      * Returns percentages and absolute counts
    - Recent Sales Activity:
      * Gets last 20 binary pairs for distributor
      * Left PV: Sum of completed payment amounts for left_user (or booking amount fallback)
      * Right PV: Sum of completed payment amounts for right_user (or booking amount fallback)
      * Matched PV: Minimum of Left PV and Right PV, or pair_amount from BinaryPair
      * Commission: pair_amount or earning_amount from BinaryPair
      * Net Amount: net_amount from BinaryEarning
      * Status: status from BinaryPair (matched, pending, processed)
      * Date: Formatted as "DD MMM YYYY" (e.g., "21 Jan 2026")
    - Commission Trend:
      * Groups BinaryEarning records by month (from created_at)
      * Sums net_amount per month for last 6 calendar months
      * Returns formatted data for bar chart visualization
    - PV (Point Value) Calculation:
      * Left PV: Sum of completed payment amounts for left_user, or booking amount if no payments
      * Right PV: Sum of completed payment amounts for right_user, or booking amount if no payments
      * Matched PV: Minimum of Left PV and Right PV, or pair_amount if available
    - Requires binary node to exist (returns 404 if not found)
    - All monetary values are returned as strings with 2 decimal places
    - Month names are abbreviated (Jan, Feb, Mar, etc.)
    - Team assignment (RSA/RSB) is based on user's side in BinaryNode relative to distributor's tree


85. ADMIN DASHBOARD (Admin/Staff Only)
    Method: GET
    URL: /api/reports/admin-dashboard/
    Authentication: Required (Admin or Staff)
    Description: Get comprehensive admin dashboard with all business intelligence metrics including KPIs, charts, sales funnel, conversion rates, buyer segments, and staff performance. Only accessible to admin and staff roles.
    
    Response (200 OK):
    {
      "kpi_cards": {
        "active_buyers": {
          "value": 8450,
          "change": 8.5,
          "trend": "up"
        },
        "total_visitors": {
          "value": 10000,
          "change": 8.2,
          "trend": "up"
        },
        "pre_booked": {
          "value": 1250,
          "conversion": 12.5
        },
        "paid_orders": {
          "value": 850,
          "conversion": 68.0
        },
        "delivered": {
          "value": 720,
          "conversion": 84.7
        }
      },
      "booking_trends": {
        "months": ["Jan", "Feb", "Mar", "Apr"],
        "bookings": [120, 180, 240, 300],
        "growth": 15.2
      },
      "payment_distribution": {
        "full_payment": {
          "count": 450,
          "percentage": 45.0
        },
        "emi": {
          "count": 300,
          "percentage": 30.0
        },
        "wallet": {
          "count": 150,
          "percentage": 15.0
        },
        "mixed": {
          "count": 100,
          "percentage": 10.0
        }
      },
      "staff_performance": [
        {
          "name": "Rahul",
          "achievement": 85
        },
        {
          "name": "Priya",
          "achievement": 92
        },
        {
          "name": "Amit",
          "achievement": 78
        },
        {
          "name": "Sneha",
          "achievement": 88
        },
        {
          "name": "Vikram",
          "achievement": 68
        }
      ],
      "buyer_growth_trend": {
        "months": ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
        "active_buyers": [3000, 3500, 4000, 4500, 5000, 5500],
        "total_buyers": [7000, 7500, 8000, 8500, 9000, 9500]
      },
      "buyer_segments": {
        "active_buyers": 6100,
        "inactive": 2650,
        "pre_booked": 1250,
        "new_this_month": 950
      },
      "sales_funnel": [
        {
          "stage": "Visitors",
          "count": 10000,
          "percentage": 100.0,
          "drop_off": null
        },
        {
          "stage": "Interested",
          "count": 3500,
          "percentage": 35.0,
          "drop_off": 65.0
        },
        {
          "stage": "Pre-Booked",
          "count": 1250,
          "percentage": 12.5,
          "drop_off": 64.3
        },
        {
          "stage": "Paid",
          "count": 850,
          "percentage": 8.5,
          "drop_off": 32.0
        },
        {
          "stage": "Delivered",
          "count": 720,
          "percentage": 7.2,
          "drop_off": 15.3
        }
      ],
      "conversion_rates": [
        {
          "from": "Visitors",
          "to": "Interested",
          "rate": 35.0,
          "change": 2.5,
          "trend": "up",
          "converted_count": 3500
        },
        {
          "from": "Interested",
          "to": "Pre-Booked",
          "rate": 35.7,
          "change": 1.2,
          "trend": "down",
          "converted_count": 1250
        },
        {
          "from": "Pre-Booked",
          "to": "Paid",
          "rate": 68.0,
          "change": 3.8,
          "trend": "up",
          "converted_count": 850
        },
        {
          "from": "Paid",
          "to": "Delivered",
          "rate": 84.7,
          "change": 0.5,
          "trend": "up",
          "converted_count": 720
        }
      ],
      "pre_bookings": {
        "kpi_cards": {
          "total_pre_bookings": 1250,
          "pending": 245,
          "confirmed": 850,
          "total_amount": 6250000.00
        },
        "summary": {
          "total_count": 1250,
          "pending_count": 245,
          "confirmed_count": 850,
          "expired_count": 155,
          "total_amount": 6250000.00
        }
      },
      "emi_orders": {
        "kpi_cards": {
          "total_emi_orders": 850,
          "active_emis": 720,
          "monthly_collection": 4800000.00,
          "pending_amount": 68500000.00
        },
        "collection_trend": {
          "months": ["Jan", "Feb", "Mar", "Apr"],
          "amounts": [3200000.00, 4800000.00, 5200000.00, 4800000.00],
          "order_counts": [45, 58, 62, 55]
        },
        "summary": {
          "total_count": 850,
          "active_count": 720,
          "completed_count": 100,
          "cancelled_count": 30,
          "total_collected": 45000000.00,
          "total_pending": 68500000.00
        }
      },
      "cancelled_orders": {
        "kpi_cards": {
          "total_cancelled": 67,
          "total_amount": 8200000.00,
          "refund_pending": 12,
          "cancellation_rate": 5.4
        },
        "cancellation_trend": {
          "months": ["Jan", "Feb", "Mar", "Apr"],
          "counts": [12, 15, 18, 22]
        },
        "summary": {
          "total_count": 67,
          "total_amount": 8200000.00,
          "refund_pending_count": 12,
          "refund_processed_count": 55,
          "total_refunded_amount": 7500000.00,
          "pending_refund_amount": 700000.00
        }
      }
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "This endpoint is only available for admin and staff users."
    }
    
    Notes:
    - Only Admin and Staff roles can access this endpoint
    - Returns comprehensive dashboard data including:
      * KPI Cards: Active Buyers, Total Visitors, Pre-Booked, Paid Orders, Delivered with percentage changes and conversion rates
      * Booking Trends: Monthly booking data for last 4 months with growth percentage
      * Payment Distribution: Breakdown by payment type (Full Payment, EMI, Wallet, Mixed) with counts and percentages
      * Staff Performance: Achievement percentages for all staff members based on bookings processed
      * Buyer Growth Trend: Cumulative active buyers and total buyers over last 6 months
      * Buyer Segments: Distribution of buyer categories (Active, Inactive, Pre-Booked, New This Month)
      * Sales Funnel: 5-stage funnel (Visitors → Interested → Pre-Booked → Paid → Delivered) with drop-off percentages
      * Conversion Rates: Stage-to-stage conversion rates with trend indicators (up/down) and percentage changes
      * Pre-Bookings: Pre-booking dashboard data with KPIs and summary
      * EMI Orders: EMI orders dashboard data with KPIs, collection trend, and summary
      * Cancelled Orders: Cancelled orders dashboard data with KPIs, cancellation trend, and refund status
    - KPI Cards:
      * Active Buyers: Count of users with is_active_buyer=True, with percentage change vs last month
      * Total Visitors: Total registered users count, with percentage change vs last month
      * Pre-Booked: Bookings with status='pending', with conversion rate from total visitors
      * Paid Orders: Bookings with completed payments, with conversion rate from pre-booked
      * Delivered: Bookings with status='delivered', with conversion rate from paid orders
    - Booking Trends:
      * Returns monthly booking counts for last 4 months
      * Growth percentage calculated as ((current_month - previous_month) / previous_month) * 100
      * Month names are abbreviated (Jan, Feb, Mar, etc.)
    - Payment Distribution:
      * Full Payment: Bookings with payment_option='full_payment' and single payment method (not wallet)
      * EMI: Bookings with payment_option='emi_options' (excluding wallet-only)
      * Wallet: Payments made using wallet payment method
      * Mixed: Bookings with multiple different payment methods
      * Percentages are calculated from total bookings with completed payments
    - Staff Performance:
      * Calculates achievement percentage based on bookings processed per staff member
      * Uses default target of 100 bookings per month (can be adjusted)
      * Returns staff members sorted by achievement (descending)
      * Note: Since there's no direct staff assignment tracking, performance is calculated based on total bookings divided among staff
    - Buyer Growth Trend:
      * Returns cumulative counts at end of each month (not new users per month)
      * Active Buyers: Cumulative count of users with is_active_buyer=True at end of each month
      * Total Buyers: Cumulative count of all users at end of each month
      * Returns data for last 6 calendar months
    - Buyer Segments:
      * Active Buyers: Users with is_active_buyer=True
      * Inactive: Users who are not active buyers (is_active_buyer=False, role='user')
      * Pre-Booked: Users with pending bookings (bookings__status='pending')
      * New This Month: Users who joined in the current month
    - Sales Funnel:
      * Visitors: Total registered users
      * Interested: Users with bookings (pre-booked status)
      * Pre-Booked: Same as Interested (users with pending bookings)
      * Paid: Users with completed payments (bookings__payments__status='completed')
      * Delivered: Users with delivered bookings (bookings__status='delivered')
      * Drop-off percentages calculated between consecutive stages
      * Percentages are relative to total visitors (100%)
    - Conversion Rates:
      * Visitors → Interested: Percentage of visitors who created bookings
      * Interested → Pre-Booked: Percentage of interested users who pre-booked (same as interested in this implementation)
      * Pre-Booked → Paid: Percentage of pre-booked users who made payments
      * Paid → Delivered: Percentage of paid users who received delivery
      * Change: Percentage point change vs previous period
      * Trend: "up" if change >= 0, "down" if change < 0
      * Converted Count: Number of users converted at each stage
    - Pre-Bookings:
      * Total Pre-Bookings: Count of all bookings with status in ['pending', 'active', 'expired']
      * Pending: Count of bookings with status='pending' (not yet confirmed/active)
      * Confirmed: Count of bookings with status='active' (confirmed/active buyers who paid >= ₹5000)
      * Total Amount: Sum of booking_amount for all pre-bookings
      * Summary includes breakdown by status (pending, confirmed, expired)
    - EMI Orders:
      * Total EMI Orders: Count of bookings with payment_option='emi_options'
      * Active EMIs: EMI orders that are not completed/cancelled (status in ['pending', 'active'])
      * Monthly Collection: Sum of EMI payments collected in current month
      * Pending Amount: Total remaining_amount across all active EMI orders
      * Collection Trend: Monthly EMI collection data for last 4 months with amounts and order counts
      * Summary includes total collected, total pending, and status breakdown
    - Cancelled Orders:
      * Total Cancelled: Count of bookings with status='cancelled'
      * Total Amount: Sum of total_amount for cancelled bookings
      * Refund Pending: Cancelled bookings with payments that haven't been refunded (total_paid > 0 and no refunded payments)
      * Cancellation Rate: (Total Cancelled / Total Bookings) * 100
      * Cancellation Trend: Monthly cancellation counts for last 4 months
      * Summary includes refund status breakdown (pending vs processed) and refund amounts
      * Refund status determined by checking Payment model for status='refunded'
    - All monetary values and counts are returned as numbers (not strings)
    - Percentage values are rounded to 1 decimal place
    - Month names are abbreviated (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec)
    - Date calculations use current month and previous month for comparisons
    - Empty data scenarios are handled gracefully (returns 0 or empty arrays)


================================================================================
                         PLATFORM SETTINGS APIs
================================================================================

86. GET PLATFORM SETTINGS
   Method: GET
   URL: /api/settings/
   Authentication: Required (All authenticated users)
   Description: Get current platform settings
   
   Response (200 OK):
   {
     "id": 1,
     "booking_reservation_timeout_minutes": 1440,  // 24 hours in minutes, null = never expires
     "direct_user_commission_amount": "1000.00",  // Commission per direct user before activation (default: ₹1000)
     "binary_commission_activation_count": 3,  // Number of direct users needed to activate binary commission (default: 3)
     "binary_pair_commission_amount": "2000.00",  // Commission per binary pair after activation (default: ₹2000)
     "binary_tds_threshold_pairs": 5,  // Number of pairs after activation before extra deduction starts (default: 5)
     "binary_commission_tds_percentage": "20.00",  // TDS percentage on ALL binary commissions (default: 20%)
     "binary_extra_deduction_percentage": "20.00",  // Extra deduction percentage on 6th+ pairs (default: 20%)
     "binary_daily_pair_limit": 10,  // Maximum binary pairs per day after activation (default: 10 pairs = ₹20,000)
     "max_earnings_before_active_buyer": 5,  // Maximum number of binary pairs non-Active Buyer distributors can earn commission for before becoming Active Buyer (default: 5 pairs). 6th+ pairs are blocked until user becomes Active Buyer (default: 5, min: 1)
     "binary_commission_initial_bonus": "0.00",  // Initial bonus amount (in rupees) credited to user's wallet and total_earnings when binary commission is activated (3 persons). TDS is deducted from this amount, but TDS is NOT deducted from booking balance (default: 0)
     "binary_tree_default_placement_side": "left",  // Default placement side for binary tree: "left" or "right" (default: "left")
     "activation_amount": "5000.00",  // Minimum payment amount per booking required for seniors to earn commission. If payment is less than this amount, no commission is credited, but user is still counted in descendants calculation. On cancellation, this amount is withheld for future point redemption (default: ₹5000)
     "distributor_application_auto_approve": true,  // If true, distributor applications are auto-approved; if false, require admin/staff approval (default: true)
     "payout_approval_needed": true,  // If true, payout requests require admin approval; if false, payouts are automatically processed (default: true)
     "payout_tds_percentage": "0.00",  // TDS percentage applied on payout withdrawals (default: 0, meaning no payout TDS, range: 0-100)
     "updated_at": "2026-01-14T09:00:00Z",
     "updated_by": 1,
     "updated_by_username": "admin@example.com",
     "updated_by_email": "admin@example.com"
   }
   
   Note:
   - Returns singleton settings instance
   - All authenticated users can view settings
   - booking_reservation_timeout_minutes: Integer (minutes) or null (never expires)
   - All binary commission settings are configurable via UPDATE PLATFORM SETTINGS endpoint
   - binary_commission_tds_percentage: Applied to ALL commissions (direct user and pairs)
   - binary_extra_deduction_percentage: Additional deduction for 6th+ pairs (in addition to TDS)
   - binary_daily_pair_limit: Maximum pairs per day (resets at midnight)
   - binary_commission_initial_bonus: Initial bonus amount credited to user's wallet and total_earnings when binary commission is activated (3 persons). TDS is calculated and deducted from the bonus amount itself, but TDS is NOT deducted from booking balance. Only the net amount (after TDS) is credited to wallet
   - activation_amount: Minimum payment amount per booking required for seniors to earn commission. If payment is less than this amount, no commission is credited, but user is still counted in descendants calculation. On cancellation, this amount is withheld for future point redemption (default: ₹5000)


87. UPDATE PLATFORM SETTINGS (Admin Only)
   Method: PATCH
   URL: /api/settings/
   Authentication: Required (Admin or Superuser only)
   Description: Update platform settings. Only admin/superuser can modify settings.
   
   Request Body (all fields optional - partial update supported):
   {
     "booking_reservation_timeout_minutes": 1440,  // Integer (minutes) or null (never expires)
     "direct_user_commission_amount": 1000,  // Commission per direct user before activation (default: ₹1000)
     "binary_commission_activation_count": 3,  // Number of direct users needed to activate binary commission (default: 3, min: 1)
     "binary_pair_commission_amount": 2000,  // Commission per binary pair after activation (default: ₹2000)
     "binary_tds_threshold_pairs": 5,  // Number of pairs after activation before extra deduction starts (default: 5, min: 0)
     "binary_commission_tds_percentage": 20,  // TDS percentage on ALL binary commissions (default: 20%, range: 0-100)
     "binary_extra_deduction_percentage": 20,  // Extra deduction percentage on 6th+ pairs (default: 20%, range: 0-100)
     "binary_daily_pair_limit": 10,  // Maximum binary pairs per day after activation (default: 10, min: 1)
     "max_earnings_before_active_buyer": 5,  // Maximum number of binary pairs non-Active Buyer distributors can earn commission for before becoming Active Buyer (default: 5 pairs). 6th+ pairs are blocked until user becomes Active Buyer (default: 5, min: 1)
     "binary_commission_initial_bonus": 0,  // Initial bonus amount (in rupees) credited to user's wallet and total_earnings when binary commission is activated (3 persons). TDS is deducted from this amount, but TDS is NOT deducted from booking balance (default: 0)
     "binary_tree_default_placement_side": "left",  // Default placement side: "left" or "right" (default: "left")
     "activation_amount": 5000,  // Minimum payment amount per booking required for seniors to earn commission. If payment is less than this amount, no commission is credited, but user is still counted in descendants calculation. On cancellation, this amount is withheld for future point redemption (default: ₹5000, min: 0)
     "distributor_application_auto_approve": true,  // If true, auto-approve distributor applications; if false, require admin/staff approval (default: true)
     "payout_approval_needed": true,  // If true, payout requests require admin approval; if false, payouts are automatically processed upon creation (default: true)
     "payout_tds_percentage": 0  // TDS percentage applied on payout withdrawals (default: 0, meaning no payout TDS, range: 0-100)
   }
   
   Response (200 OK):
   {
     "id": 1,
     "booking_reservation_timeout_minutes": 1440,
     "direct_user_commission_amount": "1000.00",
     "binary_commission_activation_count": 3,
     "binary_pair_commission_amount": "2000.00",
     "binary_tds_threshold_pairs": 5,
     "binary_commission_tds_percentage": "20.00",
     "binary_extra_deduction_percentage": "20.00",
     "binary_daily_pair_limit": 10,
     "max_earnings_before_active_buyer": 5,
     "binary_commission_initial_bonus": "0.00",
     "binary_tree_default_placement_side": "left",
     "distributor_application_auto_approve": true,
     "payout_approval_needed": true,
     "payout_tds_percentage": "0.00",
     "updated_at": "2026-01-14T09:15:00Z",
     "updated_by": 1,
     "updated_by_username": "admin@example.com",
     "updated_by_email": "admin@example.com"
   }
   
   Error Response (400):
   {
     "booking_reservation_timeout_minutes": ["booking_reservation_timeout_minutes must be at least 1 minute or null (never expires)"],
     "direct_user_commission_amount": ["direct_user_commission_amount must be non-negative"],
     "binary_commission_activation_count": ["binary_commission_activation_count must be at least 1"],
     "binary_pair_commission_amount": ["binary_pair_commission_amount must be non-negative"],
     "binary_tds_threshold_pairs": ["binary_tds_threshold_pairs must be non-negative"],
     "binary_commission_tds_percentage": ["binary_commission_tds_percentage must be between 0 and 100"],
     "binary_extra_deduction_percentage": ["binary_extra_deduction_percentage must be between 0 and 100"],
     "binary_daily_pair_limit": ["binary_daily_pair_limit must be at least 1"],
     "max_earnings_before_active_buyer": ["max_earnings_before_active_buyer must be at least 1"],
     "binary_commission_initial_bonus": ["binary_commission_initial_bonus must be non-negative"],
     "payout_tds_percentage": ["payout_tds_percentage must be between 0 and 100"]
   }
   
   Error Response (403):
   {
     "detail": "Only admin or superuser can update platform settings."
   }
   
   Notes:
   - Only admin or superuser can update settings
   - All fields are optional (partial update supported)
   - booking_reservation_timeout_minutes: Minimum value is 1 minute, or null for never expires
   - direct_user_commission_amount: Commission paid per direct user added before binary commission activation
   - binary_commission_activation_count: Number of direct children needed to activate binary commission (default: 3)
   - binary_pair_commission_amount: Commission paid per binary pair after activation (default: ₹2000)
   - binary_commission_initial_bonus: Initial bonus amount credited to user's wallet and total_earnings when binary commission is activated (3 persons). TDS is calculated and deducted from the bonus amount itself, but TDS is NOT deducted from booking balance. Only the net amount (after TDS) is credited to wallet. Actual deductions from booking balance only occur after 5 pairs completed (6th pair onwards with binary_extra_deduction_percentage)
   - binary_tds_threshold_pairs: Number of pairs after activation before extra deduction applies (default: 5)
   - binary_commission_tds_percentage: TDS percentage applied to ALL binary commissions - direct user and pairs (default: 20%, range: 0-100)
   - binary_extra_deduction_percentage: Extra deduction percentage for 6th+ pairs in addition to TDS (default: 20%, range: 0-100)
   - binary_daily_pair_limit: Maximum binary pairs per day after activation (default: 10 pairs = ₹20,000 before deductions)
   - max_earnings_before_active_buyer: Maximum number of binary pairs non-Active Buyer distributors can earn commission for before becoming Active Buyer (default: 5 pairs, min: 1)
     * Non-Active Buyer distributors can only earn commission for the first N pairs (where N = max_earnings_before_active_buyer)
     * Pairs beyond this limit (N+1th pair onwards) are blocked until the distributor becomes an Active Buyer (total paid ≥ ₹5000)
     * When a distributor becomes an Active Buyer, future pairs will be paid normally
     * This setting controls the commission restriction for non-Active Buyer distributors
   - binary_tree_default_placement_side: Default placement side for binary tree placement algorithm (default: "left", options: "left" or "right")
     * Controls which side chain is followed after first 2 users are placed
     * If "left": 1st user → LEFT, 2nd user → RIGHT, 3rd+ → follow LEFT chain
     * If "right": 1st user → RIGHT, 2nd user → LEFT, 3rd+ → follow RIGHT chain
     * See Binary Tree Placement notes in CREATE BOOKING endpoint for detailed placement rules
   - distributor_application_auto_approve: Controls automatic approval of distributor applications (default: true)
     * If true: Applications are automatically approved upon creation, user becomes distributor immediately
     * If false: Applications remain in 'pending' status, require admin/staff approval via update-status endpoint
     * See CREATE DISTRIBUTOR APPLICATION endpoint for detailed behavior
   - payout_approval_needed: Controls automatic processing of payout requests (default: true)
     * If true: Payout requests require admin approval via POST /api/payout/{id}/process/ before processing
     * If false: Payout requests are automatically processed upon creation (wallet deducted, status set to 'processing')
     * See CREATE PAYOUT REQUEST endpoint for detailed behavior
   - payout_tds_percentage: Controls TDS applied on payout withdrawals (default: 0, range: 0-100)
     * If 0: No TDS is applied on payouts (tds_amount = 0, net_amount = requested_amount)
     * If non-zero: TDS is calculated as requested_amount × (payout_tds_percentage / 100) with maximum ₹10,000 ceiling
     * This setting is separate from binary commission TDS (binary_commission_tds_percentage)
     * See CREATE PAYOUT REQUEST endpoint for detailed TDS calculation behavior
   - updated_by is automatically set to the current user making the update
   - Settings are stored as a singleton (only one instance exists)
   - Timeout is stored in minutes (converted from hours for backward compatibility)
   - Example: 1440 minutes = 24 hours, 60 minutes = 1 hour, null = never expires
   - Daily pair limit resets at midnight (00:00 server time)


86. COMPREHENSIVE REPORTS (Admin/Staff Only)
    Method: GET
    URL: /api/reports/comprehensive/
    Authentication: Required (Admin or Staff)
    Description: Get comprehensive reports aggregating all dashboard data including transaction history,
     investment logs, BV logs, referral commission, team commission, login history, and notification history. 
     Only accessible to admin and staff roles. Supports per-section pagination and status filtering.
    
    Query Parameters:
    - sections (optional): Comma-separated list of sections to include. Options: transaction_history, investment_logs, bv_logs, 
      referral_commission, team_commission, login_history, notification_history. If not provided, all sections are returned.
    
    Pagination Parameters (per-section):
    - transaction_page (optional, default: 1): Page number for transaction history
    - transaction_page_size (optional, default: 20, max: 100): Items per page for transaction history
    - investment_page (optional, default: 1): Page number for investment logs
    - investment_page_size (optional, default: 20, max: 100): Items per page for investment logs
    - bv_page (optional, default: 1): Page number for BV logs
    - bv_page_size (optional, default: 20, max: 100): Items per page for BV logs
    - referral_page (optional, default: 1): Page number for referral commission
    - referral_page_size (optional, default: 20, max: 100): Items per page for referral commission
    - team_page (optional, default: 1): Page number for team commission
    - team_page_size (optional, default: 20, max: 100): Items per page for team commission
    - notification_page (optional, default: 1): Page number for notification history
    - notification_page_size (optional, default: 20, max: 100): Items per page for notification history
    
    Status Filter Parameters:
    - transaction_status (optional): Filter transactions by status. Values: Completed, Deducted (comma-separated for multiple)
    - investment_status (optional): Filter bookings by status. Values: pending, active, completed, delivered, cancelled, expired
    - bv_status (optional): Filter binary pairs by status. Values: pending, matched, processed
    - notification_status (optional): Filter notifications by status. Values: read, unread
    
    Examples:
    GET /api/reports/comprehensive/
    GET /api/reports/comprehensive/?sections=transaction_history,investment_logs
    GET /api/reports/comprehensive/?transaction_page=2&transaction_page_size=50
    GET /api/reports/comprehensive/?transaction_status=Completed&investment_status=active,pending
    GET /api/reports/comprehensive/?sections=transaction_history&transaction_page=1&transaction_status=Deducted
    
    Response (200 OK):
    {
      "transaction_history": {
        "summary_cards": {
          "total_transactions": 1250,
          "total_amount": "1,25,00,000.00",
          "success_rate": 98.5,
          "failed": 0
        },
        "transaction_type_summary": [
          {
            "type": "PAYMENT",
            "count": 850,
            "total_amount": "1,25,00,000.00",
            "avg_amount": "14,705.88",
            "success_rate": 98.5
          },
          {
            "type": "COMMISSION",
            "count": 245,
            "total_amount": "32,00,000.00",
            "avg_amount": "13,061.22",
            "success_rate": 95.2
          }
        ],
        "weekly_trend": {
          "Mon": {
            "transactions": 120,
            "amount": 1300000.00
          },
          "Tue": {
            "transactions": 135,
            "amount": 1400000.00
          }
        },
        "all_transactions": {
          "pagination": {
            "total_count": 1250,
            "total_pages": 63,
            "current_page": 1,
            "page_size": 20,
            "has_next": true,
            "has_previous": false
          },
          "results": [
            {
              "id": 1,
              "transaction_id": "TXN-2024-001",
              "date": "2024-03-22",
              "user": {
                "id": 1,
                "name": "Rajesh Kumar",
                "email": "rajesh@example.com"
              },
              "type": "PAYMENT",
              "amount": "50000.00",
              "status": "Completed",
              "description": "Vehicle pre-booking payment",
              "created_at": "2024-03-22T10:00:00Z"
            }
          ]
        }
      },
      "investment_logs": {
        "summary_cards": {
          "total_investments": 4,
          "total_amount": "2,45,000.00",
          "avg_investment": "61,250.00",
          "active_investments": 3
        },
        "investment_type_summary": [
          {
            "type": "Pre-Booking",
            "count": 1250,
            "total_amount": "6,25,00,000.00",
            "avg_amount": "50,000.00",
            "completed": 1200,
            "pending": 50
          },
          {
            "type": "Full Payment",
            "count": 850,
            "total_amount": "12,75,00,000.00",
            "avg_amount": "1,50,000.00",
            "completed": 850,
            "pending": 0
          },
          {
            "type": "EMI",
            "count": 950,
            "total_amount": "2,37,50,000.00",
            "avg_amount": "25,000.00",
            "completed": 900,
            "pending": 50
          },
          {
            "type": "Top Up",
            "count": 200,
            "total_amount": "40,00,000.00",
            "avg_amount": "20,000.00",
            "completed": 0,
            "pending": 180
          }
        ],
        "payment_method_summary": [
          {
            "payment_method": "Card",
            "count": 1200,
            "total_amount": "15,00,00,000.00",
            "percentage": 38.0
          },
          {
            "payment_method": "UPI",
            "count": 1500,
            "total_amount": "18,00,00,000.00",
            "percentage": 47.0
          }
        ],
        "detailed_bookings": {
          "pagination": {
            "total_count": 3050,
            "total_pages": 153,
            "current_page": 1,
            "page_size": 20,
            "has_next": true,
            "has_previous": false
          },
          "results": [
            {
              "id": 1,
              "booking_number": "BK-2024-001",
              "user": {
                "id": 1,
                "name": "Rajesh Kumar",
                "email": "rajesh@example.com"
              },
              "vehicle_model": "EV Model X",
              "booking_amount": "50,000.00",
              "payment_option": "full_payment",
              "status": "active",
              "total_paid": "50,000.00",
              "remaining_amount": "0.00",
              "created_at": "2024-03-22T10:00:00Z"
            }
          ]
        }
      },
      "bv_logs": {
        "summary_cards": {
          "total_bv_generated": "90,000.00",
          "total_bv_distributed": "30,000.00",
          "total_bv_used": "20,000.00",
          "active_bv": "1,20,000.00"
        },
        "bv_type_summary": [
          {
            "type": "Generated",
            "count": 1250,
            "total_amount": "6,25,00,000.00",
            "avg_amount": "50,000.00",
            "active": 1200
          },
          {
            "type": "Distributed",
            "count": 1100,
            "total_amount": "5,50,00,000.00",
            "avg_amount": "50,000.00",
            "active": 1100
          },
          {
            "type": "Used",
            "count": 850,
            "total_amount": "4,25,00,000.00",
            "avg_amount": "50,000.00",
            "active": 0
          },
          {
            "type": "Expired",
            "count": 50,
            "total_amount": "25,00,000.00",
            "avg_amount": "50,000.00",
            "active": 0
          }
        ],
        "bv_source_summary": [
          {
            "source": "Booking",
            "count": 1800,
            "total_amount": "9,00,00,000.00",
            "percentage": 72.0
          },
          {
            "source": "Commission",
            "count": 500,
            "total_amount": "2,50,00,000.00",
            "percentage": 20.0
          }
        ],
        "detailed_pairs": {
          "pagination": {
            "total_count": 1250,
            "total_pages": 63,
            "current_page": 1,
            "page_size": 20,
            "has_next": true,
            "has_previous": false
          },
          "results": [
            {
              "id": 1,
              "user": {
                "id": 1,
                "name": "Rajesh Kumar",
                "email": "rajesh@example.com"
              },
              "left_user": {
                "id": 2,
                "name": "Priya Sharma"
              },
              "right_user": {
                "id": 3,
                "name": "Amit Patel"
              },
              "pair_amount": "2,000.00",
              "earning_amount": "1,600.00",
              "status": "processed",
              "pair_number_after_activation": 5,
              "extra_deduction_applied": "0.00",
              "created_at": "2024-03-22T10:00:00Z",
              "processed_at": "2024-03-22T12:00:00Z"
            }
          ]
        }
      },
      "referral_commission": {
        "summary_cards": {
          "total_commissions": 3,
          "total_amount": "3,000.00",
          "paid_amount": "2,000.00",
          "pending_amount": "1,000.00",
          "avg_commission": "1,000.00"
        },
        "top_referrer_performance": [
          {
            "referrer": "Rajesh Kumar",
            "referrals": 25,
            "total_amount": "25,000.00",
            "tds": "2,500.00",
            "net_amount": "22,500.00",
            "paid": 20,
            "pending": 5
          },
          {
            "referrer": "Priya Sharma",
            "referrals": 20,
            "total_amount": "20,000.00",
            "tds": "2,000.00",
            "net_amount": "18,000.00",
            "paid": 18,
            "pending": 2
          }
        ],
        "commission_status_summary": [
          {
            "status": "Completed",
            "count": 850,
            "total_amount": "8,50,000.00",
            "tds": "85,000.00",
            "net_amount": "7,65,000.00"
          },
          {
            "status": "Pending",
            "count": 120,
            "total_amount": "1,20,000.00",
            "tds": "12,000.00",
            "net_amount": "1,08,000.00"
          }
        ],
        "detailed_commissions": {
          "pagination": {
            "total_count": 970,
            "total_pages": 49,
            "current_page": 1,
            "page_size": 20,
            "has_next": true,
            "has_previous": false
          },
          "results": [
            {
              "id": 1,
              "transaction_id": "REF-2024-001",
              "user": {
                "id": 1,
                "name": "Rajesh Kumar",
                "email": "rajesh@example.com"
              },
              "amount": "1,000.00",
              "referral_for": "Referred user booking",
              "created_at": "2024-03-22T10:00:00Z"
            }
          ]
        }
      },
      "team_commission": {
        "summary_cards": {
          "total_commissions": 3,
          "total_pairs": 17,
          "total_amount": "34,000.00",
          "pool_money": "6,800.00",
          "net_payout": "23,800.00",
          "avg_per_pair": "2,000.00"
        },
        "top_distributor_performance": [
          {
            "distributor": "Rajesh Kumar",
            "pairs": 25,
            "total_amount": "50,000.00",
            "tds": "5,000.00",
            "pool_money": "10,000.00",
            "net_amount": "35,000.00",
            "paid": 20,
            "pending": 5
          },
          {
            "distributor": "Priya Sharma",
            "pairs": 20,
            "total_amount": "40,000.00",
            "tds": "4,000.00",
            "pool_money": "8,000.00",
            "net_amount": "28,000.00",
            "paid": 18,
            "pending": 2
          }
        ],
        "commission_breakdown_by_status": [
          {
            "status": "Completed",
            "count": 850,
            "total_amount": "1,70,00,000.00",
            "tds": "17,00,000.00",
            "pool_money": "34,00,000.00",
            "net_amount": "1,19,00,000.00"
          }
        ],
        "detailed_earnings": {
          "pagination": {
            "total_count": 850,
            "total_pages": 43,
            "current_page": 1,
            "page_size": 20,
            "has_next": true,
            "has_previous": false
          },
          "results": [
            {
              "id": 1,
              "user": {
                "id": 1,
                "name": "Rajesh Kumar",
                "email": "rajesh@example.com"
              },
              "binary_pair_id": 5,
              "amount": "2,000.00",
              "pair_number": 5,
              "emi_deducted": "200.00",
              "net_amount": "1,800.00",
              "created_at": "2024-03-22T10:00:00Z"
            }
          ]
        }
      },
      "login_history": {
        "summary_cards": {
          "total_logins": 0,
          "unique_users": 0,
          "failed_logins": 0,
          "active_sessions": 0,
          "avg_logins_per_user": 0.0
        },
        "device_summary": [],
        "login_status_summary": [],
        "login_location_summary": []
      },
      "notification_history": {
        "summary_cards": {
          "total_sent": 1750,
          "delivered": 1710,
          "opened": 1270,
          "clicked": 0,
          "failed": 40,
          "delivery_rate": 97.7,
          "open_rate": 75.0,
          "click_rate": 0.0
        },
        "delivery_status_summary": [
          {
            "status": "Delivered",
            "count": 4850,
            "percentage": 97.0
          },
          {
            "status": "Opened",
            "count": 3200,
            "percentage": 64.0
          },
          {
            "status": "Clicked",
            "count": 1500,
            "percentage": 30.0
          },
          {
            "status": "Failed",
            "count": 150,
            "percentage": 3.0
          }
        ],
        "notification_type_performance": [
          {
            "type": "Email",
            "sent": 2500,
            "delivered": 2425,
            "opened": 1600,
            "delivery_rate": 97.0,
            "open_rate": 66.0
          },
          {
            "type": "SMS",
            "sent": 1800,
            "delivered": 1764,
            "opened": 1440,
            "delivery_rate": 98.0,
            "open_rate": 81.6
          },
          {
            "type": "Push",
            "sent": 3200,
            "delivered": 3136,
            "opened": 2464,
            "delivery_rate": 98.0,
            "open_rate": 78.6
          },
          {
            "type": "In-App",
            "sent": 1500,
            "delivered": 1500,
            "opened": 1200,
            "delivery_rate": 100.0,
            "open_rate": 80.0
          }
        ],
        "weekly_notification_volume": {
          "Mon": 1200,
          "Tue": 1350,
          "Wed": 1400,
          "Thu": 1600,
          "Fri": 1500,
          "Sat": 900,
          "Sun": 800
        },
        "detailed_notifications": {
          "pagination": {
            "total_count": 1750,
            "total_pages": 88,
            "current_page": 1,
            "page_size": 20,
            "has_next": true,
            "has_previous": false
          },
          "results": [
            {
              "id": 1,
              "notification_type": "booking",
              "title": "Booking Confirmed",
              "message": "Your vehicle booking has been confirmed",
              "is_read": true,
              "read_at": "2024-03-22T12:00:00Z",
              "user": {
                "id": 1,
                "name": "Rajesh Kumar",
                "email": "rajesh@example.com"
              },
              "created_at": "2024-03-22T10:00:00Z"
            }
          ]
        }
      }
    }
    
    Error Response (403 Forbidden):
    {
      "detail": "This endpoint is only available for admin and staff users."
    }
    
    Notes:
    - Only users with is_superuser=True or role in ['admin', 'staff'] can access this endpoint
    - Returns all sections by default if no 'sections' query parameter is provided
    - Sections can be filtered using comma-separated list: ?sections=transaction_history,investment_logs
    - Available sections: transaction_history, investment_logs, bv_logs, referral_commission, team_commission, login_history, notification_history
    
    Pagination:
    - Each section supports independent pagination with {section}_page and {section}_page_size parameters
    - Default page size: 20, Maximum page size: 100
    - Pagination metadata includes: total_count, total_pages, current_page, page_size, has_next, has_previous
    - Detailed lists are returned with pagination structure: { "pagination": {...}, "results": [...] }
    
    Status Filtering:
    - transaction_status: Filters wallet transactions by Completed (credit/positive) or Deducted (debit/negative)
    - investment_status: Filters bookings by pending, active, completed, delivered, cancelled, or expired
    - bv_status: Filters binary pairs by pending, matched, or processed
    - notification_status: Filters notifications by read or unread
    - Multiple values can be comma-separated: ?investment_status=active,pending
    - Filters apply only to detailed lists, not to summary cards or aggregations
    
    Transaction History:
    - Includes all wallet transactions
    - Success rate calculated from Payment model (completed vs failed payments)
    - Weekly trend shows last 7 days of data
    - Detailed list includes: transaction_id, date, user, type, amount, status, description, created_at
    - Supports pagination and status filtering (Completed/Deducted)
    
    Investment Logs:
    - Based on booking records
    - Investment types: Pre-Booking, Full Payment, EMI, Top Up
    - Payment method summary based on completed payments
    - Detailed bookings list includes: booking_number, user, vehicle_model, booking_amount, payment_option, status, total_paid, remaining_amount, created_at
    - Supports pagination and status filtering (booking status)
    
    BV Logs:
    - Business Volume calculated from binary pairs and earnings
    - BV types: Generated, Distributed, Used, Expired
    - BV sources: Booking (from payments), Commission (from binary earnings)
    - Detailed pairs list includes: user, left_user, right_user, pair_amount, earning_amount, status, pair_number_after_activation, extra_deduction_applied, created_at, processed_at
    - Supports pagination and status filtering (pair status)
    
    Referral Commission:
    - Based on REFERRAL_BONUS wallet transactions
    - TDS calculated at 20% (configurable)
    - Top referrers sorted by total amount
    - Detailed commissions list includes: transaction_id, user, amount, referral_for (description), created_at
    - Supports pagination
    
    Team Commission:
    - Based on BinaryEarning and BinaryPair records
    - Pool money includes TDS and extra deductions
    - Top distributors sorted by total amount
    - Detailed earnings list includes: user, binary_pair_id, amount, pair_number, emi_deducted, net_amount, created_at
    - Supports pagination
    
    Login History:
    - Currently returns placeholder data (no login tracking model exists)
    
    Notification History:
    - Based on Notification model
    - Delivery rate = delivered / sent
    - Open rate = opened / sent (assumes is_read = opened)
    - Click tracking requires additional implementation
    - Detailed notifications list includes: notification_type, title, message, is_read, read_at, user, created_at
    - Supports pagination and status filtering (read/unread)
    
    - All monetary values are returned as formatted strings with 2 decimal places
    - Percentages are rounded to 1 decimal place
    - Dates are in ISO 8601 format (UTC)


================================================================================
                            GALLERY APIs
================================================================================

87. LIST GALLERY ITEMS
    Method: GET
    URL: /api/gallery/gallery-items/
    Authentication: Not Required
    Description: List all active gallery items (company members). Public endpoint - no authentication needed.
    
    Query Parameters:
    - level: Filter by member level (optional, any text value)
      Example: ?level=executive
      Example: ?level=senior manager
    - status: Filter by status (optional, Admin/Staff only)
      Values: "true", "false", "1", "0", "yes", "no"
      Example: ?status=true
    
    Response (200 OK):
    [
      {
        "id": 1,
        "title": "John Doe",
        "image": "/media/gallery/images/photo.jpg",
        "image_url": "http://localhost:8000/media/gallery/images/photo.jpg",
        "caption": "CEO and Founder",
        "level": "executive",
        "order": 1,
        "status": true,
        "created_by": 1,
        "created_by_username": "admin",
        "created_at": "2026-01-01T00:00:00Z",
        "updated_at": "2026-01-01T00:00:00Z"
      },
      {
        "id": 2,
        "title": "Jane Smith",
        "image": "/media/gallery/images/photo2.jpg",
        "image_url": "http://localhost:8000/media/gallery/images/photo2.jpg",
        "caption": "Chief Technology Officer",
        "level": "executive",
        "level_display": "Executive",
        "order": 2,
        "status": true,
        "created_by": 1,
        "created_by_username": "admin",
        "created_at": "2026-01-01T00:00:00Z",
        "updated_at": "2026-01-01T00:00:00Z"
      }
    ]
    
    Notes:
    - Public users only see items with status=true (active items)
    - Admin/Staff users can see all items (active and inactive)
    - Results are ordered by level, then order, then created_at
    - image_url provides full absolute URL for the image
    - level field accepts any text value (e.g., "executive", "manager", "senior manager", "director", etc.)


88. GET GALLERY ITEM BY ID
    Method: GET
    URL: /api/gallery/gallery-items/{id}/
    Authentication: Not Required
    Description: Retrieve a specific gallery item by ID. Public endpoint - no authentication needed.
    
    Response (200 OK):
    {
      "id": 1,
      "title": "John Doe",
      "image": "/media/gallery/images/photo.jpg",
      "image_url": "http://localhost:8000/media/gallery/images/photo.jpg",
      "caption": "CEO and Founder",
      "level": "executive",
      "level_display": "Executive",
      "order": 1,
      "status": true,
      "created_by": 1,
      "created_by_username": "admin",
      "created_at": "2026-01-01T00:00:00Z",
      "updated_at": "2026-01-01T00:00:00Z"
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }
    
    Notes:
    - Public users can only retrieve active items (status=true)
    - Admin/Staff users can retrieve any item (active or inactive)


89. CREATE GALLERY ITEM
    Method: POST
    URL: /api/gallery/gallery-items/
    Authentication: Required (Admin/Staff only)
    Description: Create a new gallery item (company member). Only Admin/Staff can create items.
    
    Content-Type: multipart/form-data
    
    Request Body (form-data):
    - title: "John Doe" (required, max 200 characters)
    - image: @photo.jpg (required, image file: JPEG, PNG, GIF, WEBP)
    - caption: "CEO and Founder" (optional, text description)
    - level: "executive" (required, any text value, max 100 characters)
    - order: 1 (optional, integer, default: 0, lower numbers appear first)
    - status: true (optional, boolean, default: true)
    
    Response (201 Created):
    {
      "id": 1,
      "title": "John Doe",
      "image": "/media/gallery/images/photo.jpg",
      "image_url": "http://localhost:8000/media/gallery/images/photo.jpg",
      "caption": "CEO and Founder",
      "level": "executive",
      "level_display": "Executive",
      "order": 1,
      "status": true,
      "created_by": 1,
      "created_by_username": "admin",
      "created_at": "2026-01-01T00:00:00Z",
      "updated_at": "2026-01-01T00:00:00Z"
    }
    
    Error Response (400):
    {
      "title": ["This field is required."],
      "image": ["This field is required."],
      "level": ["This field is required."]
    }
    OR
    {
      "image": ["Image must be a JPEG, PNG, GIF, or WEBP file."]
    }
    
    Error Response (403):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Notes:
    - Only Admin/Staff/Superuser can create gallery items
    - created_by is automatically set to the authenticated user
    - Image files must be valid image formats (JPEG, PNG, GIF, WEBP)
    - Maximum file size: 20MB (Django default)
    - Level field accepts any text value (e.g., "executive", "manager", "senior manager", "director", "team lead", etc.)
    - Maximum length for level: 100 characters
    - Order field determines display order within the same level (lower numbers appear first)


90. UPDATE GALLERY ITEM
    Method: PUT
    URL: /api/gallery/gallery-items/{id}/
    Authentication: Required (Admin/Staff only)
    Description: Update a gallery item. Full update - all fields must be provided. Only Admin/Staff can update items.
    
    Content-Type: multipart/form-data
    
    Request Body (form-data):
    - title: "John Doe" (required)
    - image: @photo.jpg (required, can be same or new image)
    - caption: "CEO and Founder" (optional)
    - level: "executive" (required)
    - order: 1 (optional)
    - status: true (optional)
    
    Response (200 OK):
    {
      "id": 1,
      "title": "John Doe",
      "image": "/media/gallery/images/photo_updated.jpg",
      "image_url": "http://localhost:8000/media/gallery/images/photo_updated.jpg",
      "caption": "CEO and Founder - Updated",
      "level": "executive",
      "level_display": "Executive",
      "order": 2,
      "status": true,
      "created_by": 1,
      "created_by_username": "admin",
      "created_at": "2026-01-01T00:00:00Z",
      "updated_at": "2026-01-01T12:00:00Z"
    }
    
    Error Response (403):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }
    
    Notes:
    - PUT requires all fields to be provided
    - Use PATCH for partial updates
    - Only Admin/Staff/Superuser can update gallery items


91. PARTIAL UPDATE GALLERY ITEM
    Method: PATCH
    URL: /api/gallery/gallery-items/{id}/
    Authentication: Required (Admin/Staff only)
    Description: Partially update a gallery item. Only provided fields will be updated. Only Admin/Staff can update items.
    
    Content-Type: multipart/form-data
    
    Request Body (form-data, all fields optional):
    - title: "John Doe" (optional)
    - image: @photo.jpg (optional)
    - caption: "CEO and Founder" (optional)
    - level: "executive" (optional)
    - order: 1 (optional)
    - status: true (optional)
    
    Response (200 OK):
    {
      "id": 1,
      "title": "John Doe",
      "image": "/media/gallery/images/photo.jpg",
      "image_url": "http://localhost:8000/media/gallery/images/photo.jpg",
      "caption": "CEO and Founder - Updated",
      "level": "executive",
      "level_display": "Executive",
      "order": 1,
      "status": true,
      "created_by": 1,
      "created_by_username": "admin",
      "created_at": "2026-01-01T00:00:00Z",
      "updated_at": "2026-01-01T12:00:00Z"
    }
    
    Error Response (403):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }
    
    Notes:
    - PATCH allows partial updates - only provide fields you want to change
    - Only Admin/Staff/Superuser can update gallery items
    - Image can be updated without changing other fields


92. DELETE GALLERY ITEM
    Method: DELETE
    URL: /api/gallery/gallery-items/{id}/
    Authentication: Required (Admin/Staff only)
    Description: Delete a gallery item. Only Admin/Staff can delete items.
    
    Response (204 No Content):
    (Empty response body)
    
    Error Response (403):
    {
      "detail": "You do not have permission to perform this action."
    }
    
    Error Response (404):
    {
      "detail": "Not found."
    }
    
    Notes:
    - Only Admin/Staff/Superuser can delete gallery items
    - Deletion is permanent - item cannot be recovered
    - Associated image file will be deleted from storage


================================================================================
                         AUTHENTICATION HEADERS
================================================================================

All authenticated endpoints require JWT Bearer token in Authorization header:

Authorization: Bearer <access_token>

Example:
curl -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..." \
     http://localhost:8000/api/users/profile/


================================================================================
                         ERROR RESPONSES
================================================================================

Standard Error Format:

400 Bad Request:
{
  "field_name": ["Error message"],
  "non_field_errors": ["General error message"]
}

401 Unauthorized:
{
  "detail": "Authentication credentials were not provided."
}

403 Forbidden:
{
  "detail": "You do not have permission to perform this action."
}

404 Not Found:
{
  "detail": "Not found."
}

429 Too Many Requests:
{
  "detail": "Request was throttled. Expected available in X seconds."
}

500 Internal Server Error:
{
  "detail": "A server error occurred."
}


================================================================================
                         RATE LIMITING
================================================================================

- OTP Endpoints (/api/auth/send-otp/, /api/auth/verify-otp/, /api/auth/send-admin-otp/, /api/auth/verify-admin-otp/, /api/auth/send-universal-otp/, /api/auth/verify-universal-otp/): 
  5 requests per minute per IP

- Booking Endpoints (/api/booking/): 
  10 requests per minute per IP

- All Other APIs: 
  100 requests per minute per IP


================================================================================
                         BUSINESS RULES
================================================================================

1. Pre-booking Minimum: ₹500
2. Active Buyer Threshold: ₹5000 total paid
3. Direct User Commission: ₹1000 per direct user added (configurable via settings)
   - Paid only for first 3 direct children (configurable threshold, default: 3)
   - Stops after binary commission activation
   - 20% TDS is deducted from direct user commission (configurable percentage)
   - Net amount (₹800 = ₹1000 - ₹200 TDS) is credited to wallet
   - TDS is deducted from referrer's oldest active booking remaining amount
   - Only distributors can receive commissions
4. Binary Commission Activation: Activates automatically when user has 3 direct children (configurable threshold)
   - Tree counting: All direct and indirect referrals (entire subtree) are counted for commission calculation
   - Initial Bonus: When binary commission is activated, user automatically receives initial bonus (configurable via binary_commission_initial_bonus setting)
     * Bonus amount is credited to wallet and total_earnings after deducting TDS
     * TDS is calculated from bonus amount using binary_commission_tds_percentage
     * TDS is NOT deducted from booking balance (unlike other commissions)
     * Only net amount (bonus - TDS) is credited to wallet
     * Bonus is paid only once per user (duplicate prevention via transaction history check)
5. Binary Pair Commission: ₹2000 per pair after activation (configurable via settings)
   - Only pairs created after activation count towards commission
   - Pair Matching Eligibility: Only members created at or after activation are eligible for pairing
     * Pre-activation members (1st and 2nd members) are EXCLUDED from pairing
     * Member that triggered activation (3rd member) is INCLUDED in pairing
     * All members added after activation are INCLUDED in pairing
     * Example: User A has B (1st), C (2nd), D (3rd - triggers activation), E (4th):
       - B and C are excluded from pairing
       - D and E can be paired (not B and C)
   - Maximum 10 pairs per DAY per user (configurable daily limit, default: 10 pairs = ₹20,000)
   - Daily limit resets at midnight (00:00 server time)
   - 20% TDS is applied on ALL pair commissions (1st pair onwards, configurable percentage)
   - Pairs 1-5: ₹2000 - 20% TDS = ₹1600 credited
   - Pairs 6+: ₹2000 - 20% TDS - 20% extra = ₹1200 credited (extra deducted from booking balance)
6. Binary Commission TDS and Deductions:
   - TDS percentage: 20% on ALL binary commissions (configurable, range: 0-100%)
   - Extra deduction threshold: 5 pairs after activation (configurable)
   - Extra deduction percentage: 20% for 6th+ pairs (configurable, range: 0-100%)
   - TDS and extra deduction are deducted from user's oldest active booking remaining amount
   - If no active booking exists, deductions are still recorded but not deducted from any booking
7. Daily Pair Limit and Carry-Forward:
   - After 10 pairs in a day: Compare remaining unmatched members on each side
   - SHORT leg (fewer remaining members) is IGNORED for commission that day
   - LONG leg (more remaining members) has ALL remaining members CARRIED FORWARD to next day
   - Next day: New members on ignored side match with carried-forward members from long leg
   - Daily limit reset: Resets at midnight (00:00 server time)
7. Payout TDS: Configurable via payout_tds_percentage in Platform Settings (default: 0, meaning no payout TDS). If non-zero, TDS is calculated as requested_amount × (payout_tds_percentage / 100) with maximum ₹10,000 ceiling. This is separate from binary commission TDS (binary_commission_tds_percentage)
8. EMI Auto-fill: Optional feature in payout requests
9. Payment Status: Payments default to 'pending' and require admin/staff approval or payment gateway confirmation
10. Stock Reservation: Bookings automatically reserve vehicle stock; released if payment not confirmed within timeout
11. Reservation Timeout: Configurable via Platform Settings API (stored in minutes, null = never expires)
12. Distributor Requirement: Only approved distributors can earn from binary pairs, direct user commissions, and referral bonuses
13. Distributor Eligibility: User must have approved KYC to apply for distributor program (Active Buyer requirement removed)
14. Distributor Application: Each user can submit only one distributor application. Approval behavior is controlled by distributor_application_auto_approve setting in Platform Settings. If true (default): application is automatically approved upon creation and user becomes distributor immediately. If false: application remains pending and requires admin/staff approval via update-status endpoint. Admin/staff can reject applications regardless of setting.
15. Binary Tree Placement: Users are NOT automatically placed in binary tree during booking creation. Placement APIs can ONLY be called AFTER user has successful payment. Referrers must place users AFTER payment via /api/binary/nodes/auto_place_pending/ (automatic) or /api/binary/nodes/place_user/ (manual). Commission is paid when placement happens (regardless of when payment was completed). Auto-placement uses left-priority algorithm: 1st user → LEFT, 2nd user → RIGHT, 3rd+ → follow LEFT chain. Referral-based override: If using specific parent's code, place in that parent's tree. Default placement side is configurable via Platform Settings (binary_tree_default_placement_side). Parents can choose side for direct referrals and swap/move direct children via API endpoints.
16. Manual Tree Placement: Tree owners can manually place/move users in their tree via placement APIs; only users who used referrer's code can be placed
17. Commission Configuration: All binary commission amounts, thresholds, TDS settings, and daily limits are configurable via Platform Settings API
18. Referral Commission Timing: Commission is only granted for bookings created AFTER the referrer becomes a distributor (no retroactive commissions)
    - System stores referrer_was_distributor flag at booking creation time
    - Commission is granted only if referrer_was_distributor is True when payment is completed
19. Tree Counting: left_count and right_count now count ALL descendants recursively (entire subtree, not just direct children)
20. Distributor Eligibility: Active Buyer requirement removed - only KYC verification needed to apply for distributor program
21. Commission Restriction for Non-Active Buyer Distributors (configurable via max_earnings_before_active_buyer in Platform Settings, default: 5):
    - Can earn unlimited direct user commissions (₹1000 per direct user, before binary activation)
    - Can earn commission for first N binary pairs after binary activation (where N = max_earnings_before_active_buyer, default: 5 pairs, ₹2000 per pair)
    - Binary pair commissions from (N+1)th pair onwards are BLOCKED until they become Active Buyer
    - When distributor becomes Active Buyer (total paid ≥ ₹5000), future binary pairs will be paid normally
    - No retroactive commissions for pairs that were blocked during restriction period
    - The limit is configurable via Platform Settings API endpoint (max_earnings_before_active_buyer field, min: 1)


================================================================================
                         PERMISSION HIERARCHY
================================================================================

Profile Editing Permissions:

Admin/Superuser:
  - Can edit: Admin profiles ✓
  - Can edit: Staff profiles ✓
  - Can edit: Normal user profiles ✓
  - Can view: All users ✓

Staff:
  - Can edit: Own profile ✓
  - Can edit: Normal user profiles ✓
  - Cannot edit: Admin profiles ✗
  - Cannot edit: Other staff profiles ✗
  - Can view: All users ✓

Normal User:
  - Can edit: Own profile only ✓
  - Cannot edit: Any other profiles ✗
  - Can view: Own profile only ✓

User Listing Permissions:
  - Admin/Superuser: Can list all users
  - Staff: Can list all users (to manage normal users)
  - Normal Users: Can only see their own profile in listings

Error Messages:
  - Staff attempting to edit admin/staff: "Staff can only edit their own profile or normal users' profiles."
  - Normal user attempting to edit others: "You can only update your own profile."


================================================================================
                         STATUS CODES
================================================================================

200 OK: Successful GET, PUT, PATCH requests
201 Created: Successful POST requests (resource created)
204 No Content: Successful DELETE requests
400 Bad Request: Invalid request data
401 Unauthorized: Missing or invalid authentication
403 Forbidden: Insufficient permissions
404 Not Found: Resource not found
429 Too Many Requests: Rate limit exceeded
500 Internal Server Error: Server error


================================================================================
                         PAGINATION
================================================================================

All list endpoints support pagination:

Query Parameters:
- page: Page number (default: 1)
- page_size: Items per page (default: 20, max: 100)

Response Format:
{
  "count": 100,           // Total number of items
  "next": "http://...",   // URL for next page (null if last page)
  "previous": "http://...", // URL for previous page (null if first page)
  "results": [...]        // Array of items for current page
}


================================================================================
                         DATE/TIME FORMAT
================================================================================

All dates and times are in ISO 8601 format:
- Date: YYYY-MM-DD (e.g., "2026-01-06")
- DateTime: YYYY-MM-DDTHH:MM:SSZ (e.g., "2026-01-06T12:00:00Z")
- Timezone: UTC (converted from server timezone)


================================================================================
                         FILE UPLOADS
================================================================================

File upload endpoints accept multipart/form-data:
- Maximum file size: 20MB
- Supported formats: Images (JPG, PNG), PDFs
- Files are stored in /media/ directory


================================================================================
                         NOTES
================================================================================

1. All monetary values are in Indian Rupees (₹) and returned as strings with 2 decimal places
2. JWT access tokens expire in 60 minutes (configurable)
3. JWT refresh tokens expire in 24 hours (configurable)
4. OTP expires in 10 minutes
5. Admin endpoints require is_superuser=True or role='admin'
6. Profile editing follows hierarchical permissions: Admin > Staff > Normal User (see PERMISSION HIERARCHY section)
7. All timestamps are in UTC
8. Database uses SQLite in development, MySQL in production (switch via DB_ENGINE in .env)


================================================================================
                         END OF DOCUMENTATION
================================================================================

Last Updated: 2026-02-02
Version: 1.1.0

